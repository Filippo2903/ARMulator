<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 15.0.3"/>
    <title>simulator API documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;z-index:999;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;opacity:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent; z-index:1}nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{cursor:pointer;display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:.75rem center;margin-bottom:1rem;}.pdoc .alert > em{display:none;}.pdoc .alert > *:last-child{margin-bottom:0;}.pdoc .alert.note{color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .alert.tip{color:#0a3622;background-color:#d1e7dd;border-color:#a3cfbb;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%230a3622%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M2%206a6%206%200%201%201%2010.174%204.31c-.203.196-.359.4-.453.619l-.762%201.769A.5.5%200%200%201%2010.5%2013a.5.5%200%200%201%200%201%20.5.5%200%200%201%200%201l-.224.447a1%201%200%200%201-.894.553H6.618a1%201%200%200%201-.894-.553L5.5%2015a.5.5%200%200%201%200-1%20.5.5%200%200%201%200-1%20.5.5%200%200%201-.46-.302l-.761-1.77a2%202%200%200%200-.453-.618A5.98%205.98%200%200%201%202%206m6-5a5%205%200%200%200-3.479%208.592c.263.254.514.564.676.941L5.83%2012h4.342l.632-1.467c.162-.377.413-.687.676-.941A5%205%200%200%200%208%201%22/%3E%3C/svg%3E");}.pdoc .alert.important{color:#055160;background-color:#cff4fc;border-color:#9eeaf9;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23055160%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M2%200a2%202%200%200%200-2%202v12a2%202%200%200%200%202%202h12a2%202%200%200%200%202-2V2a2%202%200%200%200-2-2zm6%204c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%204.995A.905.905%200%200%201%208%204m.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2%22/%3E%3C/svg%3E");}.pdoc .alert.warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .alert.caution{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M11.46.146A.5.5%200%200%200%2011.107%200H4.893a.5.5%200%200%200-.353.146L.146%204.54A.5.5%200%200%200%200%204.893v6.214a.5.5%200%200%200%20.146.353l4.394%204.394a.5.5%200%200%200%20.353.146h6.214a.5.5%200%200%200%20.353-.146l4.394-4.394a.5.5%200%200%200%20.146-.353V4.893a.5.5%200%200%200-.146-.353zM8%204c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%204.995A.905.905%200%200%201%208%204m.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2%22/%3E%3C/svg%3E");}.pdoc .alert.danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc > section:not(.module-info) h1{font-size:1.5rem;font-weight:500;}.pdoc > section:not(.module-info) h2{font-size:1.4rem;font-weight:500;}.pdoc > section:not(.module-info) h3{font-size:1.3rem;font-weight:500;}.pdoc > section:not(.module-info) h4{font-size:1.2rem;}.pdoc > section:not(.module-info) h5{font-size:1.1rem;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--accent);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(.module-info){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.view-source-toggle-state,.view-source-toggle-state ~ .pdoc-code{display:none;}.view-source-toggle-state:checked ~ .pdoc-code{display:block;}.view-source-button{display:inline-block;float:right;font-size:.75rem;line-height:1.5rem;color:var(--muted);padding:0 .4rem 0 1.3rem;cursor:pointer;text-indent:-2px;}.view-source-button > span{visibility:hidden;}.module-info .view-source-button{float:none;display:flex;justify-content:flex-end;margin:-1.2rem .4rem -.2rem 0;}.view-source-button::before{position:absolute;content:"View Source";display:list-item;list-style-type:disclosure-closed;}.view-source-toggle-state:checked ~ .attr .view-source-button::before,.view-source-toggle-state:checked ~ .view-source-button::before{list-style-type:disclosure-open;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc section:not(.module-info) .docstring{margin-left:clamp(0rem, 5vw - 2rem, 1rem);}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target,.pdoc .pdoc-code > pre > span:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc .pdoc-code > pre > span:target{display:block;}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc *{scroll-margin:2rem;}.pdoc .pdoc-code .linenos{user-select:none;}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc section, .pdoc .classattr{position:relative;}.pdoc .headerlink{--width:clamp(1rem, 3vw, 2rem);position:absolute;top:0;left:calc(0rem - var(--width));transition:all 100ms ease-in-out;opacity:0;}.pdoc .headerlink::before{content:"#";display:block;text-align:center;width:var(--width);height:2.3rem;line-height:2.3rem;font-size:1.5rem;}.pdoc .attr:hover ~ .headerlink,.pdoc *:target > .headerlink,.pdoc .headerlink:hover{opacity:1;}.pdoc .attr{display:block;margin:.5rem 0 .5rem;padding:.4rem .4rem .4rem 1rem;background-color:var(--accent);overflow-x:auto;}.pdoc .classattr{margin-left:2rem;}.pdoc .decorator-deprecated{color:#842029;}.pdoc .decorator-deprecated ~ span{filter:grayscale(1) opacity(0.8);}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{background-color:transparent;}.pdoc .param, .pdoc .return-annotation{white-space:pre;}.pdoc .signature.multiline .param{display:block;}.pdoc .signature.condensed .param{display:inline-block;}.pdoc .annotation{color:var(--annotation);}.pdoc .view-value-toggle-state,.pdoc .view-value-toggle-state ~ .default_value{display:none;}.pdoc .view-value-toggle-state:checked ~ .default_value{display:inherit;}.pdoc .view-value-button{font-size:.5rem;vertical-align:middle;border-style:dashed;margin-top:-0.1rem;}.pdoc .view-value-button:hover{background:white;}.pdoc .view-value-button::before{content:"show";text-align:center;width:2.2em;display:inline-block;}.pdoc .view-value-toggle-state:checked ~ .view-value-button::before{content:"hide";}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>            <a class="pdoc-button module-list-button" href="index.html">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-in-left" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M10 3.5a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 1 1 0v2A1.5 1.5 0 0 1 9.5 14h-8A1.5 1.5 0 0 1 0 12.5v-9A1.5 1.5 0 0 1 1.5 2h8A1.5 1.5 0 0 1 11 3.5v2a.5.5 0 0 1-1 0v-2z"/>
  <path fill-rule="evenodd" d="M4.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H14.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
</svg>                &nbsp;
                Module Index
            </a>


            <input type="search" placeholder="Search..." role="searchbox" aria-label="search"
                   pattern=".+" required>



            <h2>API Documentation</h2>
                <ul class="memberlist">
            <li>
                    <a class="variable" href="#appState">appState</a>
            </li>
            <li>
                    <a class="class" href="#MultipleErrors">MultipleErrors</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#MultipleErrors.__init__">MultipleErrors</a>
                        </li>
                        <li>
                                <a class="variable" href="#MultipleErrors.idx">idx</a>
                        </li>
                        <li>
                                <a class="function" href="#MultipleErrors.append">append</a>
                        </li>
                        <li>
                                <a class="function" href="#MultipleErrors.clear">clear</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#Simulator">Simulator</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#Simulator.__init__">Simulator</a>
                        </li>
                        <li>
                                <a class="variable" href="#Simulator.PC">PC</a>
                        </li>
                        <li>
                                <a class="variable" href="#Simulator.pcoffset">pcoffset</a>
                        </li>
                        <li>
                                <a class="variable" href="#Simulator.PCSpecialBehavior">PCSpecialBehavior</a>
                        </li>
                        <li>
                                <a class="variable" href="#Simulator.allowSwitchModeInUserMode">allowSwitchModeInUserMode</a>
                        </li>
                        <li>
                                <a class="variable" href="#Simulator.maxit">maxit</a>
                        </li>
                        <li>
                                <a class="variable" href="#Simulator.bkptLastFetch">bkptLastFetch</a>
                        </li>
                        <li>
                                <a class="variable" href="#Simulator.deactivatedBkpts">deactivatedBkpts</a>
                        </li>
                        <li>
                                <a class="variable" href="#Simulator.history">history</a>
                        </li>
                        <li>
                                <a class="variable" href="#Simulator.mem">mem</a>
                        </li>
                        <li>
                                <a class="variable" href="#Simulator.regs">regs</a>
                        </li>
                        <li>
                                <a class="variable" href="#Simulator.pcInitVal">pcInitVal</a>
                        </li>
                        <li>
                                <a class="variable" href="#Simulator.decoders">decoders</a>
                        </li>
                        <li>
                                <a class="variable" href="#Simulator.decoderCache">decoderCache</a>
                        </li>
                        <li>
                                <a class="variable" href="#Simulator.assertionCkpts">assertionCkpts</a>
                        </li>
                        <li>
                                <a class="variable" href="#Simulator.assertionData">assertionData</a>
                        </li>
                        <li>
                                <a class="variable" href="#Simulator.assertionWhenReturn">assertionWhenReturn</a>
                        </li>
                        <li>
                                <a class="variable" href="#Simulator.callStack">callStack</a>
                        </li>
                        <li>
                                <a class="variable" href="#Simulator.addr2line">addr2line</a>
                        </li>
                        <li>
                                <a class="variable" href="#Simulator.errorsPending">errorsPending</a>
                        </li>
                        <li>
                                <a class="variable" href="#Simulator.interruptActive">interruptActive</a>
                        </li>
                        <li>
                                <a class="variable" href="#Simulator.interruptParams">interruptParams</a>
                        </li>
                        <li>
                                <a class="variable" href="#Simulator.lastInterruptCycle">lastInterruptCycle</a>
                        </li>
                        <li>
                                <a class="variable" href="#Simulator.stepMode">stepMode</a>
                        </li>
                        <li>
                                <a class="variable" href="#Simulator.stepCondition">stepCondition</a>
                        </li>
                        <li>
                                <a class="variable" href="#Simulator.runIteration">runIteration</a>
                        </li>
                        <li>
                                <a class="function" href="#Simulator.reset">reset</a>
                        </li>
                        <li>
                                <a class="function" href="#Simulator.getContext">getContext</a>
                        </li>
                        <li>
                                <a class="function" href="#Simulator.setStepCondition">setStepCondition</a>
                        </li>
                        <li>
                                <a class="function" href="#Simulator.isStepDone">isStepDone</a>
                        </li>
                        <li>
                                <a class="function" href="#Simulator.loop">loop</a>
                        </li>
                        <li>
                                <a class="function" href="#Simulator.stepBack">stepBack</a>
                        </li>
                        <li>
                                <a class="function" href="#Simulator.executionStats">executionStats</a>
                        </li>
                        <li>
                                <a class="function" href="#Simulator.fetchAndDecode">fetchAndDecode</a>
                        </li>
                        <li>
                                <a class="function" href="#Simulator.bytecodeToInstr">bytecodeToInstr</a>
                        </li>
                        <li>
                                <a class="function" href="#Simulator.explainInstruction">explainInstruction</a>
                        </li>
                        <li>
                                <a class="function" href="#Simulator.execAssert">execAssert</a>
                        </li>
                        <li>
                                <a class="function" href="#Simulator.nextInstr">nextInstr</a>
                        </li>
                        <li>
                                <a class="function" href="#Simulator.deactivateAllBreakpoints">deactivateAllBreakpoints</a>
                        </li>
                        <li>
                                <a class="function" href="#Simulator.reactivateAllBreakpoints">reactivateAllBreakpoints</a>
                        </li>
                        <li>
                                <a class="function" href="#Simulator.getCurrentLine">getCurrentLine</a>
                        </li>
                </ul>

            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev" target="_blank">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22150%22%20viewBox%3D%22-1%200%2060%2030%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M29.621%2021.293c-.011-.273-.214-.475-.511-.481a.5.5%200%200%200-.489.503l-.044%201.393c-.097.551-.695%201.215-1.566%201.704-.577.428-1.306.486-2.193.182-1.426-.617-2.467-1.654-3.304-2.487l-.173-.172a3.43%203.43%200%200%200-.365-.306.49.49%200%200%200-.286-.196c-1.718-1.06-4.931-1.47-7.353.191l-.219.15c-1.707%201.187-3.413%202.131-4.328%201.03-.02-.027-.49-.685-.141-1.763.233-.721.546-2.408.772-4.076.042-.09.067-.187.046-.288.166-1.347.277-2.625.241-3.351%201.378-1.008%202.271-2.586%202.271-4.362%200-.976-.272-1.935-.788-2.774-.057-.094-.122-.18-.184-.268.033-.167.052-.339.052-.516%200-1.477-1.202-2.679-2.679-2.679-.791%200-1.496.352-1.987.9a6.3%206.3%200%200%200-1.001.029c-.492-.564-1.207-.929-2.012-.929-1.477%200-2.679%201.202-2.679%202.679A2.65%202.65%200%200%200%20.97%206.554c-.383.747-.595%201.572-.595%202.41%200%202.311%201.507%204.29%203.635%205.107-.037.699-.147%202.27-.423%203.294l-.137.461c-.622%202.042-2.515%208.257%201.727%2010.643%201.614.908%203.06%201.248%204.317%201.248%202.665%200%204.492-1.524%205.322-2.401%201.476-1.559%202.886-1.854%206.491.82%201.877%201.393%203.514%201.753%204.861%201.068%202.223-1.713%202.811-3.867%203.399-6.374.077-.846.056-1.469.054-1.537zm-4.835%204.313c-.054.305-.156.586-.242.629-.034-.007-.131-.022-.307-.157-.145-.111-.314-.478-.456-.908.221.121.432.25.675.355.115.039.219.051.33.081zm-2.251-1.238c-.05.33-.158.648-.252.694-.022.001-.125-.018-.307-.157-.217-.166-.488-.906-.639-1.573.358.344.754.693%201.198%201.036zm-3.887-2.337c-.006-.116-.018-.231-.041-.342.635.145%201.189.368%201.599.625.097.231.166.481.174.642-.03.049-.055.101-.067.158-.046.013-.128.026-.298.004-.278-.037-.901-.57-1.367-1.087zm-1.127-.497c.116.306.176.625.12.71-.019.014-.117.045-.345.016-.206-.027-.604-.332-.986-.695.41-.051.816-.056%201.211-.031zm-4.535%201.535c.209.22.379.47.358.598-.006.041-.088.138-.351.234-.144.055-.539-.063-.979-.259a11.66%2011.66%200%200%200%20.972-.573zm.983-.664c.359-.237.738-.418%201.126-.554.25.237.479.548.457.694-.006.042-.087.138-.351.235-.174.064-.694-.105-1.232-.375zm-3.381%201.794c-.022.145-.061.29-.149.401-.133.166-.358.248-.69.251h-.002c-.133%200-.306-.26-.45-.621.417.091.854.07%201.291-.031zm-2.066-8.077a4.78%204.78%200%200%201-.775-.584c.172-.115.505-.254.88-.378l-.105.962zm-.331%202.302a10.32%2010.32%200%200%201-.828-.502c.202-.143.576-.328.984-.49l-.156.992zm-.45%202.157l-.701-.403c.214-.115.536-.249.891-.376a11.57%2011.57%200%200%201-.19.779zm-.181%201.716c.064.398.194.702.298.893-.194-.051-.435-.162-.736-.398.061-.119.224-.3.438-.495zM8.87%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zm-.735-.389a1.15%201.15%200%200%200-.314.783%201.16%201.16%200%200%200%201.162%201.162c.457%200%20.842-.27%201.032-.653.026.117.042.238.042.362a1.68%201.68%200%200%201-1.679%201.679%201.68%201.68%200%200%201-1.679-1.679c0-.843.626-1.535%201.436-1.654zM5.059%205.406A1.68%201.68%200%200%201%203.38%207.085a1.68%201.68%200%200%201-1.679-1.679c0-.037.009-.072.011-.109.21.3.541.508.935.508a1.16%201.16%200%200%200%201.162-1.162%201.14%201.14%200%200%200-.474-.912c.015%200%20.03-.005.045-.005.926.001%201.679.754%201.679%201.68zM3.198%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zM1.375%208.964c0-.52.103-1.035.288-1.52.466.394%201.06.64%201.717.64%201.144%200%202.116-.725%202.499-1.738.383%201.012%201.355%201.738%202.499%201.738.867%200%201.631-.421%202.121-1.062.307.605.478%201.267.478%201.942%200%202.486-2.153%204.51-4.801%204.51s-4.801-2.023-4.801-4.51zm24.342%2019.349c-.985.498-2.267.168-3.813-.979-3.073-2.281-5.453-3.199-7.813-.705-1.315%201.391-4.163%203.365-8.423.97-3.174-1.786-2.239-6.266-1.261-9.479l.146-.492c.276-1.02.395-2.457.444-3.268a6.11%206.11%200%200%200%201.18.115%206.01%206.01%200%200%200%202.536-.562l-.006.175c-.802.215-1.848.612-2.021%201.25-.079.295.021.601.274.837.219.203.415.364.598.501-.667.304-1.243.698-1.311%201.179-.02.144-.022.507.393.787.213.144.395.26.564.365-1.285.521-1.361.96-1.381%201.126-.018.142-.011.496.427.746l.854.489c-.473.389-.971.914-.999%201.429-.018.278.095.532.316.713.675.556%201.231.721%201.653.721.059%200%20.104-.014.158-.02.207.707.641%201.64%201.513%201.64h.013c.8-.008%201.236-.345%201.462-.626.173-.216.268-.457.325-.692.424.195.93.374%201.372.374.151%200%20.294-.021.423-.068.732-.27.944-.704.993-1.021.009-.061.003-.119.002-.179.266.086.538.147.789.147.15%200%20.294-.021.423-.069.542-.2.797-.489.914-.754.237.147.478.258.704.288.106.014.205.021.296.021.356%200%20.595-.101.767-.229.438.435%201.094.992%201.656%201.067.106.014.205.021.296.021a1.56%201.56%200%200%200%20.323-.035c.17.575.453%201.289.866%201.605.358.273.665.362.914.362a.99.99%200%200%200%20.421-.093%201.03%201.03%200%200%200%20.245-.164c.168.428.39.846.68%201.068.358.273.665.362.913.362a.99.99%200%200%200%20.421-.093c.317-.148.512-.448.639-.762.251.157.495.257.726.257.127%200%20.25-.024.37-.071.427-.17.706-.617.841-1.314.022-.015.047-.022.068-.038.067-.051.133-.104.196-.159-.443%201.486-1.107%202.761-2.086%203.257zM8.66%209.925a.5.5%200%201%200-1%200c0%20.653-.818%201.205-1.787%201.205s-1.787-.552-1.787-1.205a.5.5%200%201%200-1%200c0%201.216%201.25%202.205%202.787%202.205s2.787-.989%202.787-2.205zm4.4%2015.965l-.208.097c-2.661%201.258-4.708%201.436-6.086.527-1.542-1.017-1.88-3.19-1.844-4.198a.4.4%200%200%200-.385-.414c-.242-.029-.406.164-.414.385-.046%201.249.367%203.686%202.202%204.896.708.467%201.547.7%202.51.7%201.248%200%202.706-.392%204.362-1.174l.185-.086a.4.4%200%200%200%20.205-.527c-.089-.204-.326-.291-.527-.206zM9.547%202.292c.093.077.205.114.317.114a.5.5%200%200%200%20.318-.886L8.817.397a.5.5%200%200%200-.703.068.5.5%200%200%200%20.069.703l1.364%201.124zm-7.661-.065c.086%200%20.173-.022.253-.068l1.523-.893a.5.5%200%200%200-.506-.863l-1.523.892a.5.5%200%200%200-.179.685c.094.158.261.247.432.247z%22%20transform%3D%22matrix%28-1%200%200%201%2058%200%29%22%20fill%3D%22%233bb300%22/%3E%3Cpath%20d%3D%22M.3%2021.86V10.18q0-.46.02-.68.04-.22.18-.5.28-.54%201.34-.54%201.06%200%201.42.28.38.26.44.78.76-1.04%202.38-1.04%201.64%200%203.1%201.54%201.46%201.54%201.46%203.58%200%202.04-1.46%203.58-1.44%201.54-3.08%201.54-1.64%200-2.38-.92v4.04q0%20.46-.04.68-.02.22-.18.5-.14.3-.5.42-.36.12-.98.12-.62%200-1-.12-.36-.12-.52-.4-.14-.28-.18-.5-.02-.22-.02-.68zm3.96-9.42q-.46.54-.46%201.18%200%20.64.46%201.18.48.52%201.2.52.74%200%201.24-.52.52-.52.52-1.18%200-.66-.48-1.18-.48-.54-1.26-.54-.76%200-1.22.54zm14.741-8.36q.16-.3.54-.42.38-.12%201-.12.64%200%201.02.12.38.12.52.42.16.3.18.54.04.22.04.68v11.94q0%20.46-.04.7-.02.22-.18.5-.3.54-1.7.54-1.38%200-1.54-.98-.84.96-2.34.96-1.8%200-3.28-1.56-1.48-1.58-1.48-3.66%200-2.1%201.48-3.68%201.5-1.58%203.28-1.58%201.48%200%202.3%201v-4.2q0-.46.02-.68.04-.24.18-.52zm-3.24%2010.86q.52.54%201.26.54.74%200%201.22-.54.5-.54.5-1.18%200-.66-.48-1.22-.46-.56-1.26-.56-.8%200-1.28.56-.48.54-.48%201.2%200%20.66.52%201.2zm7.833-1.2q0-2.4%201.68-3.96%201.68-1.56%203.84-1.56%202.16%200%203.82%201.56%201.66%201.54%201.66%203.94%200%201.66-.86%202.96-.86%201.28-2.1%201.9-1.22.6-2.54.6-1.32%200-2.56-.64-1.24-.66-2.1-1.92-.84-1.28-.84-2.88zm4.18%201.44q.64.48%201.3.48.66%200%201.32-.5.66-.5.66-1.48%200-.98-.62-1.46-.62-.48-1.34-.48-.72%200-1.34.5-.62.5-.62%201.48%200%20.96.64%201.46zm11.412-1.44q0%20.84.56%201.32.56.46%201.18.46.64%200%201.18-.36.56-.38.9-.38.6%200%201.46%201.06.46.58.46%201.04%200%20.76-1.1%201.42-1.14.8-2.8.8-1.86%200-3.58-1.34-.82-.64-1.34-1.7-.52-1.08-.52-2.36%200-1.3.52-2.34.52-1.06%201.34-1.7%201.66-1.32%203.54-1.32.76%200%201.48.22.72.2%201.06.4l.32.2q.36.24.56.38.52.4.52.92%200%20.5-.42%201.14-.72%201.1-1.38%201.1-.38%200-1.08-.44-.36-.34-1.04-.34-.66%200-1.24.48-.58.48-.58%201.34z%22%20fill%3D%22green%22/%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section class="module-info">
                    <h1 class="modulename">
simulator    </h1>

                
                        <input id="mod-simulator-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">

                        <label class="view-source-button" for="mod-simulator-view-source"><span>View Source</span></label>

                        <div class="pdoc-code codehilite"><pre><span></span><span id="L-1"><a href="#L-1"><span class="linenos">  1</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">struct</span>
</span><span id="L-2"><a href="#L-2"><span class="linenos">  2</span></a>
</span><span id="L-3"><a href="#L-3"><span class="linenos">  3</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">settings</span><span class="w"> </span><span class="kn">import</span> <span class="n">getSetting</span>
</span><span id="L-4"><a href="#L-4"><span class="linenos">  4</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">components</span><span class="w"> </span><span class="kn">import</span> <span class="n">Registers</span><span class="p">,</span> <span class="n">Memory</span><span class="p">,</span> <span class="n">Breakpoint</span><span class="p">,</span> <span class="n">ComponentException</span>
</span><span id="L-5"><a href="#L-5"><span class="linenos">  5</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">history</span><span class="w"> </span><span class="kn">import</span> <span class="n">History</span>
</span><span id="L-6"><a href="#L-6"><span class="linenos">  6</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">simulatorOps</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
</span><span id="L-7"><a href="#L-7"><span class="linenos">  7</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">simulatorOps.abstractOp</span><span class="w"> </span><span class="kn">import</span> <span class="n">ExecutionException</span>
</span><span id="L-8"><a href="#L-8"><span class="linenos">  8</span></a>
</span><span id="L-9"><a href="#L-9"><span class="linenos">  9</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">stateManager</span><span class="w"> </span><span class="kn">import</span> <span class="n">StateManager</span>
</span><span id="L-10"><a href="#L-10"><span class="linenos"> 10</span></a><span class="n">appState</span> <span class="o">=</span> <span class="n">StateManager</span><span class="p">()</span>
</span><span id="L-11"><a href="#L-11"><span class="linenos"> 11</span></a>
</span><span id="L-12"><a href="#L-12"><span class="linenos"> 12</span></a><span class="k">class</span><span class="w"> </span><span class="nc">MultipleErrors</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
</span><span id="L-13"><a href="#L-13"><span class="linenos"> 13</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-14"><a href="#L-14"><span class="linenos"> 14</span></a><span class="sd">    This exception class is used to store multiple execution errors. It is useful if there</span>
</span><span id="L-15"><a href="#L-15"><span class="linenos"> 15</span></a><span class="sd">    are multiple errors in one instruction. Also, this class can be iterated to treat each error individually.</span>
</span><span id="L-16"><a href="#L-16"><span class="linenos"> 16</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-17"><a href="#L-17"><span class="linenos"> 17</span></a>
</span><span id="L-18"><a href="#L-18"><span class="linenos"> 18</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">info</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">line</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="L-19"><a href="#L-19"><span class="linenos"> 19</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-20"><a href="#L-20"><span class="linenos"> 20</span></a><span class="sd">        Initialize a empty class if error and info are None.</span>
</span><span id="L-21"><a href="#L-21"><span class="linenos"> 21</span></a><span class="sd">        Otherwise, initialize the class with the corresponding parameters.</span>
</span><span id="L-22"><a href="#L-22"><span class="linenos"> 22</span></a>
</span><span id="L-23"><a href="#L-23"><span class="linenos"> 23</span></a><span class="sd">        :param error: a str containing the error type</span>
</span><span id="L-24"><a href="#L-24"><span class="linenos"> 24</span></a><span class="sd">        :param info: a str containing information on the error</span>
</span><span id="L-25"><a href="#L-25"><span class="linenos"> 25</span></a><span class="sd">        :param line: the line number when the error occurs (default None)</span>
</span><span id="L-26"><a href="#L-26"><span class="linenos"> 26</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-27"><a href="#L-27"><span class="linenos"> 27</span></a>        <span class="k">if</span> <span class="n">error</span> <span class="ow">and</span> <span class="n">info</span><span class="p">:</span>
</span><span id="L-28"><a href="#L-28"><span class="linenos"> 28</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="p">[(</span><span class="n">error</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">line</span><span class="p">)]</span>
</span><span id="L-29"><a href="#L-29"><span class="linenos"> 29</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-30"><a href="#L-30"><span class="linenos"> 30</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-31"><a href="#L-31"><span class="linenos"> 31</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-32"><a href="#L-32"><span class="linenos"> 32</span></a>
</span><span id="L-33"><a href="#L-33"><span class="linenos"> 33</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__bool__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-34"><a href="#L-34"><span class="linenos"> 34</span></a>        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">content</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span>
</span><span id="L-35"><a href="#L-35"><span class="linenos"> 35</span></a>
</span><span id="L-36"><a href="#L-36"><span class="linenos"> 36</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-37"><a href="#L-37"><span class="linenos"> 37</span></a>        <span class="k">return</span> <span class="bp">self</span>
</span><span id="L-38"><a href="#L-38"><span class="linenos"> 38</span></a>
</span><span id="L-39"><a href="#L-39"><span class="linenos"> 39</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__next__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-40"><a href="#L-40"><span class="linenos"> 40</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-41"><a href="#L-41"><span class="linenos"> 41</span></a>            <span class="n">retval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">content</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">idx</span><span class="p">]</span>
</span><span id="L-42"><a href="#L-42"><span class="linenos"> 42</span></a>        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
</span><span id="L-43"><a href="#L-43"><span class="linenos"> 43</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-44"><a href="#L-44"><span class="linenos"> 44</span></a>            <span class="k">raise</span> <span class="ne">StopIteration</span><span class="p">()</span>
</span><span id="L-45"><a href="#L-45"><span class="linenos"> 45</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-46"><a href="#L-46"><span class="linenos"> 46</span></a>        <span class="k">return</span> <span class="n">retval</span>
</span><span id="L-47"><a href="#L-47"><span class="linenos"> 47</span></a>
</span><span id="L-48"><a href="#L-48"><span class="linenos"> 48</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">append</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">line</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="L-49"><a href="#L-49"><span class="linenos"> 49</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">error</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">line</span><span class="p">))</span>
</span><span id="L-50"><a href="#L-50"><span class="linenos"> 50</span></a>
</span><span id="L-51"><a href="#L-51"><span class="linenos"> 51</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-52"><a href="#L-52"><span class="linenos"> 52</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-53"><a href="#L-53"><span class="linenos"> 53</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-54"><a href="#L-54"><span class="linenos"> 54</span></a>
</span><span id="L-55"><a href="#L-55"><span class="linenos"> 55</span></a>
</span><span id="L-56"><a href="#L-56"><span class="linenos"> 56</span></a><span class="k">class</span><span class="w"> </span><span class="nc">Simulator</span><span class="p">:</span>
</span><span id="L-57"><a href="#L-57"><span class="linenos"> 57</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-58"><a href="#L-58"><span class="linenos"> 58</span></a><span class="sd">    Main simulator class.</span>
</span><span id="L-59"><a href="#L-59"><span class="linenos"> 59</span></a><span class="sd">    None of its method should be called directly by the UI,</span>
</span><span id="L-60"><a href="#L-60"><span class="linenos"> 60</span></a><span class="sd">    everything should pass through bytecodeinterpreter class.</span>
</span><span id="L-61"><a href="#L-61"><span class="linenos"> 61</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-62"><a href="#L-62"><span class="linenos"> 62</span></a>
</span><span id="L-63"><a href="#L-63"><span class="linenos"> 63</span></a>    <span class="n">PC</span> <span class="o">=</span> <span class="mi">15</span>  <span class="c1"># Helpful shorthand to get a reference on PC</span>
</span><span id="L-64"><a href="#L-64"><span class="linenos"> 64</span></a>
</span><span id="L-65"><a href="#L-65"><span class="linenos"> 65</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">memorycontent</span><span class="p">,</span> <span class="n">assertionTriggers</span><span class="p">,</span> <span class="n">addr2line</span><span class="p">,</span> <span class="n">pcInitValue</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
</span><span id="L-66"><a href="#L-66"><span class="linenos"> 66</span></a>        <span class="c1"># Parameters</span>
</span><span id="L-67"><a href="#L-67"><span class="linenos"> 67</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pcoffset</span> <span class="o">=</span> <span class="mi">8</span> <span class="k">if</span> <span class="n">getSetting</span><span class="p">(</span><span class="s2">&quot;PCbehavior&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;+8&quot;</span> <span class="k">else</span> <span class="mi">0</span>
</span><span id="L-68"><a href="#L-68"><span class="linenos"> 68</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">PCSpecialBehavior</span> <span class="o">=</span> <span class="n">getSetting</span><span class="p">(</span><span class="s2">&quot;PCspecialbehavior&quot;</span><span class="p">)</span>
</span><span id="L-69"><a href="#L-69"><span class="linenos"> 69</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">allowSwitchModeInUserMode</span> <span class="o">=</span> <span class="n">getSetting</span><span class="p">(</span><span class="s2">&quot;allowuserswitchmode&quot;</span><span class="p">)</span>
</span><span id="L-70"><a href="#L-70"><span class="linenos"> 70</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">maxit</span> <span class="o">=</span> <span class="n">getSetting</span><span class="p">(</span><span class="s2">&quot;runmaxit&quot;</span><span class="p">)</span>
</span><span id="L-71"><a href="#L-71"><span class="linenos"> 71</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">bkptLastFetch</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-72"><a href="#L-72"><span class="linenos"> 72</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">deactivatedBkpts</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-73"><a href="#L-73"><span class="linenos"> 73</span></a>
</span><span id="L-74"><a href="#L-74"><span class="linenos"> 74</span></a>        <span class="c1"># Initialize history</span>
</span><span id="L-75"><a href="#L-75"><span class="linenos"> 75</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">history</span> <span class="o">=</span> <span class="n">History</span><span class="p">()</span>
</span><span id="L-76"><a href="#L-76"><span class="linenos"> 76</span></a>
</span><span id="L-77"><a href="#L-77"><span class="linenos"> 77</span></a>        <span class="c1"># Initialize components</span>
</span><span id="L-78"><a href="#L-78"><span class="linenos"> 78</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mem</span> <span class="o">=</span> <span class="n">Memory</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">,</span> <span class="n">memorycontent</span><span class="p">)</span>
</span><span id="L-79"><a href="#L-79"><span class="linenos"> 79</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">regs</span> <span class="o">=</span> <span class="n">Registers</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">)</span>
</span><span id="L-80"><a href="#L-80"><span class="linenos"> 80</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pcInitVal</span> <span class="o">=</span> <span class="n">pcInitValue</span>
</span><span id="L-81"><a href="#L-81"><span class="linenos"> 81</span></a>
</span><span id="L-82"><a href="#L-82"><span class="linenos"> 82</span></a>        <span class="c1"># Initialize decoders</span>
</span><span id="L-83"><a href="#L-83"><span class="linenos"> 83</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">decoders</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-84"><a href="#L-84"><span class="linenos"> 84</span></a>            <span class="s2">&quot;BranchOp&quot;</span><span class="p">:</span> <span class="n">BranchOp</span><span class="p">(),</span>
</span><span id="L-85"><a href="#L-85"><span class="linenos"> 85</span></a>            <span class="s2">&quot;DataOp&quot;</span><span class="p">:</span> <span class="n">DataOp</span><span class="p">(),</span>
</span><span id="L-86"><a href="#L-86"><span class="linenos"> 86</span></a>            <span class="s2">&quot;MemOp&quot;</span><span class="p">:</span> <span class="n">MemOp</span><span class="p">(),</span>
</span><span id="L-87"><a href="#L-87"><span class="linenos"> 87</span></a>            <span class="s2">&quot;MultipleMemOp&quot;</span><span class="p">:</span> <span class="n">MultipleMemOp</span><span class="p">(),</span>
</span><span id="L-88"><a href="#L-88"><span class="linenos"> 88</span></a>            <span class="s2">&quot;HalfSignedMemOp&quot;</span><span class="p">:</span> <span class="n">HalfSignedMemOp</span><span class="p">(),</span>
</span><span id="L-89"><a href="#L-89"><span class="linenos"> 89</span></a>            <span class="s2">&quot;SwapOp&quot;</span><span class="p">:</span> <span class="n">SwapOp</span><span class="p">(),</span>
</span><span id="L-90"><a href="#L-90"><span class="linenos"> 90</span></a>            <span class="s2">&quot;PSROp&quot;</span><span class="p">:</span> <span class="n">PSROp</span><span class="p">(),</span>
</span><span id="L-91"><a href="#L-91"><span class="linenos"> 91</span></a>            <span class="s2">&quot;MulOp&quot;</span><span class="p">:</span> <span class="n">MulOp</span><span class="p">(),</span>
</span><span id="L-92"><a href="#L-92"><span class="linenos"> 92</span></a>            <span class="s2">&quot;MulLongOp&quot;</span><span class="p">:</span> <span class="n">MulLongOp</span><span class="p">(),</span>
</span><span id="L-93"><a href="#L-93"><span class="linenos"> 93</span></a>            <span class="s2">&quot;SoftInterruptOp&quot;</span><span class="p">:</span> <span class="n">SoftInterruptOp</span><span class="p">(),</span>
</span><span id="L-94"><a href="#L-94"><span class="linenos"> 94</span></a>            <span class="s2">&quot;NopOp&quot;</span><span class="p">:</span> <span class="n">NopOp</span><span class="p">(),</span>
</span><span id="L-95"><a href="#L-95"><span class="linenos"> 95</span></a>        <span class="p">}</span>
</span><span id="L-96"><a href="#L-96"><span class="linenos"> 96</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">decoderCache</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-97"><a href="#L-97"><span class="linenos"> 97</span></a>
</span><span id="L-98"><a href="#L-98"><span class="linenos"> 98</span></a>        <span class="c1"># Initialize assertion structures</span>
</span><span id="L-99"><a href="#L-99"><span class="linenos"> 99</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">assertionCkpts</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">assertionTriggers</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</span><span id="L-100"><a href="#L-100"><span class="linenos">100</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">assertionData</span> <span class="o">=</span> <span class="n">assertionTriggers</span>
</span><span id="L-101"><a href="#L-101"><span class="linenos">101</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">assertionWhenReturn</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span><span id="L-102"><a href="#L-102"><span class="linenos">102</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">callStack</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-103"><a href="#L-103"><span class="linenos">103</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">addr2line</span> <span class="o">=</span> <span class="n">addr2line</span>
</span><span id="L-104"><a href="#L-104"><span class="linenos">104</span></a>
</span><span id="L-105"><a href="#L-105"><span class="linenos">105</span></a>        <span class="c1"># Initialize execution errors buffer</span>
</span><span id="L-106"><a href="#L-106"><span class="linenos">106</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">errorsPending</span> <span class="o">=</span> <span class="n">MultipleErrors</span><span class="p">()</span>
</span><span id="L-107"><a href="#L-107"><span class="linenos">107</span></a>
</span><span id="L-108"><a href="#L-108"><span class="linenos">108</span></a>        <span class="c1"># Initialize interrupt structures</span>
</span><span id="L-109"><a href="#L-109"><span class="linenos">109</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">interruptActive</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-110"><a href="#L-110"><span class="linenos">110</span></a>        <span class="c1"># Interrupt trigged at each a*(t-t0) + b cycles</span>
</span><span id="L-111"><a href="#L-111"><span class="linenos">111</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">interruptParams</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;b&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;t0&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;FIQ&quot;</span><span class="p">}</span>
</span><span id="L-112"><a href="#L-112"><span class="linenos">112</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">lastInterruptCycle</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
</span><span id="L-113"><a href="#L-113"><span class="linenos">113</span></a>
</span><span id="L-114"><a href="#L-114"><span class="linenos">114</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stepMode</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-115"><a href="#L-115"><span class="linenos">115</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stepCondition</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-116"><a href="#L-116"><span class="linenos">116</span></a>        <span class="c1"># Used to stop the simulator after n iterations in run mode</span>
</span><span id="L-117"><a href="#L-117"><span class="linenos">117</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">runIteration</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-118"><a href="#L-118"><span class="linenos">118</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
</span><span id="L-119"><a href="#L-119"><span class="linenos">119</span></a>
</span><span id="L-120"><a href="#L-120"><span class="linenos">120</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-121"><a href="#L-121"><span class="linenos">121</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
</span><span id="L-122"><a href="#L-122"><span class="linenos">122</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">regs</span><span class="o">.</span><span class="n">banks</span><span class="p">[</span><span class="s2">&quot;User&quot;</span><span class="p">][</span><span class="mi">15</span><span class="p">]</span><span class="o">.</span><span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pcInitVal</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">pcoffset</span>
</span><span id="L-123"><a href="#L-123"><span class="linenos">123</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fetchAndDecode</span><span class="p">()</span>
</span><span id="L-124"><a href="#L-124"><span class="linenos">124</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">explainInstruction</span><span class="p">()</span>
</span><span id="L-125"><a href="#L-125"><span class="linenos">125</span></a>
</span><span id="L-126"><a href="#L-126"><span class="linenos">126</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">getContext</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-127"><a href="#L-127"><span class="linenos">127</span></a>        <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;regs&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">regs</span><span class="o">.</span><span class="n">getContext</span><span class="p">(),</span> <span class="s2">&quot;mem&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">mem</span><span class="o">.</span><span class="n">getContext</span><span class="p">()}</span>
</span><span id="L-128"><a href="#L-128"><span class="linenos">128</span></a>        <span class="k">return</span> <span class="n">context</span>
</span><span id="L-129"><a href="#L-129"><span class="linenos">129</span></a>
</span><span id="L-130"><a href="#L-130"><span class="linenos">130</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">setStepCondition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stepMode</span><span class="p">):</span>
</span><span id="L-131"><a href="#L-131"><span class="linenos">131</span></a>        <span class="k">assert</span> <span class="n">stepMode</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;into&quot;</span><span class="p">,</span> <span class="s2">&quot;out&quot;</span><span class="p">,</span> <span class="s2">&quot;forward&quot;</span><span class="p">,</span> <span class="s2">&quot;run&quot;</span><span class="p">)</span>
</span><span id="L-132"><a href="#L-132"><span class="linenos">132</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stepMode</span> <span class="o">=</span> <span class="n">stepMode</span>
</span><span id="L-133"><a href="#L-133"><span class="linenos">133</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stepCondition</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="L-134"><a href="#L-134"><span class="linenos">134</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">runIteration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">cyclesCount</span>
</span><span id="L-135"><a href="#L-135"><span class="linenos">135</span></a>
</span><span id="L-136"><a href="#L-136"><span class="linenos">136</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">isStepDone</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-137"><a href="#L-137"><span class="linenos">137</span></a>        <span class="n">maxCyclesReached</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">cyclesCount</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">runIteration</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxit</span>
</span><span id="L-138"><a href="#L-138"><span class="linenos">138</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stepMode</span> <span class="o">==</span> <span class="s2">&quot;forward&quot;</span><span class="p">:</span>
</span><span id="L-139"><a href="#L-139"><span class="linenos">139</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stepCondition</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="L-140"><a href="#L-140"><span class="linenos">140</span></a>                <span class="c1"># The instruction was a function call</span>
</span><span id="L-141"><a href="#L-141"><span class="linenos">141</span></a>                <span class="c1"># Now the step forward becomes a step out</span>
</span><span id="L-142"><a href="#L-142"><span class="linenos">142</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">stepMode</span> <span class="o">=</span> <span class="s2">&quot;out&quot;</span>
</span><span id="L-143"><a href="#L-143"><span class="linenos">143</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">stepCondition</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="L-144"><a href="#L-144"><span class="linenos">144</span></a>                <span class="k">return</span> <span class="kc">False</span>
</span><span id="L-145"><a href="#L-145"><span class="linenos">145</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-146"><a href="#L-146"><span class="linenos">146</span></a>                <span class="k">return</span> <span class="kc">True</span>
</span><span id="L-147"><a href="#L-147"><span class="linenos">147</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stepMode</span> <span class="o">==</span> <span class="s2">&quot;out&quot;</span><span class="p">:</span>
</span><span id="L-148"><a href="#L-148"><span class="linenos">148</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">stepCondition</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">maxCyclesReached</span>
</span><span id="L-149"><a href="#L-149"><span class="linenos">149</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stepMode</span> <span class="o">==</span> <span class="s2">&quot;run&quot;</span><span class="p">:</span>
</span><span id="L-150"><a href="#L-150"><span class="linenos">150</span></a>            <span class="k">return</span> <span class="n">maxCyclesReached</span>
</span><span id="L-151"><a href="#L-151"><span class="linenos">151</span></a>
</span><span id="L-152"><a href="#L-152"><span class="linenos">152</span></a>        <span class="c1"># We are doing a step into, we always stop</span>
</span><span id="L-153"><a href="#L-153"><span class="linenos">153</span></a>        <span class="k">return</span> <span class="kc">True</span>
</span><span id="L-154"><a href="#L-154"><span class="linenos">154</span></a>
</span><span id="L-155"><a href="#L-155"><span class="linenos">155</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">loop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-156"><a href="#L-156"><span class="linenos">156</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-157"><a href="#L-157"><span class="linenos">157</span></a><span class="sd">        Loop until the stopping criterion is met. Returns the aggregated list</span>
</span><span id="L-158"><a href="#L-158"><span class="linenos">158</span></a><span class="sd">        of changes since the beginning of the simulation loop.</span>
</span><span id="L-159"><a href="#L-159"><span class="linenos">159</span></a><span class="sd">        Stopping criterion can be set using `setStepCondition`.</span>
</span><span id="L-160"><a href="#L-160"><span class="linenos">160</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-161"><a href="#L-161"><span class="linenos">161</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">setCheckpoint</span><span class="p">()</span>
</span><span id="L-162"><a href="#L-162"><span class="linenos">162</span></a>        <span class="k">for</span> <span class="n">decoder</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoders</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
</span><span id="L-163"><a href="#L-163"><span class="linenos">163</span></a>            <span class="n">decoder</span><span class="o">.</span><span class="n">resetExecCounters</span><span class="p">()</span>
</span><span id="L-164"><a href="#L-164"><span class="linenos">164</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">nextInstr</span><span class="p">()</span>  <span class="c1"># We always execute at least one instruction</span>
</span><span id="L-165"><a href="#L-165"><span class="linenos">165</span></a>        <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">isStepDone</span><span class="p">():</span>  <span class="c1"># We repeat until the stopping criterion is met</span>
</span><span id="L-166"><a href="#L-166"><span class="linenos">166</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">nextInstr</span><span class="p">()</span>
</span><span id="L-167"><a href="#L-167"><span class="linenos">167</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">explainInstruction</span><span class="p">()</span>  <span class="c1"># We only have to explain the last instruction executed before we stop</span>
</span><span id="L-168"><a href="#L-168"><span class="linenos">168</span></a>
</span><span id="L-169"><a href="#L-169"><span class="linenos">169</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">stepBack</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
</span><span id="L-170"><a href="#L-170"><span class="linenos">170</span></a>        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">count</span><span class="p">):</span>
</span><span id="L-171"><a href="#L-171"><span class="linenos">171</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">stepBack</span><span class="p">()</span>
</span><span id="L-172"><a href="#L-172"><span class="linenos">172</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fetchAndDecode</span><span class="p">(</span><span class="n">forceExplain</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-173"><a href="#L-173"><span class="linenos">173</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">bkptLastFetch</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-174"><a href="#L-174"><span class="linenos">174</span></a>
</span><span id="L-175"><a href="#L-175"><span class="linenos">175</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">executionStats</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-176"><a href="#L-176"><span class="linenos">176</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-177"><a href="#L-177"><span class="linenos">177</span></a><span class="sd">        Return a dictionary with the number of times each instruction type was executed</span>
</span><span id="L-178"><a href="#L-178"><span class="linenos">178</span></a><span class="sd">        in the last execution run.</span>
</span><span id="L-179"><a href="#L-179"><span class="linenos">179</span></a><span class="sd">        The types are:</span>
</span><span id="L-180"><a href="#L-180"><span class="linenos">180</span></a><span class="sd">        - &quot;data&quot; (includes all arithmetic and logic operations except multiply)</span>
</span><span id="L-181"><a href="#L-181"><span class="linenos">181</span></a><span class="sd">        - &quot;mem&quot; (includes all _single_ memory accesses including byte, half or word access and swap)</span>
</span><span id="L-182"><a href="#L-182"><span class="linenos">182</span></a><span class="sd">        - &quot;multiplemem&quot; (all _multiple_ memory accesses: LDM, STM, POP, and PUSH)</span>
</span><span id="L-183"><a href="#L-183"><span class="linenos">183</span></a><span class="sd">        - &quot;branch&quot; (all branches, B/BL/BX alike)</span>
</span><span id="L-184"><a href="#L-184"><span class="linenos">184</span></a><span class="sd">        - &quot;multiply&quot; (multiply and multiply long operations)</span>
</span><span id="L-185"><a href="#L-185"><span class="linenos">185</span></a><span class="sd">        - &quot;softinterrupt&quot; (self explanatory)</span>
</span><span id="L-186"><a href="#L-186"><span class="linenos">186</span></a><span class="sd">        - &quot;psr&quot; (CPSR/SPRS &lt;-&gt; register transfers)</span>
</span><span id="L-187"><a href="#L-187"><span class="linenos">187</span></a><span class="sd">        - &quot;nop&quot; (NOP instructions)</span>
</span><span id="L-188"><a href="#L-188"><span class="linenos">188</span></a>
</span><span id="L-189"><a href="#L-189"><span class="linenos">189</span></a><span class="sd">        These keys are associated to a 2-integers tuple. The first value is the number of times</span>
</span><span id="L-190"><a href="#L-190"><span class="linenos">190</span></a><span class="sd">        this kind of instruction was executed, the second the number of times if _would_ have been</span>
</span><span id="L-191"><a href="#L-191"><span class="linenos">191</span></a><span class="sd">        executed except for the condition field (e.g. the condition was not met).</span>
</span><span id="L-192"><a href="#L-192"><span class="linenos">192</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-193"><a href="#L-193"><span class="linenos">193</span></a>        <span class="n">memExec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoders</span><span class="p">[</span><span class="s2">&quot;MemOp&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">execCounters</span>
</span><span id="L-194"><a href="#L-194"><span class="linenos">194</span></a>        <span class="n">halfMemExec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoders</span><span class="p">[</span><span class="s2">&quot;HalfSignedMemOp&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">execCounters</span>
</span><span id="L-195"><a href="#L-195"><span class="linenos">195</span></a>        <span class="n">swapExec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoders</span><span class="p">[</span><span class="s2">&quot;SwapOp&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">execCounters</span>
</span><span id="L-196"><a href="#L-196"><span class="linenos">196</span></a>        <span class="n">multiplyExec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoders</span><span class="p">[</span><span class="s2">&quot;MulOp&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">execCounters</span>
</span><span id="L-197"><a href="#L-197"><span class="linenos">197</span></a>        <span class="n">multiplyLongExec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoders</span><span class="p">[</span><span class="s2">&quot;MulLongOp&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">execCounters</span>
</span><span id="L-198"><a href="#L-198"><span class="linenos">198</span></a>
</span><span id="L-199"><a href="#L-199"><span class="linenos">199</span></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="L-200"><a href="#L-200"><span class="linenos">200</span></a>            <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoders</span><span class="p">[</span><span class="s2">&quot;DataOp&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">execCounters</span><span class="p">,</span>
</span><span id="L-201"><a href="#L-201"><span class="linenos">201</span></a>            <span class="s2">&quot;mem&quot;</span><span class="p">:</span> <span class="p">(</span>
</span><span id="L-202"><a href="#L-202"><span class="linenos">202</span></a>                <span class="n">memExec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">halfMemExec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">swapExec</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
</span><span id="L-203"><a href="#L-203"><span class="linenos">203</span></a>                <span class="n">memExec</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">halfMemExec</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">swapExec</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
</span><span id="L-204"><a href="#L-204"><span class="linenos">204</span></a>            <span class="p">),</span>
</span><span id="L-205"><a href="#L-205"><span class="linenos">205</span></a>            <span class="s2">&quot;multiplemem&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoders</span><span class="p">[</span><span class="s2">&quot;MultipleMemOp&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">execCounters</span><span class="p">,</span>
</span><span id="L-206"><a href="#L-206"><span class="linenos">206</span></a>            <span class="s2">&quot;branch&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoders</span><span class="p">[</span><span class="s2">&quot;BranchOp&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">execCounters</span><span class="p">,</span>
</span><span id="L-207"><a href="#L-207"><span class="linenos">207</span></a>            <span class="s2">&quot;multiply&quot;</span><span class="p">:</span> <span class="p">(</span>
</span><span id="L-208"><a href="#L-208"><span class="linenos">208</span></a>                <span class="n">multiplyExec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">multiplyLongExec</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
</span><span id="L-209"><a href="#L-209"><span class="linenos">209</span></a>                <span class="n">multiplyExec</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">multiplyLongExec</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
</span><span id="L-210"><a href="#L-210"><span class="linenos">210</span></a>            <span class="p">),</span>
</span><span id="L-211"><a href="#L-211"><span class="linenos">211</span></a>            <span class="s2">&quot;softinterrupt&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoders</span><span class="p">[</span><span class="s2">&quot;SoftInterruptOp&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">execCounters</span><span class="p">,</span>
</span><span id="L-212"><a href="#L-212"><span class="linenos">212</span></a>            <span class="s2">&quot;psr&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoders</span><span class="p">[</span><span class="s2">&quot;PSROp&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">execCounters</span><span class="p">,</span>
</span><span id="L-213"><a href="#L-213"><span class="linenos">213</span></a>            <span class="s2">&quot;nop&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoders</span><span class="p">[</span><span class="s2">&quot;NopOp&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">execCounters</span><span class="p">,</span>
</span><span id="L-214"><a href="#L-214"><span class="linenos">214</span></a>        <span class="p">}</span>
</span><span id="L-215"><a href="#L-215"><span class="linenos">215</span></a>
</span><span id="L-216"><a href="#L-216"><span class="linenos">216</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">fetchAndDecode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">forceExplain</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="L-217"><a href="#L-217"><span class="linenos">217</span></a>        <span class="c1"># Check if PC is valid (multiple of 4)</span>
</span><span id="L-218"><a href="#L-218"><span class="linenos">218</span></a>        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">regs</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">pcoffset</span><span class="p">)</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-219"><a href="#L-219"><span class="linenos">219</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fetchedInstr</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-220"><a href="#L-220"><span class="linenos">220</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">errorsPending</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="L-221"><a href="#L-221"><span class="linenos">221</span></a>                <span class="s2">&quot;register&quot;</span><span class="p">,</span>
</span><span id="L-222"><a href="#L-222"><span class="linenos">222</span></a>                <span class="n">appState</span><span class="o">.</span><span class="n">getT</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="L-223"><a href="#L-223"><span class="linenos">223</span></a>                    <span class="nb">hex</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">regs</span><span class="p">[</span><span class="mi">15</span><span class="p">])</span>
</span><span id="L-224"><a href="#L-224"><span class="linenos">224</span></a>                <span class="p">),</span>
</span><span id="L-225"><a href="#L-225"><span class="linenos">225</span></a>            <span class="p">)</span>
</span><span id="L-226"><a href="#L-226"><span class="linenos">226</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-227"><a href="#L-227"><span class="linenos">227</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="L-228"><a href="#L-228"><span class="linenos">228</span></a>                <span class="c1"># Retrieve instruction from memory</span>
</span><span id="L-229"><a href="#L-229"><span class="linenos">229</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">fetchedInstr</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span>
</span><span id="L-230"><a href="#L-230"><span class="linenos">230</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">mem</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">regs</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">pcoffset</span><span class="p">,</span> <span class="n">execMode</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-231"><a href="#L-231"><span class="linenos">231</span></a>                <span class="p">)</span>
</span><span id="L-232"><a href="#L-232"><span class="linenos">232</span></a>            <span class="k">except</span> <span class="n">Breakpoint</span> <span class="k">as</span> <span class="n">bp</span><span class="p">:</span>
</span><span id="L-233"><a href="#L-233"><span class="linenos">233</span></a>                <span class="c1"># We hit a breakpoint</span>
</span><span id="L-234"><a href="#L-234"><span class="linenos">234</span></a>                <span class="c1"># Get memory instruction again, without trigger breakpoint</span>
</span><span id="L-235"><a href="#L-235"><span class="linenos">235</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">fetchedInstr</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span>
</span><span id="L-236"><a href="#L-236"><span class="linenos">236</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">mem</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">regs</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">pcoffset</span><span class="p">,</span> <span class="n">mayTriggerBkpt</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-237"><a href="#L-237"><span class="linenos">237</span></a>                <span class="p">)</span>
</span><span id="L-238"><a href="#L-238"><span class="linenos">238</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">bkptLastFetch</span> <span class="o">=</span> <span class="n">bp</span>
</span><span id="L-239"><a href="#L-239"><span class="linenos">239</span></a>            <span class="k">except</span> <span class="n">ComponentException</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
</span><span id="L-240"><a href="#L-240"><span class="linenos">240</span></a>                <span class="c1"># Execution error</span>
</span><span id="L-241"><a href="#L-241"><span class="linenos">241</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">errorsPending</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">err</span><span class="o">.</span><span class="n">cmp</span><span class="p">,</span> <span class="n">err</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
</span><span id="L-242"><a href="#L-242"><span class="linenos">242</span></a>                <span class="c1"># There is no instruction to this address</span>
</span><span id="L-243"><a href="#L-243"><span class="linenos">243</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">fetchedInstr</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-244"><a href="#L-244"><span class="linenos">244</span></a>
</span><span id="L-245"><a href="#L-245"><span class="linenos">245</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">bytecodeToInstr</span><span class="p">()</span>
</span><span id="L-246"><a href="#L-246"><span class="linenos">246</span></a>        <span class="k">if</span> <span class="n">forceExplain</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">isStepDone</span><span class="p">():</span>
</span><span id="L-247"><a href="#L-247"><span class="linenos">247</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">explainInstruction</span><span class="p">()</span>
</span><span id="L-248"><a href="#L-248"><span class="linenos">248</span></a>
</span><span id="L-249"><a href="#L-249"><span class="linenos">249</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">bytecodeToInstr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-250"><a href="#L-250"><span class="linenos">250</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-251"><a href="#L-251"><span class="linenos">251</span></a><span class="sd">          Decode an instruction from its bytecode representation.</span>
</span><span id="L-252"><a href="#L-252"><span class="linenos">252</span></a>
</span><span id="L-253"><a href="#L-253"><span class="linenos">253</span></a><span class="sd">          See ARM Instruction set documentation for more information (Fig 4.1,</span>
</span><span id="L-254"><a href="#L-254"><span class="linenos">254</span></a><span class="sd">          and also Sec. A5.1 of ARM-v7 Architecture Reference Manual).</span>
</span><span id="L-255"><a href="#L-255"><span class="linenos">255</span></a><span class="sd">          We use the following decoding scheme, designed to ensure that avoid any</span>
</span><span id="L-256"><a href="#L-256"><span class="linenos">256</span></a><span class="sd">          instruction representation clash and also to reduce the number of</span>
</span><span id="L-257"><a href="#L-257"><span class="linenos">257</span></a><span class="sd">          conditions having to be checked in total. Each number inside [ ]</span>
</span><span id="L-258"><a href="#L-258"><span class="linenos">258</span></a><span class="sd">          represents a bit position. The usual binary ops symbols apply.</span>
</span><span id="L-259"><a href="#L-259"><span class="linenos">259</span></a>
</span><span id="L-260"><a href="#L-260"><span class="linenos">260</span></a><span class="sd">          Note that NOP was backported from ARMv7, and that ARMv4 coprocessor</span>
</span><span id="L-261"><a href="#L-261"><span class="linenos">261</span></a><span class="sd">          instructions are not supported. Also, we do not explicitly check for</span>
</span><span id="L-262"><a href="#L-262"><span class="linenos">262</span></a><span class="sd">          undefined instructions (in the ARM terminology, they are more</span>
</span><span id="L-263"><a href="#L-263"><span class="linenos">263</span></a><span class="sd">          _unpredictable_ than undefined).</span>
</span><span id="L-264"><a href="#L-264"><span class="linenos">264</span></a>
</span><span id="L-265"><a href="#L-265"><span class="linenos">265</span></a><span class="sd">          Decoded instructions are also cached to improve performance.</span>
</span><span id="L-266"><a href="#L-266"><span class="linenos">266</span></a>
</span><span id="L-267"><a href="#L-267"><span class="linenos">267</span></a><span class="sd">         Bytecode input</span>
</span><span id="L-268"><a href="#L-268"><span class="linenos">268</span></a><span class="sd">           (4 bytes)</span>
</span><span id="L-269"><a href="#L-269"><span class="linenos">269</span></a><span class="sd">               |</span>
</span><span id="L-270"><a href="#L-270"><span class="linenos">270</span></a><span class="sd">               |</span>
</span><span id="L-271"><a href="#L-271"><span class="linenos">271</span></a><span class="sd">               v</span>
</span><span id="L-272"><a href="#L-272"><span class="linenos">272</span></a><span class="sd">          [~26 &amp; ~27]---------------------------------------------------------v</span>
</span><span id="L-273"><a href="#L-273"><span class="linenos">273</span></a><span class="sd">               |                                                              |</span>
</span><span id="L-274"><a href="#L-274"><span class="linenos">274</span></a><span class="sd">               | FALSE                                                        | TRUE</span>
</span><span id="L-275"><a href="#L-275"><span class="linenos">275</span></a><span class="sd">               |                                                              |</span>
</span><span id="L-276"><a href="#L-276"><span class="linenos">276</span></a><span class="sd">               v                                                              v</span>
</span><span id="L-277"><a href="#L-277"><span class="linenos">277</span></a><span class="sd">             [26 ]--------------------------------v                           |</span>
</span><span id="L-278"><a href="#L-278"><span class="linenos">278</span></a><span class="sd">               |                                  |                           |</span>
</span><span id="L-279"><a href="#L-279"><span class="linenos">279</span></a><span class="sd">               | FALSE                            | TRUE                      |</span>
</span><span id="L-280"><a href="#L-280"><span class="linenos">280</span></a><span class="sd">               |                                  |                           |</span>
</span><span id="L-281"><a href="#L-281"><span class="linenos">281</span></a><span class="sd">               v                                  v                           v</span>
</span><span id="L-282"><a href="#L-282"><span class="linenos">282</span></a><span class="sd">             [25 ]----------------v             [27 ]-------------v           |</span>
</span><span id="L-283"><a href="#L-283"><span class="linenos">283</span></a><span class="sd">               |                  |               |               |           |</span>
</span><span id="L-284"><a href="#L-284"><span class="linenos">284</span></a><span class="sd">               | FALSE            | TRUE          | FALSE         | TRUE      |</span>
</span><span id="L-285"><a href="#L-285"><span class="linenos">285</span></a><span class="sd">               |                  |               |               |           |</span>
</span><span id="L-286"><a href="#L-286"><span class="linenos">286</span></a><span class="sd">               v                  v               v               v           v</span>
</span><span id="L-287"><a href="#L-287"><span class="linenos">287</span></a><span class="sd">           LDM / STM          Branch (B)      LDR / STR       SWI / SVC       |</span>
</span><span id="L-288"><a href="#L-288"><span class="linenos">288</span></a><span class="sd">                                           (also undefined                    |</span>
</span><span id="L-289"><a href="#L-289"><span class="linenos">289</span></a><span class="sd">                                               if [4])                        |</span>
</span><span id="L-290"><a href="#L-290"><span class="linenos">290</span></a><span class="sd">               v--------------------------------------------------------------&lt;</span>
</span><span id="L-291"><a href="#L-291"><span class="linenos">291</span></a><span class="sd">               |</span>
</span><span id="L-292"><a href="#L-292"><span class="linenos">292</span></a><span class="sd">               v</span>
</span><span id="L-293"><a href="#L-293"><span class="linenos">293</span></a><span class="sd">         [4 &amp; 7 &amp; ~25]--------------------------------------------v</span>
</span><span id="L-294"><a href="#L-294"><span class="linenos">294</span></a><span class="sd">               |                                                  |</span>
</span><span id="L-295"><a href="#L-295"><span class="linenos">295</span></a><span class="sd">               | FALSE                                            | TRUE</span>
</span><span id="L-296"><a href="#L-296"><span class="linenos">296</span></a><span class="sd">               |                                                  |</span>
</span><span id="L-297"><a href="#L-297"><span class="linenos">297</span></a><span class="sd">               v                                                  v</span>
</span><span id="L-298"><a href="#L-298"><span class="linenos">298</span></a><span class="sd">        [~20 &amp; ~23 &amp; 24]----------v                            [5 | 6]--------v</span>
</span><span id="L-299"><a href="#L-299"><span class="linenos">299</span></a><span class="sd">               |                  |                               |           | TRUE</span>
</span><span id="L-300"><a href="#L-300"><span class="linenos">300</span></a><span class="sd">               | FALSE            | TRUE                          | FALSE     v</span>
</span><span id="L-301"><a href="#L-301"><span class="linenos">301</span></a><span class="sd">               |                  |                               |       LDRH/SH/SB</span>
</span><span id="L-302"><a href="#L-302"><span class="linenos">302</span></a><span class="sd">               v                  v                               v</span>
</span><span id="L-303"><a href="#L-303"><span class="linenos">303</span></a><span class="sd">            DATA OP           [18 &amp; 21]-----------v             [24 ]---------v</span>
</span><span id="L-304"><a href="#L-304"><span class="linenos">304</span></a><span class="sd">        (MOV, ADD, etc.)          |               |               |           | TRUE</span>
</span><span id="L-305"><a href="#L-305"><span class="linenos">305</span></a><span class="sd">                                  | FALSE         | TRUE          | FALSE     v</span>
</span><span id="L-306"><a href="#L-306"><span class="linenos">306</span></a><span class="sd">                                  |               |               |          SWP</span>
</span><span id="L-307"><a href="#L-307"><span class="linenos">307</span></a><span class="sd">                                  v               v               v</span>
</span><span id="L-308"><a href="#L-308"><span class="linenos">308</span></a><span class="sd">               v----------------[19 ]            BX             [23 ]---------v</span>
</span><span id="L-309"><a href="#L-309"><span class="linenos">309</span></a><span class="sd">               |                  |                               |           | TRUE</span>
</span><span id="L-310"><a href="#L-310"><span class="linenos">310</span></a><span class="sd">               | TRUE             | FALSE                         | FALSE     v</span>
</span><span id="L-311"><a href="#L-311"><span class="linenos">311</span></a><span class="sd">               |                  |                               |        Multiply</span>
</span><span id="L-312"><a href="#L-312"><span class="linenos">312</span></a><span class="sd">               v                  v                               v          long</span>
</span><span id="L-313"><a href="#L-313"><span class="linenos">313</span></a><span class="sd">           MSR / MRS             NOP                           Multiply</span>
</span><span id="L-314"><a href="#L-314"><span class="linenos">314</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-315"><a href="#L-315"><span class="linenos">315</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">fetchedInstr</span><span class="p">:</span>
</span><span id="L-316"><a href="#L-316"><span class="linenos">316</span></a>            <span class="c1"># Undefined instruction</span>
</span><span id="L-317"><a href="#L-317"><span class="linenos">317</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">currentInstr</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-318"><a href="#L-318"><span class="linenos">318</span></a>            <span class="k">return</span>
</span><span id="L-319"><a href="#L-319"><span class="linenos">319</span></a>        <span class="c1"># Assumes that the instruction to decode is in self.fetchedInstr</span>
</span><span id="L-320"><a href="#L-320"><span class="linenos">320</span></a>        <span class="n">instrInt</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&quot;&lt;I&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fetchedInstr</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-321"><a href="#L-321"><span class="linenos">321</span></a>
</span><span id="L-322"><a href="#L-322"><span class="linenos">322</span></a>        <span class="k">if</span> <span class="n">instrInt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoderCache</span><span class="p">:</span>
</span><span id="L-323"><a href="#L-323"><span class="linenos">323</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">currentInstr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoderCache</span><span class="p">[</span><span class="n">instrInt</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-324"><a href="#L-324"><span class="linenos">324</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">currentInstr</span><span class="o">.</span><span class="n">setBytecode</span><span class="p">(</span><span class="n">instrInt</span><span class="p">)</span>
</span><span id="L-325"><a href="#L-325"><span class="linenos">325</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">currentInstr</span><span class="o">.</span><span class="n">restoreState</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">decoderCache</span><span class="p">[</span><span class="n">instrInt</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
</span><span id="L-326"><a href="#L-326"><span class="linenos">326</span></a>            <span class="k">return</span>
</span><span id="L-327"><a href="#L-327"><span class="linenos">327</span></a>
</span><span id="L-328"><a href="#L-328"><span class="linenos">328</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">instrInt</span> <span class="o">&gt;&gt;</span> <span class="mi">26</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">):</span>
</span><span id="L-329"><a href="#L-329"><span class="linenos">329</span></a>            <span class="k">if</span> <span class="n">instrInt</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span> <span class="o">&amp;</span> <span class="mi">9</span> <span class="o">==</span> <span class="mi">9</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="n">instrInt</span> <span class="o">&gt;&gt;</span> <span class="mi">25</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">):</span>
</span><span id="L-330"><a href="#L-330"><span class="linenos">330</span></a>                <span class="k">if</span> <span class="n">instrInt</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">:</span>
</span><span id="L-331"><a href="#L-331"><span class="linenos">331</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">currentInstr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoders</span><span class="p">[</span><span class="s2">&quot;HalfSignedMemOp&quot;</span><span class="p">]</span>
</span><span id="L-332"><a href="#L-332"><span class="linenos">332</span></a>                <span class="k">elif</span> <span class="n">instrInt</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-333"><a href="#L-333"><span class="linenos">333</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">currentInstr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoders</span><span class="p">[</span><span class="s2">&quot;SwapOp&quot;</span><span class="p">]</span>
</span><span id="L-334"><a href="#L-334"><span class="linenos">334</span></a>                <span class="k">elif</span> <span class="n">instrInt</span> <span class="o">&gt;&gt;</span> <span class="mi">23</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-335"><a href="#L-335"><span class="linenos">335</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">currentInstr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoders</span><span class="p">[</span><span class="s2">&quot;MulLongOp&quot;</span><span class="p">]</span>
</span><span id="L-336"><a href="#L-336"><span class="linenos">336</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-337"><a href="#L-337"><span class="linenos">337</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">currentInstr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoders</span><span class="p">[</span><span class="s2">&quot;MulOp&quot;</span><span class="p">]</span>
</span><span id="L-338"><a href="#L-338"><span class="linenos">338</span></a>            <span class="k">elif</span> <span class="n">instrInt</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span> <span class="o">&amp;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="n">instrInt</span> <span class="o">&gt;&gt;</span> <span class="mi">20</span> <span class="o">&amp;</span> <span class="mi">9</span><span class="p">):</span>
</span><span id="L-339"><a href="#L-339"><span class="linenos">339</span></a>                <span class="k">if</span> <span class="n">instrInt</span> <span class="o">&gt;&gt;</span> <span class="mi">18</span> <span class="o">&amp;</span> <span class="mi">9</span> <span class="o">==</span> <span class="mi">9</span><span class="p">:</span>
</span><span id="L-340"><a href="#L-340"><span class="linenos">340</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">currentInstr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoders</span><span class="p">[</span><span class="s2">&quot;BranchOp&quot;</span><span class="p">]</span>
</span><span id="L-341"><a href="#L-341"><span class="linenos">341</span></a>                <span class="k">elif</span> <span class="n">instrInt</span> <span class="o">&gt;&gt;</span> <span class="mi">19</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-342"><a href="#L-342"><span class="linenos">342</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">currentInstr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoders</span><span class="p">[</span><span class="s2">&quot;PSROp&quot;</span><span class="p">]</span>
</span><span id="L-343"><a href="#L-343"><span class="linenos">343</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-344"><a href="#L-344"><span class="linenos">344</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">currentInstr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoders</span><span class="p">[</span><span class="s2">&quot;NopOp&quot;</span><span class="p">]</span>
</span><span id="L-345"><a href="#L-345"><span class="linenos">345</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-346"><a href="#L-346"><span class="linenos">346</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">currentInstr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoders</span><span class="p">[</span><span class="s2">&quot;DataOp&quot;</span><span class="p">]</span>
</span><span id="L-347"><a href="#L-347"><span class="linenos">347</span></a>        <span class="k">elif</span> <span class="n">instrInt</span> <span class="o">&gt;&gt;</span> <span class="mi">26</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-348"><a href="#L-348"><span class="linenos">348</span></a>            <span class="k">if</span> <span class="n">instrInt</span> <span class="o">&gt;&gt;</span> <span class="mi">27</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-349"><a href="#L-349"><span class="linenos">349</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">currentInstr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoders</span><span class="p">[</span><span class="s2">&quot;SoftInterruptOp&quot;</span><span class="p">]</span>
</span><span id="L-350"><a href="#L-350"><span class="linenos">350</span></a>            <span class="k">else</span><span class="p">:</span>  <span class="c1"># Could also check for [4], which is an undefined space in the instruction set</span>
</span><span id="L-351"><a href="#L-351"><span class="linenos">351</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">currentInstr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoders</span><span class="p">[</span><span class="s2">&quot;MemOp&quot;</span><span class="p">]</span>
</span><span id="L-352"><a href="#L-352"><span class="linenos">352</span></a>        <span class="k">elif</span> <span class="n">instrInt</span> <span class="o">&gt;&gt;</span> <span class="mi">25</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-353"><a href="#L-353"><span class="linenos">353</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">currentInstr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoders</span><span class="p">[</span><span class="s2">&quot;BranchOp&quot;</span><span class="p">]</span>
</span><span id="L-354"><a href="#L-354"><span class="linenos">354</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-355"><a href="#L-355"><span class="linenos">355</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">currentInstr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoders</span><span class="p">[</span><span class="s2">&quot;MultipleMemOp&quot;</span><span class="p">]</span>
</span><span id="L-356"><a href="#L-356"><span class="linenos">356</span></a>
</span><span id="L-357"><a href="#L-357"><span class="linenos">357</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentInstr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-358"><a href="#L-358"><span class="linenos">358</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">currentInstr</span><span class="o">.</span><span class="n">setBytecode</span><span class="p">(</span><span class="n">instrInt</span><span class="p">)</span>
</span><span id="L-359"><a href="#L-359"><span class="linenos">359</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="L-360"><a href="#L-360"><span class="linenos">360</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">currentInstr</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
</span><span id="L-361"><a href="#L-361"><span class="linenos">361</span></a>                <span class="c1"># Once decoded, we add the instruction to the cache</span>
</span><span id="L-362"><a href="#L-362"><span class="linenos">362</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">decoderCache</span><span class="p">[</span><span class="n">instrInt</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-363"><a href="#L-363"><span class="linenos">363</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">currentInstr</span><span class="p">,</span>
</span><span id="L-364"><a href="#L-364"><span class="linenos">364</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">currentInstr</span><span class="o">.</span><span class="n">saveState</span><span class="p">(),</span>
</span><span id="L-365"><a href="#L-365"><span class="linenos">365</span></a>                <span class="p">)</span>
</span><span id="L-366"><a href="#L-366"><span class="linenos">366</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">decoderCache</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2000</span><span class="p">:</span>
</span><span id="L-367"><a href="#L-367"><span class="linenos">367</span></a>                    <span class="c1"># Fail-safe, we should never get there with programs &lt; 2000 lines, but just in case,</span>
</span><span id="L-368"><a href="#L-368"><span class="linenos">368</span></a>                    <span class="c1"># we do not want to bust the RAM with our cache</span>
</span><span id="L-369"><a href="#L-369"><span class="linenos">369</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">decoderCache</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-370"><a href="#L-370"><span class="linenos">370</span></a>            <span class="k">except</span> <span class="n">ExecutionException</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
</span><span id="L-371"><a href="#L-371"><span class="linenos">371</span></a>                <span class="c1"># Invalid instruction</span>
</span><span id="L-372"><a href="#L-372"><span class="linenos">372</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">currentInstr</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-373"><a href="#L-373"><span class="linenos">373</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">errorsPending</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;execution&quot;</span><span class="p">,</span> <span class="n">err</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
</span><span id="L-374"><a href="#L-374"><span class="linenos">374</span></a>
</span><span id="L-375"><a href="#L-375"><span class="linenos">375</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">explainInstruction</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-376"><a href="#L-376"><span class="linenos">376</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentInstr</span><span class="p">:</span>
</span><span id="L-377"><a href="#L-377"><span class="linenos">377</span></a>            <span class="c1"># Undefined instruction</span>
</span><span id="L-378"><a href="#L-378"><span class="linenos">378</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">disassemblyInfo</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-379"><a href="#L-379"><span class="linenos">379</span></a>                <span class="p">[</span><span class="s2">&quot;highlightRead&quot;</span><span class="p">,</span> <span class="p">[]],</span>
</span><span id="L-380"><a href="#L-380"><span class="linenos">380</span></a>                <span class="p">[</span><span class="s2">&quot;highlightWrite&quot;</span><span class="p">,</span> <span class="p">[]],</span>
</span><span id="L-381"><a href="#L-381"><span class="linenos">381</span></a>                <span class="p">[</span><span class="s2">&quot;nextline&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span>
</span><span id="L-382"><a href="#L-382"><span class="linenos">382</span></a>                <span class="p">[</span><span class="s2">&quot;disassembly&quot;</span><span class="p">,</span> <span class="n">appState</span><span class="o">.</span><span class="n">getT</span><span class="p">(</span><span class="mi">1</span><span class="p">)],</span>
</span><span id="L-383"><a href="#L-383"><span class="linenos">383</span></a>            <span class="p">)</span>
</span><span id="L-384"><a href="#L-384"><span class="linenos">384</span></a>            <span class="k">return</span>
</span><span id="L-385"><a href="#L-385"><span class="linenos">385</span></a>
</span><span id="L-386"><a href="#L-386"><span class="linenos">386</span></a>        <span class="n">disassembly</span><span class="p">,</span> <span class="n">description</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentInstr</span><span class="o">.</span><span class="n">explain</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span id="L-387"><a href="#L-387"><span class="linenos">387</span></a>        <span class="n">dis</span> <span class="o">=</span> <span class="s1">&#39;&lt;div id=&quot;disassembly_instruction&quot;&gt;</span><span class="si">{}</span><span class="s1">: </span><span class="si">{}</span><span class="s1">&lt;/div&gt;</span><span class="se">\n</span><span class="s1">&lt;div id=&quot;disassembly_description&quot;&gt;</span><span class="si">{}</span><span class="s1">&lt;/div&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="L-388"><a href="#L-388"><span class="linenos">388</span></a>            <span class="n">appState</span><span class="o">.</span><span class="n">getT</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="p">,</span><span class="n">disassembly</span><span class="p">,</span> <span class="n">description</span>
</span><span id="L-389"><a href="#L-389"><span class="linenos">389</span></a>        <span class="p">)</span>
</span><span id="L-390"><a href="#L-390"><span class="linenos">390</span></a>
</span><span id="L-391"><a href="#L-391"><span class="linenos">391</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentInstr</span><span class="o">.</span><span class="n">nextAddressToExecute</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
</span><span id="L-392"><a href="#L-392"><span class="linenos">392</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">disassemblyInfo</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-393"><a href="#L-393"><span class="linenos">393</span></a>                <span class="p">[</span>
</span><span id="L-394"><a href="#L-394"><span class="linenos">394</span></a>                    <span class="s2">&quot;highlightRead&quot;</span><span class="p">,</span>
</span><span id="L-395"><a href="#L-395"><span class="linenos">395</span></a>                    <span class="nb">list</span><span class="p">(</span>
</span><span id="L-396"><a href="#L-396"><span class="linenos">396</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">currentInstr</span><span class="o">.</span><span class="n">affectedRegs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-397"><a href="#L-397"><span class="linenos">397</span></a>                        <span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentInstr</span><span class="o">.</span><span class="n">affectedMem</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-398"><a href="#L-398"><span class="linenos">398</span></a>                    <span class="p">),</span>
</span><span id="L-399"><a href="#L-399"><span class="linenos">399</span></a>                <span class="p">],</span>
</span><span id="L-400"><a href="#L-400"><span class="linenos">400</span></a>                <span class="p">[</span>
</span><span id="L-401"><a href="#L-401"><span class="linenos">401</span></a>                    <span class="s2">&quot;highlightWrite&quot;</span><span class="p">,</span>
</span><span id="L-402"><a href="#L-402"><span class="linenos">402</span></a>                    <span class="nb">list</span><span class="p">(</span>
</span><span id="L-403"><a href="#L-403"><span class="linenos">403</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">currentInstr</span><span class="o">.</span><span class="n">affectedRegs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-404"><a href="#L-404"><span class="linenos">404</span></a>                        <span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentInstr</span><span class="o">.</span><span class="n">affectedMem</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-405"><a href="#L-405"><span class="linenos">405</span></a>                    <span class="p">),</span>
</span><span id="L-406"><a href="#L-406"><span class="linenos">406</span></a>                <span class="p">],</span>
</span><span id="L-407"><a href="#L-407"><span class="linenos">407</span></a>                <span class="p">[</span><span class="s2">&quot;nextline&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentInstr</span><span class="o">.</span><span class="n">nextAddressToExecute</span><span class="p">],</span>
</span><span id="L-408"><a href="#L-408"><span class="linenos">408</span></a>                <span class="p">[</span><span class="s2">&quot;disassembly&quot;</span><span class="p">,</span> <span class="n">dis</span><span class="p">],</span>
</span><span id="L-409"><a href="#L-409"><span class="linenos">409</span></a>            <span class="p">)</span>
</span><span id="L-410"><a href="#L-410"><span class="linenos">410</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-411"><a href="#L-411"><span class="linenos">411</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">disassemblyInfo</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-412"><a href="#L-412"><span class="linenos">412</span></a>                <span class="p">[</span>
</span><span id="L-413"><a href="#L-413"><span class="linenos">413</span></a>                    <span class="s2">&quot;highlightRead&quot;</span><span class="p">,</span>
</span><span id="L-414"><a href="#L-414"><span class="linenos">414</span></a>                    <span class="nb">list</span><span class="p">(</span>
</span><span id="L-415"><a href="#L-415"><span class="linenos">415</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">currentInstr</span><span class="o">.</span><span class="n">affectedRegs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-416"><a href="#L-416"><span class="linenos">416</span></a>                        <span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentInstr</span><span class="o">.</span><span class="n">affectedMem</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-417"><a href="#L-417"><span class="linenos">417</span></a>                    <span class="p">),</span>
</span><span id="L-418"><a href="#L-418"><span class="linenos">418</span></a>                <span class="p">],</span>
</span><span id="L-419"><a href="#L-419"><span class="linenos">419</span></a>                <span class="p">[</span>
</span><span id="L-420"><a href="#L-420"><span class="linenos">420</span></a>                    <span class="s2">&quot;highlightWrite&quot;</span><span class="p">,</span>
</span><span id="L-421"><a href="#L-421"><span class="linenos">421</span></a>                    <span class="nb">list</span><span class="p">(</span>
</span><span id="L-422"><a href="#L-422"><span class="linenos">422</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">currentInstr</span><span class="o">.</span><span class="n">affectedRegs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-423"><a href="#L-423"><span class="linenos">423</span></a>                        <span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentInstr</span><span class="o">.</span><span class="n">affectedMem</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-424"><a href="#L-424"><span class="linenos">424</span></a>                    <span class="p">),</span>
</span><span id="L-425"><a href="#L-425"><span class="linenos">425</span></a>                <span class="p">],</span>
</span><span id="L-426"><a href="#L-426"><span class="linenos">426</span></a>                <span class="p">[</span><span class="s2">&quot;disassembly&quot;</span><span class="p">,</span> <span class="n">dis</span><span class="p">],</span>
</span><span id="L-427"><a href="#L-427"><span class="linenos">427</span></a>            <span class="p">)</span>
</span><span id="L-428"><a href="#L-428"><span class="linenos">428</span></a>
</span><span id="L-429"><a href="#L-429"><span class="linenos">429</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">execAssert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">assertionsList</span><span class="p">,</span> <span class="n">mode</span><span class="p">):</span>
</span><span id="L-430"><a href="#L-430"><span class="linenos">430</span></a>        <span class="k">for</span> <span class="n">assertionInfo</span> <span class="ow">in</span> <span class="n">assertionsList</span><span class="p">:</span>
</span><span id="L-431"><a href="#L-431"><span class="linenos">431</span></a>            <span class="n">assertionType</span> <span class="o">=</span> <span class="n">assertionInfo</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-432"><a href="#L-432"><span class="linenos">432</span></a>            <span class="k">if</span> <span class="n">assertionType</span> <span class="o">!=</span> <span class="n">mode</span><span class="p">:</span>
</span><span id="L-433"><a href="#L-433"><span class="linenos">433</span></a>                <span class="k">continue</span>
</span><span id="L-434"><a href="#L-434"><span class="linenos">434</span></a>            <span class="n">assertionLine</span> <span class="o">=</span> <span class="n">assertionInfo</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-435"><a href="#L-435"><span class="linenos">435</span></a>            <span class="n">assertionInfo</span> <span class="o">=</span> <span class="n">assertionInfo</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
</span><span id="L-436"><a href="#L-436"><span class="linenos">436</span></a>
</span><span id="L-437"><a href="#L-437"><span class="linenos">437</span></a>            <span class="n">strError</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span id="L-438"><a href="#L-438"><span class="linenos">438</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="L-439"><a href="#L-439"><span class="linenos">439</span></a>                <span class="k">for</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">assertionInfo</span><span class="p">:</span>
</span><span id="L-440"><a href="#L-440"><span class="linenos">440</span></a>                    <span class="n">info</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span><span id="L-441"><a href="#L-441"><span class="linenos">441</span></a>                    <span class="k">if</span> <span class="s2">&quot;=&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">info</span><span class="p">:</span>
</span><span id="L-442"><a href="#L-442"><span class="linenos">442</span></a>                        <span class="c1"># Bad syntax, we skip</span>
</span><span id="L-443"><a href="#L-443"><span class="linenos">443</span></a>                        <span class="k">continue</span>
</span><span id="L-444"><a href="#L-444"><span class="linenos">444</span></a>                    <span class="n">target</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">)</span>
</span><span id="L-445"><a href="#L-445"><span class="linenos">445</span></a>
</span><span id="L-446"><a href="#L-446"><span class="linenos">446</span></a>                    <span class="c1"># The rest of the code assume that a register is encoded</span>
</span><span id="L-447"><a href="#L-447"><span class="linenos">447</span></a>                    <span class="c1"># as R**, so we convert the alternative names</span>
</span><span id="L-448"><a href="#L-448"><span class="linenos">448</span></a>                    <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;SP&quot;</span><span class="p">,</span> <span class="s2">&quot;LR&quot;</span><span class="p">,</span> <span class="s2">&quot;PC&quot;</span><span class="p">):</span>
</span><span id="L-449"><a href="#L-449"><span class="linenos">449</span></a>                        <span class="n">value</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;SP&quot;</span><span class="p">:</span> <span class="s2">&quot;R13&quot;</span><span class="p">,</span> <span class="s2">&quot;LR&quot;</span><span class="p">:</span> <span class="s2">&quot;R14&quot;</span><span class="p">,</span> <span class="s2">&quot;PC&quot;</span><span class="p">:</span> <span class="s2">&quot;R15&quot;</span><span class="p">}[</span><span class="n">value</span><span class="p">]</span>
</span><span id="L-450"><a href="#L-450"><span class="linenos">450</span></a>                    <span class="k">if</span> <span class="n">target</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;SP&quot;</span><span class="p">,</span> <span class="s2">&quot;LR&quot;</span><span class="p">,</span> <span class="s2">&quot;PC&quot;</span><span class="p">):</span>
</span><span id="L-451"><a href="#L-451"><span class="linenos">451</span></a>                        <span class="n">target</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;SP&quot;</span><span class="p">:</span> <span class="s2">&quot;R13&quot;</span><span class="p">,</span> <span class="s2">&quot;LR&quot;</span><span class="p">:</span> <span class="s2">&quot;R14&quot;</span><span class="p">,</span> <span class="s2">&quot;PC&quot;</span><span class="p">:</span> <span class="s2">&quot;R15&quot;</span><span class="p">}[</span><span class="n">target</span><span class="p">]</span>
</span><span id="L-452"><a href="#L-452"><span class="linenos">452</span></a>
</span><span id="L-453"><a href="#L-453"><span class="linenos">453</span></a>                    <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">strip</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;R&quot;</span><span class="p">:</span>
</span><span id="L-454"><a href="#L-454"><span class="linenos">454</span></a>                        <span class="c1"># The target is another register</span>
</span><span id="L-455"><a href="#L-455"><span class="linenos">455</span></a>                        <span class="n">regtarget</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
</span><span id="L-456"><a href="#L-456"><span class="linenos">456</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">regs</span><span class="o">.</span><span class="n">deactivateBreakpoints</span><span class="p">()</span>
</span><span id="L-457"><a href="#L-457"><span class="linenos">457</span></a>                        <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">regs</span><span class="p">[</span><span class="n">regtarget</span><span class="p">]</span>
</span><span id="L-458"><a href="#L-458"><span class="linenos">458</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">regs</span><span class="o">.</span><span class="n">reactivateBreakpoints</span><span class="p">()</span>
</span><span id="L-459"><a href="#L-459"><span class="linenos">459</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="L-460"><a href="#L-460"><span class="linenos">460</span></a>                        <span class="c1"># The target is a constant</span>
</span><span id="L-461"><a href="#L-461"><span class="linenos">461</span></a>                        <span class="n">regtarget</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-462"><a href="#L-462"><span class="linenos">462</span></a>                        <span class="k">try</span><span class="p">:</span>
</span><span id="L-463"><a href="#L-463"><span class="linenos">463</span></a>                            <span class="n">val</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">base</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFF</span>
</span><span id="L-464"><a href="#L-464"><span class="linenos">464</span></a>                        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
</span><span id="L-465"><a href="#L-465"><span class="linenos">465</span></a>                            <span class="c1"># If this is a decimal with leading zeros, base=0 will crash</span>
</span><span id="L-466"><a href="#L-466"><span class="linenos">466</span></a>                            <span class="n">val</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">base</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFF</span>
</span><span id="L-467"><a href="#L-467"><span class="linenos">467</span></a>
</span><span id="L-468"><a href="#L-468"><span class="linenos">468</span></a>                    <span class="k">if</span> <span class="n">target</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;R&quot;</span><span class="p">:</span>
</span><span id="L-469"><a href="#L-469"><span class="linenos">469</span></a>                        <span class="c1"># Register</span>
</span><span id="L-470"><a href="#L-470"><span class="linenos">470</span></a>                        <span class="n">reg</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">target</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
</span><span id="L-471"><a href="#L-471"><span class="linenos">471</span></a>
</span><span id="L-472"><a href="#L-472"><span class="linenos">472</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">regs</span><span class="o">.</span><span class="n">deactivateBreakpoints</span><span class="p">()</span>
</span><span id="L-473"><a href="#L-473"><span class="linenos">473</span></a>                        <span class="n">valreg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">regs</span><span class="p">[</span><span class="n">reg</span><span class="p">]</span>
</span><span id="L-474"><a href="#L-474"><span class="linenos">474</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">regs</span><span class="o">.</span><span class="n">reactivateBreakpoints</span><span class="p">()</span>
</span><span id="L-475"><a href="#L-475"><span class="linenos">475</span></a>                        <span class="k">if</span> <span class="n">valreg</span> <span class="o">!=</span> <span class="n">val</span><span class="p">:</span>
</span><span id="L-476"><a href="#L-476"><span class="linenos">476</span></a>                            <span class="k">if</span> <span class="n">regtarget</span><span class="p">:</span>
</span><span id="L-477"><a href="#L-477"><span class="linenos">477</span></a>                                <span class="n">strError</span> <span class="o">+=</span> <span class="n">appState</span><span class="o">.</span><span class="n">getT</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="L-478"><a href="#L-478"><span class="linenos">478</span></a>                                    <span class="n">target</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">regtarget</span><span class="p">,</span> <span class="n">valreg</span>
</span><span id="L-479"><a href="#L-479"><span class="linenos">479</span></a>                                <span class="p">)</span>
</span><span id="L-480"><a href="#L-480"><span class="linenos">480</span></a>                            <span class="k">else</span><span class="p">:</span>
</span><span id="L-481"><a href="#L-481"><span class="linenos">481</span></a>                                <span class="n">strError</span> <span class="o">+=</span> <span class="n">appState</span><span class="o">.</span><span class="n">getT</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="L-482"><a href="#L-482"><span class="linenos">482</span></a>                                    <span class="n">target</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">valreg</span>
</span><span id="L-483"><a href="#L-483"><span class="linenos">483</span></a>                                <span class="p">)</span>
</span><span id="L-484"><a href="#L-484"><span class="linenos">484</span></a>                    <span class="k">elif</span> <span class="n">target</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;0X&quot;</span><span class="p">:</span>
</span><span id="L-485"><a href="#L-485"><span class="linenos">485</span></a>                        <span class="c1"># Memory</span>
</span><span id="L-486"><a href="#L-486"><span class="linenos">486</span></a>                        <span class="n">addr</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">base</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
</span><span id="L-487"><a href="#L-487"><span class="linenos">487</span></a>
</span><span id="L-488"><a href="#L-488"><span class="linenos">488</span></a>                        <span class="n">formatStruct</span> <span class="o">=</span> <span class="s2">&quot;&lt;B&quot;</span>
</span><span id="L-489"><a href="#L-489"><span class="linenos">489</span></a>                        <span class="k">if</span> <span class="ow">not</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="nb">int</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">255</span><span class="p">:</span>
</span><span id="L-490"><a href="#L-490"><span class="linenos">490</span></a>                            <span class="n">val</span> <span class="o">&amp;=</span> <span class="mh">0xFFFFFFFF</span>
</span><span id="L-491"><a href="#L-491"><span class="linenos">491</span></a>                            <span class="n">formatStruct</span> <span class="o">=</span> <span class="s2">&quot;&lt;I&quot;</span>
</span><span id="L-492"><a href="#L-492"><span class="linenos">492</span></a>                        <span class="n">valmem</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mem</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
</span><span id="L-493"><a href="#L-493"><span class="linenos">493</span></a>                            <span class="n">addr</span><span class="p">,</span>
</span><span id="L-494"><a href="#L-494"><span class="linenos">494</span></a>                            <span class="n">mayTriggerBkpt</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-495"><a href="#L-495"><span class="linenos">495</span></a>                            <span class="n">size</span><span class="o">=</span><span class="mi">4</span> <span class="k">if</span> <span class="n">formatStruct</span> <span class="o">==</span> <span class="s2">&quot;&lt;I&quot;</span> <span class="k">else</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="L-496"><a href="#L-496"><span class="linenos">496</span></a>                        <span class="p">)</span>
</span><span id="L-497"><a href="#L-497"><span class="linenos">497</span></a>                        <span class="n">valmem</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">formatStruct</span><span class="p">,</span> <span class="n">valmem</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-498"><a href="#L-498"><span class="linenos">498</span></a>                        <span class="k">if</span> <span class="n">valmem</span> <span class="o">!=</span> <span class="n">val</span><span class="p">:</span>
</span><span id="L-499"><a href="#L-499"><span class="linenos">499</span></a>                            <span class="k">if</span> <span class="n">regtarget</span><span class="p">:</span>
</span><span id="L-500"><a href="#L-500"><span class="linenos">500</span></a>                                <span class="n">strError</span> <span class="o">+=</span> <span class="n">appState</span><span class="o">.</span><span class="n">getT</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="L-501"><a href="#L-501"><span class="linenos">501</span></a>                                    <span class="n">target</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">regtarget</span><span class="p">,</span> <span class="n">valmem</span>
</span><span id="L-502"><a href="#L-502"><span class="linenos">502</span></a>                                <span class="p">)</span>
</span><span id="L-503"><a href="#L-503"><span class="linenos">503</span></a>                            <span class="k">else</span><span class="p">:</span>
</span><span id="L-504"><a href="#L-504"><span class="linenos">504</span></a>                                <span class="n">strError</span> <span class="o">+=</span> <span class="n">appState</span><span class="o">.</span><span class="n">getT</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="L-505"><a href="#L-505"><span class="linenos">505</span></a>                                    <span class="n">target</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">valmem</span>
</span><span id="L-506"><a href="#L-506"><span class="linenos">506</span></a>                                <span class="p">)</span>
</span><span id="L-507"><a href="#L-507"><span class="linenos">507</span></a>                    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">target</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">target</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">regs</span><span class="o">.</span><span class="n">flag2index</span><span class="p">:</span>
</span><span id="L-508"><a href="#L-508"><span class="linenos">508</span></a>                        <span class="c1"># Flag</span>
</span><span id="L-509"><a href="#L-509"><span class="linenos">509</span></a>                        <span class="n">expectedVal</span> <span class="o">=</span> <span class="n">value</span> <span class="o">!=</span> <span class="s2">&quot;0&quot;</span>
</span><span id="L-510"><a href="#L-510"><span class="linenos">510</span></a>                        <span class="n">actualVal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">regs</span><span class="o">.</span><span class="fm">__getattribute__</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
</span><span id="L-511"><a href="#L-511"><span class="linenos">511</span></a>                        <span class="k">if</span> <span class="n">actualVal</span> <span class="o">!=</span> <span class="n">expectedVal</span><span class="p">:</span>
</span><span id="L-512"><a href="#L-512"><span class="linenos">512</span></a>                            <span class="n">strError</span> <span class="o">+=</span> <span class="n">appState</span><span class="o">.</span><span class="n">getT</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="L-513"><a href="#L-513"><span class="linenos">513</span></a>                                <span class="n">target</span><span class="p">,</span> <span class="n">expectedVal</span><span class="p">,</span> <span class="n">actualVal</span>
</span><span id="L-514"><a href="#L-514"><span class="linenos">514</span></a>                            <span class="p">)</span>
</span><span id="L-515"><a href="#L-515"><span class="linenos">515</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="L-516"><a href="#L-516"><span class="linenos">516</span></a>                        <span class="c1"># Assert type unknown</span>
</span><span id="L-517"><a href="#L-517"><span class="linenos">517</span></a>                        <span class="n">strError</span> <span class="o">+=</span> <span class="n">appState</span><span class="o">.</span><span class="n">getT</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="L-518"><a href="#L-518"><span class="linenos">518</span></a>                            <span class="n">target</span><span class="p">,</span> <span class="n">value</span>
</span><span id="L-519"><a href="#L-519"><span class="linenos">519</span></a>                        <span class="p">)</span>
</span><span id="L-520"><a href="#L-520"><span class="linenos">520</span></a>
</span><span id="L-521"><a href="#L-521"><span class="linenos">521</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">strError</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-522"><a href="#L-522"><span class="linenos">522</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">errorsPending</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;assert&quot;</span><span class="p">,</span> <span class="n">strError</span><span class="p">,</span> <span class="n">assertionLine</span><span class="p">)</span>
</span><span id="L-523"><a href="#L-523"><span class="linenos">523</span></a>
</span><span id="L-524"><a href="#L-524"><span class="linenos">524</span></a>            <span class="k">except</span> <span class="n">ComponentException</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
</span><span id="L-525"><a href="#L-525"><span class="linenos">525</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">errorsPending</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ex</span><span class="o">.</span><span class="n">cmp</span><span class="p">,</span> <span class="n">ex</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="n">assertionLine</span><span class="p">)</span>
</span><span id="L-526"><a href="#L-526"><span class="linenos">526</span></a>
</span><span id="L-527"><a href="#L-527"><span class="linenos">527</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">nextInstr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">forceExplain</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="L-528"><a href="#L-528"><span class="linenos">528</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentInstr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-529"><a href="#L-529"><span class="linenos">529</span></a>            <span class="c1"># The current instruction has not be retrieved or decoded (because it was an illegal access)</span>
</span><span id="L-530"><a href="#L-530"><span class="linenos">530</span></a>            <span class="c1"># We raise the last error to explain the illegal access</span>
</span><span id="L-531"><a href="#L-531"><span class="linenos">531</span></a>            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">errorsPending</span>
</span><span id="L-532"><a href="#L-532"><span class="linenos">532</span></a>
</span><span id="L-533"><a href="#L-533"><span class="linenos">533</span></a>        <span class="n">isFirstInst</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">runIteration</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">cyclesCount</span>
</span><span id="L-534"><a href="#L-534"><span class="linenos">534</span></a>        <span class="c1"># One more cycle to do!</span>
</span><span id="L-535"><a href="#L-535"><span class="linenos">535</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">newCycle</span><span class="p">()</span>
</span><span id="L-536"><a href="#L-536"><span class="linenos">536</span></a>        <span class="c1"># Clear previous errors</span>
</span><span id="L-537"><a href="#L-537"><span class="linenos">537</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">errorsPending</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
</span><span id="L-538"><a href="#L-538"><span class="linenos">538</span></a>
</span><span id="L-539"><a href="#L-539"><span class="linenos">539</span></a>        <span class="n">keeppc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">regs</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">pcoffset</span>
</span><span id="L-540"><a href="#L-540"><span class="linenos">540</span></a>
</span><span id="L-541"><a href="#L-541"><span class="linenos">541</span></a>        <span class="n">currentCallStackLen</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">callStack</span><span class="p">)</span>
</span><span id="L-542"><a href="#L-542"><span class="linenos">542</span></a>
</span><span id="L-543"><a href="#L-543"><span class="linenos">543</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stepMode</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;out&quot;</span><span class="p">,</span> <span class="s2">&quot;run&quot;</span><span class="p">,</span> <span class="s2">&quot;forward&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">isFirstInst</span><span class="p">:</span>
</span><span id="L-544"><a href="#L-544"><span class="linenos">544</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bkptLastFetch</span><span class="p">:</span>
</span><span id="L-545"><a href="#L-545"><span class="linenos">545</span></a>                <span class="c1"># We hit a breakpoint on the last decoded instruction</span>
</span><span id="L-546"><a href="#L-546"><span class="linenos">546</span></a>                <span class="n">err</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bkptLastFetch</span>
</span><span id="L-547"><a href="#L-547"><span class="linenos">547</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">bkptLastFetch</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-548"><a href="#L-548"><span class="linenos">548</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">restartCycle</span><span class="p">()</span>
</span><span id="L-549"><a href="#L-549"><span class="linenos">549</span></a>                <span class="k">raise</span> <span class="n">err</span>
</span><span id="L-550"><a href="#L-550"><span class="linenos">550</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="L-551"><a href="#L-551"><span class="linenos">551</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">currentInstr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span id="L-552"><a href="#L-552"><span class="linenos">552</span></a>            <span class="k">except</span> <span class="n">Breakpoint</span> <span class="k">as</span> <span class="n">bp</span><span class="p">:</span>
</span><span id="L-553"><a href="#L-553"><span class="linenos">553</span></a>                <span class="c1"># We hit a breakpoint on READ/WRITE</span>
</span><span id="L-554"><a href="#L-554"><span class="linenos">554</span></a>                <span class="c1"># We temporary disable the raised breakpoint</span>
</span><span id="L-555"><a href="#L-555"><span class="linenos">555</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">deactivatedBkpts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span>
</span><span id="L-556"><a href="#L-556"><span class="linenos">556</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_toggleBreakpoint</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span>
</span><span id="L-557"><a href="#L-557"><span class="linenos">557</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">restartCycle</span><span class="p">()</span>
</span><span id="L-558"><a href="#L-558"><span class="linenos">558</span></a>                <span class="k">raise</span> <span class="n">bp</span>
</span><span id="L-559"><a href="#L-559"><span class="linenos">559</span></a>            <span class="k">except</span> <span class="n">ComponentException</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
</span><span id="L-560"><a href="#L-560"><span class="linenos">560</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">errorsPending</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">err</span><span class="o">.</span><span class="n">cmp</span><span class="p">,</span> <span class="n">err</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">getCurrentLine</span><span class="p">())</span>
</span><span id="L-561"><a href="#L-561"><span class="linenos">561</span></a>            <span class="k">except</span> <span class="n">ExecutionException</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
</span><span id="L-562"><a href="#L-562"><span class="linenos">562</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">errorsPending</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;execution&quot;</span><span class="p">,</span> <span class="n">err</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">getCurrentLine</span><span class="p">())</span>
</span><span id="L-563"><a href="#L-563"><span class="linenos">563</span></a>
</span><span id="L-564"><a href="#L-564"><span class="linenos">564</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-565"><a href="#L-565"><span class="linenos">565</span></a>            <span class="c1"># In stepIn mode or this is the first step to be execute in this mode.</span>
</span><span id="L-566"><a href="#L-566"><span class="linenos">566</span></a>            <span class="c1"># Breakpoints are temporary deactivate</span>
</span><span id="L-567"><a href="#L-567"><span class="linenos">567</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="L-568"><a href="#L-568"><span class="linenos">568</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">deactivateAllBreakpoints</span><span class="p">()</span>
</span><span id="L-569"><a href="#L-569"><span class="linenos">569</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">currentInstr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span id="L-570"><a href="#L-570"><span class="linenos">570</span></a>            <span class="k">except</span> <span class="n">ComponentException</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
</span><span id="L-571"><a href="#L-571"><span class="linenos">571</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">errorsPending</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">err</span><span class="o">.</span><span class="n">cmp</span><span class="p">,</span> <span class="n">err</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">getCurrentLine</span><span class="p">())</span>
</span><span id="L-572"><a href="#L-572"><span class="linenos">572</span></a>            <span class="k">except</span> <span class="n">ExecutionException</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
</span><span id="L-573"><a href="#L-573"><span class="linenos">573</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">errorsPending</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;execution&quot;</span><span class="p">,</span> <span class="n">err</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">getCurrentLine</span><span class="p">())</span>
</span><span id="L-574"><a href="#L-574"><span class="linenos">574</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">reactivateAllBreakpoints</span><span class="p">()</span>
</span><span id="L-575"><a href="#L-575"><span class="linenos">575</span></a>
</span><span id="L-576"><a href="#L-576"><span class="linenos">576</span></a>        <span class="c1"># After instruction execution, restore all breakpoints</span>
</span><span id="L-577"><a href="#L-577"><span class="linenos">577</span></a>        <span class="k">for</span> <span class="n">bp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">deactivatedBkpts</span><span class="p">:</span>
</span><span id="L-578"><a href="#L-578"><span class="linenos">578</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_toggleBreakpoint</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span>
</span><span id="L-579"><a href="#L-579"><span class="linenos">579</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">deactivatedBkpts</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-580"><a href="#L-580"><span class="linenos">580</span></a>
</span><span id="L-581"><a href="#L-581"><span class="linenos">581</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentInstr</span><span class="o">.</span><span class="n">pcmodified</span><span class="p">:</span>
</span><span id="L-582"><a href="#L-582"><span class="linenos">582</span></a>            <span class="c1"># If PC was modified, we simulate the prefetch by adding 8 immediately to it</span>
</span><span id="L-583"><a href="#L-583"><span class="linenos">583</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">regs</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pcoffset</span>
</span><span id="L-584"><a href="#L-584"><span class="linenos">584</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-585"><a href="#L-585"><span class="linenos">585</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">regs</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">4</span>  <span class="c1"># PC = PC + 4</span>
</span><span id="L-586"><a href="#L-586"><span class="linenos">586</span></a>
</span><span id="L-587"><a href="#L-587"><span class="linenos">587</span></a>        <span class="n">newpc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">regs</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">pcoffset</span>
</span><span id="L-588"><a href="#L-588"><span class="linenos">588</span></a>        <span class="k">if</span> <span class="n">keeppc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertionCkpts</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentInstr</span><span class="o">.</span><span class="n">pcmodified</span><span class="p">:</span>
</span><span id="L-589"><a href="#L-589"><span class="linenos">589</span></a>            <span class="c1"># We check if we&#39;ve hit an post-assertion checkpoint</span>
</span><span id="L-590"><a href="#L-590"><span class="linenos">590</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">execAssert</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">assertionData</span><span class="p">[</span><span class="n">keeppc</span><span class="p">],</span> <span class="s2">&quot;AFTER&quot;</span><span class="p">)</span>
</span><span id="L-591"><a href="#L-591"><span class="linenos">591</span></a>        <span class="k">elif</span> <span class="n">currentCallStackLen</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">callStack</span><span class="p">):</span>
</span><span id="L-592"><a href="#L-592"><span class="linenos">592</span></a>            <span class="c1"># We have branched out of a function</span>
</span><span id="L-593"><a href="#L-593"><span class="linenos">593</span></a>            <span class="c1"># If an assertion was following a BL and we exited a function, we want to execute it now!</span>
</span><span id="L-594"><a href="#L-594"><span class="linenos">594</span></a>            <span class="k">if</span> <span class="p">(</span>
</span><span id="L-595"><a href="#L-595"><span class="linenos">595</span></a>                <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">callStack</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertionWhenReturn</span>
</span><span id="L-596"><a href="#L-596"><span class="linenos">596</span></a>                <span class="ow">and</span> <span class="p">(</span><span class="n">newpc</span> <span class="o">-</span> <span class="mi">4</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertionCkpts</span>
</span><span id="L-597"><a href="#L-597"><span class="linenos">597</span></a>            <span class="p">):</span>
</span><span id="L-598"><a href="#L-598"><span class="linenos">598</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">execAssert</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">assertionData</span><span class="p">[</span><span class="n">newpc</span> <span class="o">-</span> <span class="mi">4</span><span class="p">],</span> <span class="s2">&quot;AFTER&quot;</span><span class="p">)</span>
</span><span id="L-599"><a href="#L-599"><span class="linenos">599</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">assertionWhenReturn</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">callStack</span><span class="p">))</span>
</span><span id="L-600"><a href="#L-600"><span class="linenos">600</span></a>        <span class="k">elif</span> <span class="n">currentCallStackLen</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">callStack</span><span class="p">):</span>
</span><span id="L-601"><a href="#L-601"><span class="linenos">601</span></a>            <span class="c1"># We have branched in a function</span>
</span><span id="L-602"><a href="#L-602"><span class="linenos">602</span></a>            <span class="c1"># We want to remember that we want to assert something when we return</span>
</span><span id="L-603"><a href="#L-603"><span class="linenos">603</span></a>            <span class="k">if</span> <span class="n">keeppc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertionCkpts</span><span class="p">:</span>
</span><span id="L-604"><a href="#L-604"><span class="linenos">604</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">assertionWhenReturn</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">currentCallStackLen</span><span class="p">)</span>
</span><span id="L-605"><a href="#L-605"><span class="linenos">605</span></a>
</span><span id="L-606"><a href="#L-606"><span class="linenos">606</span></a>        <span class="k">if</span> <span class="n">newpc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertionCkpts</span><span class="p">:</span>
</span><span id="L-607"><a href="#L-607"><span class="linenos">607</span></a>            <span class="c1"># We check if we&#39;ve hit an pre-assertion checkpoint (for the next instruction)</span>
</span><span id="L-608"><a href="#L-608"><span class="linenos">608</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">execAssert</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">assertionData</span><span class="p">[</span><span class="n">newpc</span><span class="p">],</span> <span class="s2">&quot;BEFORE&quot;</span><span class="p">)</span>
</span><span id="L-609"><a href="#L-609"><span class="linenos">609</span></a>
</span><span id="L-610"><a href="#L-610"><span class="linenos">610</span></a>        <span class="c1"># We look for interrupts</span>
</span><span id="L-611"><a href="#L-611"><span class="linenos">611</span></a>        <span class="c1"># The current instruction is always finished before the interrupt takes on</span>
</span><span id="L-612"><a href="#L-612"><span class="linenos">612</span></a>        <span class="c1"># TODO Handle special cases for LDM and STM</span>
</span><span id="L-613"><a href="#L-613"><span class="linenos">613</span></a>        <span class="k">if</span> <span class="p">(</span>
</span><span id="L-614"><a href="#L-614"><span class="linenos">614</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">interruptActive</span>
</span><span id="L-615"><a href="#L-615"><span class="linenos">615</span></a>            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">cyclesCount</span>
</span><span id="L-616"><a href="#L-616"><span class="linenos">616</span></a>            <span class="o">&gt;=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">interruptParams</span><span class="p">[</span><span class="s2">&quot;t0&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">interruptParams</span><span class="p">[</span><span class="s2">&quot;b&quot;</span><span class="p">])</span>
</span><span id="L-617"><a href="#L-617"><span class="linenos">617</span></a>            <span class="ow">and</span> <span class="p">(</span>
</span><span id="L-618"><a href="#L-618"><span class="linenos">618</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">cyclesCount</span>
</span><span id="L-619"><a href="#L-619"><span class="linenos">619</span></a>                <span class="o">-</span> <span class="mi">1</span>
</span><span id="L-620"><a href="#L-620"><span class="linenos">620</span></a>                <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">interruptParams</span><span class="p">[</span><span class="s2">&quot;t0&quot;</span><span class="p">]</span>
</span><span id="L-621"><a href="#L-621"><span class="linenos">621</span></a>                <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">interruptParams</span><span class="p">[</span><span class="s2">&quot;b&quot;</span><span class="p">]</span>
</span><span id="L-622"><a href="#L-622"><span class="linenos">622</span></a>            <span class="p">)</span>
</span><span id="L-623"><a href="#L-623"><span class="linenos">623</span></a>            <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">interruptParams</span><span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">]</span>
</span><span id="L-624"><a href="#L-624"><span class="linenos">624</span></a>            <span class="o">==</span> <span class="mi">0</span>
</span><span id="L-625"><a href="#L-625"><span class="linenos">625</span></a>        <span class="p">):</span>
</span><span id="L-626"><a href="#L-626"><span class="linenos">626</span></a>            <span class="k">if</span> <span class="p">(</span>
</span><span id="L-627"><a href="#L-627"><span class="linenos">627</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">interruptParams</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;FIQ&quot;</span>
</span><span id="L-628"><a href="#L-628"><span class="linenos">628</span></a>                <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">regs</span><span class="o">.</span><span class="n">FIQ</span>
</span><span id="L-629"><a href="#L-629"><span class="linenos">629</span></a>                <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">interruptParams</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;IRQ&quot;</span>
</span><span id="L-630"><a href="#L-630"><span class="linenos">630</span></a>                <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">regs</span><span class="o">.</span><span class="n">IRQ</span>
</span><span id="L-631"><a href="#L-631"><span class="linenos">631</span></a>                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">regs</span><span class="o">.</span><span class="n">mode</span> <span class="o">!=</span> <span class="s2">&quot;FIQ&quot;</span>
</span><span id="L-632"><a href="#L-632"><span class="linenos">632</span></a>            <span class="p">):</span>  <span class="c1"># Is the interrupt masked?</span>
</span><span id="L-633"><a href="#L-633"><span class="linenos">633</span></a>                <span class="c1"># Interruption!</span>
</span><span id="L-634"><a href="#L-634"><span class="linenos">634</span></a>                <span class="c1"># We enter it (the entry point is 0x18 for IRQ and 0x1C for FIQ)</span>
</span><span id="L-635"><a href="#L-635"><span class="linenos">635</span></a>                <span class="n">savedCPSR</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">regs</span><span class="o">.</span><span class="n">CPSR</span>  <span class="c1"># Keep CPSR before changing processor mode</span>
</span><span id="L-636"><a href="#L-636"><span class="linenos">636</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">regs</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interruptParams</span><span class="p">[</span>
</span><span id="L-637"><a href="#L-637"><span class="linenos">637</span></a>                    <span class="s2">&quot;type&quot;</span>
</span><span id="L-638"><a href="#L-638"><span class="linenos">638</span></a>                <span class="p">]</span>  <span class="c1"># Set the register bank and processor mode</span>
</span><span id="L-639"><a href="#L-639"><span class="linenos">639</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">regs</span><span class="o">.</span><span class="n">SPSR</span> <span class="o">=</span> <span class="n">savedCPSR</span>  <span class="c1"># Save the CPSR in the current SPSR</span>
</span><span id="L-640"><a href="#L-640"><span class="linenos">640</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">regs</span><span class="o">.</span><span class="n">IRQ</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-641"><a href="#L-641"><span class="linenos">641</span></a>                    <span class="kc">True</span>  <span class="c1"># IRQ are always disabled when we enter an interrupt</span>
</span><span id="L-642"><a href="#L-642"><span class="linenos">642</span></a>                <span class="p">)</span>
</span><span id="L-643"><a href="#L-643"><span class="linenos">643</span></a>                <span class="k">if</span> <span class="p">(</span>
</span><span id="L-644"><a href="#L-644"><span class="linenos">644</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">interruptParams</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;FIQ&quot;</span>
</span><span id="L-645"><a href="#L-645"><span class="linenos">645</span></a>                <span class="p">):</span>  <span class="c1"># If we enter a FIQ interrupt,</span>
</span><span id="L-646"><a href="#L-646"><span class="linenos">646</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">regs</span><span class="o">.</span><span class="n">FIQ</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1">#   then we disable also FIQ interrupts</span>
</span><span id="L-647"><a href="#L-647"><span class="linenos">647</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">regs</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-648"><a href="#L-648"><span class="linenos">648</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">regs</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">-</span> <span class="mi">4</span>
</span><span id="L-649"><a href="#L-649"><span class="linenos">649</span></a>                <span class="p">)</span>  <span class="c1"># Save PC in LR (on the FIQ or IRQ bank)</span>
</span><span id="L-650"><a href="#L-650"><span class="linenos">650</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">regs</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pcoffset</span> <span class="o">+</span> <span class="p">(</span>
</span><span id="L-651"><a href="#L-651"><span class="linenos">651</span></a>                    <span class="mh">0x18</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interruptParams</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;IRQ&quot;</span> <span class="k">else</span> <span class="mh">0x1C</span>
</span><span id="L-652"><a href="#L-652"><span class="linenos">652</span></a>                <span class="p">)</span>  <span class="c1"># Set PC to enter the interrupt</span>
</span><span id="L-653"><a href="#L-653"><span class="linenos">653</span></a>
</span><span id="L-654"><a href="#L-654"><span class="linenos">654</span></a>        <span class="c1"># We fetch and decode the next instruction</span>
</span><span id="L-655"><a href="#L-655"><span class="linenos">655</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fetchAndDecode</span><span class="p">(</span><span class="n">forceExplain</span><span class="p">)</span>
</span><span id="L-656"><a href="#L-656"><span class="linenos">656</span></a>
</span><span id="L-657"><a href="#L-657"><span class="linenos">657</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">errorsPending</span><span class="p">:</span>
</span><span id="L-658"><a href="#L-658"><span class="linenos">658</span></a>            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">errorsPending</span>
</span><span id="L-659"><a href="#L-659"><span class="linenos">659</span></a>
</span><span id="L-660"><a href="#L-660"><span class="linenos">660</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">deactivateAllBreakpoints</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-661"><a href="#L-661"><span class="linenos">661</span></a>        <span class="c1"># Without removing them, do not trig on breakpoint until `reactivateAllBreakpoints`</span>
</span><span id="L-662"><a href="#L-662"><span class="linenos">662</span></a>        <span class="c1"># is called. Useful to temporary disable breakpoints of Memory and Registers</span>
</span><span id="L-663"><a href="#L-663"><span class="linenos">663</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">regs</span><span class="o">.</span><span class="n">deactivateBreakpoints</span><span class="p">()</span>
</span><span id="L-664"><a href="#L-664"><span class="linenos">664</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mem</span><span class="o">.</span><span class="n">deactivateBreakpoints</span><span class="p">()</span>
</span><span id="L-665"><a href="#L-665"><span class="linenos">665</span></a>
</span><span id="L-666"><a href="#L-666"><span class="linenos">666</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">reactivateAllBreakpoints</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-667"><a href="#L-667"><span class="linenos">667</span></a>        <span class="c1"># See `deactivateAllBreakpoints`</span>
</span><span id="L-668"><a href="#L-668"><span class="linenos">668</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">regs</span><span class="o">.</span><span class="n">reactivateBreakpoints</span><span class="p">()</span>
</span><span id="L-669"><a href="#L-669"><span class="linenos">669</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mem</span><span class="o">.</span><span class="n">reactivateBreakpoints</span><span class="p">()</span>
</span><span id="L-670"><a href="#L-670"><span class="linenos">670</span></a>
</span><span id="L-671"><a href="#L-671"><span class="linenos">671</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">getCurrentLine</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-672"><a href="#L-672"><span class="linenos">672</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">regs</span><span class="o">.</span><span class="n">deactivateBreakpoints</span><span class="p">()</span>
</span><span id="L-673"><a href="#L-673"><span class="linenos">673</span></a>        <span class="n">pc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">regs</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span>
</span><span id="L-674"><a href="#L-674"><span class="linenos">674</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">regs</span><span class="o">.</span><span class="n">reactivateBreakpoints</span><span class="p">()</span>
</span><span id="L-675"><a href="#L-675"><span class="linenos">675</span></a>        <span class="n">pc</span> <span class="o">-=</span> <span class="mi">8</span> <span class="k">if</span> <span class="n">getSetting</span><span class="p">(</span><span class="s2">&quot;PCbehavior&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;+8&quot;</span> <span class="k">else</span> <span class="mi">0</span>
</span><span id="L-676"><a href="#L-676"><span class="linenos">676</span></a>        <span class="k">if</span> <span class="n">pc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">addr2line</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">addr2line</span><span class="p">[</span><span class="n">pc</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-677"><a href="#L-677"><span class="linenos">677</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">addr2line</span><span class="p">[</span><span class="n">pc</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-678"><a href="#L-678"><span class="linenos">678</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-679"><a href="#L-679"><span class="linenos">679</span></a>            <span class="k">return</span> <span class="kc">None</span>
</span><span id="L-680"><a href="#L-680"><span class="linenos">680</span></a>
</span><span id="L-681"><a href="#L-681"><span class="linenos">681</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_toggleBreakpoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bkptException</span><span class="p">):</span>
</span><span id="L-682"><a href="#L-682"><span class="linenos">682</span></a>        <span class="k">if</span> <span class="n">bkptException</span><span class="o">.</span><span class="n">cmp</span> <span class="o">==</span> <span class="s2">&quot;memory&quot;</span><span class="p">:</span>
</span><span id="L-683"><a href="#L-683"><span class="linenos">683</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">mem</span><span class="o">.</span><span class="n">toggleBreakpoint</span><span class="p">(</span><span class="n">bkptException</span><span class="o">.</span><span class="n">info</span><span class="p">,</span> <span class="n">bkptException</span><span class="o">.</span><span class="n">mode</span><span class="p">)</span>
</span><span id="L-684"><a href="#L-684"><span class="linenos">684</span></a>        <span class="k">elif</span> <span class="n">bkptException</span><span class="o">.</span><span class="n">cmp</span> <span class="o">==</span> <span class="s2">&quot;register&quot;</span><span class="p">:</span>
</span><span id="L-685"><a href="#L-685"><span class="linenos">685</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">regs</span><span class="o">.</span><span class="n">toggleBreakpointOnRegister</span><span class="p">(</span>
</span><span id="L-686"><a href="#L-686"><span class="linenos">686</span></a>                <span class="n">bkptException</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bkptException</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">bkptException</span><span class="o">.</span><span class="n">mode</span>
</span><span id="L-687"><a href="#L-687"><span class="linenos">687</span></a>            <span class="p">)</span>
</span><span id="L-688"><a href="#L-688"><span class="linenos">688</span></a>        <span class="k">elif</span> <span class="n">bkptException</span><span class="o">.</span><span class="n">cmp</span> <span class="o">==</span> <span class="s2">&quot;flags&quot;</span><span class="p">:</span>
</span><span id="L-689"><a href="#L-689"><span class="linenos">689</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">regs</span><span class="o">.</span><span class="n">toggleBreakpointOnFlag</span><span class="p">(</span><span class="n">bkptException</span><span class="o">.</span><span class="n">info</span><span class="p">,</span> <span class="n">bkptException</span><span class="o">.</span><span class="n">mode</span><span class="p">)</span>
</span></pre></div>


            </section>
                <section id="appState">
                    <div class="attr variable">
            <span class="name">appState</span>        =
<span class="default_value">&lt;stateManager.StateManager object&gt;</span>

        
    </div>
    <a class="headerlink" href="#appState"></a>
    
    

                </section>
                <section id="MultipleErrors">
                            <input id="MultipleErrors-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">MultipleErrors</span><wbr>(<span class="base">builtins.Exception</span>):

                <label class="view-source-button" for="MultipleErrors-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MultipleErrors"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MultipleErrors-14"><a href="#MultipleErrors-14"><span class="linenos">14</span></a><span class="k">class</span><span class="w"> </span><span class="nc">MultipleErrors</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
</span><span id="MultipleErrors-15"><a href="#MultipleErrors-15"><span class="linenos">15</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MultipleErrors-16"><a href="#MultipleErrors-16"><span class="linenos">16</span></a><span class="sd">    This exception class is used to store multiple execution errors. It is useful if there</span>
</span><span id="MultipleErrors-17"><a href="#MultipleErrors-17"><span class="linenos">17</span></a><span class="sd">    are multiple errors in one instruction. Also, this class can be iterated to treat each error individually.</span>
</span><span id="MultipleErrors-18"><a href="#MultipleErrors-18"><span class="linenos">18</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="MultipleErrors-19"><a href="#MultipleErrors-19"><span class="linenos">19</span></a>
</span><span id="MultipleErrors-20"><a href="#MultipleErrors-20"><span class="linenos">20</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">info</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">line</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="MultipleErrors-21"><a href="#MultipleErrors-21"><span class="linenos">21</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MultipleErrors-22"><a href="#MultipleErrors-22"><span class="linenos">22</span></a><span class="sd">        Initialize a empty class if error and info are None.</span>
</span><span id="MultipleErrors-23"><a href="#MultipleErrors-23"><span class="linenos">23</span></a><span class="sd">        Otherwise, initialize the class with the corresponding parameters.</span>
</span><span id="MultipleErrors-24"><a href="#MultipleErrors-24"><span class="linenos">24</span></a>
</span><span id="MultipleErrors-25"><a href="#MultipleErrors-25"><span class="linenos">25</span></a><span class="sd">        :param error: a str containing the error type</span>
</span><span id="MultipleErrors-26"><a href="#MultipleErrors-26"><span class="linenos">26</span></a><span class="sd">        :param info: a str containing information on the error</span>
</span><span id="MultipleErrors-27"><a href="#MultipleErrors-27"><span class="linenos">27</span></a><span class="sd">        :param line: the line number when the error occurs (default None)</span>
</span><span id="MultipleErrors-28"><a href="#MultipleErrors-28"><span class="linenos">28</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MultipleErrors-29"><a href="#MultipleErrors-29"><span class="linenos">29</span></a>        <span class="k">if</span> <span class="n">error</span> <span class="ow">and</span> <span class="n">info</span><span class="p">:</span>
</span><span id="MultipleErrors-30"><a href="#MultipleErrors-30"><span class="linenos">30</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="p">[(</span><span class="n">error</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">line</span><span class="p">)]</span>
</span><span id="MultipleErrors-31"><a href="#MultipleErrors-31"><span class="linenos">31</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MultipleErrors-32"><a href="#MultipleErrors-32"><span class="linenos">32</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="MultipleErrors-33"><a href="#MultipleErrors-33"><span class="linenos">33</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="MultipleErrors-34"><a href="#MultipleErrors-34"><span class="linenos">34</span></a>
</span><span id="MultipleErrors-35"><a href="#MultipleErrors-35"><span class="linenos">35</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__bool__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="MultipleErrors-36"><a href="#MultipleErrors-36"><span class="linenos">36</span></a>        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">content</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span>
</span><span id="MultipleErrors-37"><a href="#MultipleErrors-37"><span class="linenos">37</span></a>
</span><span id="MultipleErrors-38"><a href="#MultipleErrors-38"><span class="linenos">38</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="MultipleErrors-39"><a href="#MultipleErrors-39"><span class="linenos">39</span></a>        <span class="k">return</span> <span class="bp">self</span>
</span><span id="MultipleErrors-40"><a href="#MultipleErrors-40"><span class="linenos">40</span></a>
</span><span id="MultipleErrors-41"><a href="#MultipleErrors-41"><span class="linenos">41</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__next__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="MultipleErrors-42"><a href="#MultipleErrors-42"><span class="linenos">42</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="MultipleErrors-43"><a href="#MultipleErrors-43"><span class="linenos">43</span></a>            <span class="n">retval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">content</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">idx</span><span class="p">]</span>
</span><span id="MultipleErrors-44"><a href="#MultipleErrors-44"><span class="linenos">44</span></a>        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
</span><span id="MultipleErrors-45"><a href="#MultipleErrors-45"><span class="linenos">45</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="MultipleErrors-46"><a href="#MultipleErrors-46"><span class="linenos">46</span></a>            <span class="k">raise</span> <span class="ne">StopIteration</span><span class="p">()</span>
</span><span id="MultipleErrors-47"><a href="#MultipleErrors-47"><span class="linenos">47</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="MultipleErrors-48"><a href="#MultipleErrors-48"><span class="linenos">48</span></a>        <span class="k">return</span> <span class="n">retval</span>
</span><span id="MultipleErrors-49"><a href="#MultipleErrors-49"><span class="linenos">49</span></a>
</span><span id="MultipleErrors-50"><a href="#MultipleErrors-50"><span class="linenos">50</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">append</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">line</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="MultipleErrors-51"><a href="#MultipleErrors-51"><span class="linenos">51</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">error</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">line</span><span class="p">))</span>
</span><span id="MultipleErrors-52"><a href="#MultipleErrors-52"><span class="linenos">52</span></a>
</span><span id="MultipleErrors-53"><a href="#MultipleErrors-53"><span class="linenos">53</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="MultipleErrors-54"><a href="#MultipleErrors-54"><span class="linenos">54</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="MultipleErrors-55"><a href="#MultipleErrors-55"><span class="linenos">55</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="p">[]</span>
</span></pre></div>


            <div class="docstring"><p>This exception class is used to store multiple execution errors. It is useful if there
are multiple errors in one instruction. Also, this class can be iterated to treat each error individually.</p>
</div>


                            <div id="MultipleErrors.__init__" class="classattr">
                                        <input id="MultipleErrors.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">MultipleErrors</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">error</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">info</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">line</span><span class="o">=</span><span class="kc">None</span></span>)</span>

                <label class="view-source-button" for="MultipleErrors.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MultipleErrors.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MultipleErrors.__init__-20"><a href="#MultipleErrors.__init__-20"><span class="linenos">20</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">info</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">line</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="MultipleErrors.__init__-21"><a href="#MultipleErrors.__init__-21"><span class="linenos">21</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MultipleErrors.__init__-22"><a href="#MultipleErrors.__init__-22"><span class="linenos">22</span></a><span class="sd">        Initialize a empty class if error and info are None.</span>
</span><span id="MultipleErrors.__init__-23"><a href="#MultipleErrors.__init__-23"><span class="linenos">23</span></a><span class="sd">        Otherwise, initialize the class with the corresponding parameters.</span>
</span><span id="MultipleErrors.__init__-24"><a href="#MultipleErrors.__init__-24"><span class="linenos">24</span></a>
</span><span id="MultipleErrors.__init__-25"><a href="#MultipleErrors.__init__-25"><span class="linenos">25</span></a><span class="sd">        :param error: a str containing the error type</span>
</span><span id="MultipleErrors.__init__-26"><a href="#MultipleErrors.__init__-26"><span class="linenos">26</span></a><span class="sd">        :param info: a str containing information on the error</span>
</span><span id="MultipleErrors.__init__-27"><a href="#MultipleErrors.__init__-27"><span class="linenos">27</span></a><span class="sd">        :param line: the line number when the error occurs (default None)</span>
</span><span id="MultipleErrors.__init__-28"><a href="#MultipleErrors.__init__-28"><span class="linenos">28</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MultipleErrors.__init__-29"><a href="#MultipleErrors.__init__-29"><span class="linenos">29</span></a>        <span class="k">if</span> <span class="n">error</span> <span class="ow">and</span> <span class="n">info</span><span class="p">:</span>
</span><span id="MultipleErrors.__init__-30"><a href="#MultipleErrors.__init__-30"><span class="linenos">30</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="p">[(</span><span class="n">error</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">line</span><span class="p">)]</span>
</span><span id="MultipleErrors.__init__-31"><a href="#MultipleErrors.__init__-31"><span class="linenos">31</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MultipleErrors.__init__-32"><a href="#MultipleErrors.__init__-32"><span class="linenos">32</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="MultipleErrors.__init__-33"><a href="#MultipleErrors.__init__-33"><span class="linenos">33</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span>
</span></pre></div>


            <div class="docstring"><p>Initialize a empty class if error and info are None.
Otherwise, initialize the class with the corresponding parameters.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>error</strong>:  a str containing the error type</li>
<li><strong>info</strong>:  a str containing information on the error</li>
<li><strong>line</strong>:  the line number when the error occurs (default None)</li>
</ul>
</div>


                            </div>
                            <div id="MultipleErrors.idx" class="classattr">
                                <div class="attr variable">
            <span class="name">idx</span>

        
    </div>
    <a class="headerlink" href="#MultipleErrors.idx"></a>
    
    

                            </div>
                            <div id="MultipleErrors.append" class="classattr">
                                        <input id="MultipleErrors.append-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">append</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">error</span>, </span><span class="param"><span class="n">info</span>, </span><span class="param"><span class="n">line</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="MultipleErrors.append-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MultipleErrors.append"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MultipleErrors.append-50"><a href="#MultipleErrors.append-50"><span class="linenos">50</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">append</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">line</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="MultipleErrors.append-51"><a href="#MultipleErrors.append-51"><span class="linenos">51</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">error</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">line</span><span class="p">))</span>
</span></pre></div>


    

                            </div>
                            <div id="MultipleErrors.clear" class="classattr">
                                        <input id="MultipleErrors.clear-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">clear</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="MultipleErrors.clear-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MultipleErrors.clear"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MultipleErrors.clear-53"><a href="#MultipleErrors.clear-53"><span class="linenos">53</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="MultipleErrors.clear-54"><a href="#MultipleErrors.clear-54"><span class="linenos">54</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="MultipleErrors.clear-55"><a href="#MultipleErrors.clear-55"><span class="linenos">55</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="p">[]</span>
</span></pre></div>


    

                            </div>
                </section>
                <section id="Simulator">
                            <input id="Simulator-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">Simulator</span>:

                <label class="view-source-button" for="Simulator-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Simulator"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Simulator-58"><a href="#Simulator-58"><span class="linenos"> 58</span></a><span class="k">class</span><span class="w"> </span><span class="nc">Simulator</span><span class="p">:</span>
</span><span id="Simulator-59"><a href="#Simulator-59"><span class="linenos"> 59</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Simulator-60"><a href="#Simulator-60"><span class="linenos"> 60</span></a><span class="sd">    Main simulator class.</span>
</span><span id="Simulator-61"><a href="#Simulator-61"><span class="linenos"> 61</span></a><span class="sd">    None of its method should be called directly by the UI,</span>
</span><span id="Simulator-62"><a href="#Simulator-62"><span class="linenos"> 62</span></a><span class="sd">    everything should pass through bytecodeinterpreter class.</span>
</span><span id="Simulator-63"><a href="#Simulator-63"><span class="linenos"> 63</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="Simulator-64"><a href="#Simulator-64"><span class="linenos"> 64</span></a>
</span><span id="Simulator-65"><a href="#Simulator-65"><span class="linenos"> 65</span></a>    <span class="n">PC</span> <span class="o">=</span> <span class="mi">15</span>  <span class="c1"># Helpful shorthand to get a reference on PC</span>
</span><span id="Simulator-66"><a href="#Simulator-66"><span class="linenos"> 66</span></a>
</span><span id="Simulator-67"><a href="#Simulator-67"><span class="linenos"> 67</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">memorycontent</span><span class="p">,</span> <span class="n">assertionTriggers</span><span class="p">,</span> <span class="n">addr2line</span><span class="p">,</span> <span class="n">pcInitValue</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
</span><span id="Simulator-68"><a href="#Simulator-68"><span class="linenos"> 68</span></a>        <span class="c1"># Parameters</span>
</span><span id="Simulator-69"><a href="#Simulator-69"><span class="linenos"> 69</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pcoffset</span> <span class="o">=</span> <span class="mi">8</span> <span class="k">if</span> <span class="n">getSetting</span><span class="p">(</span><span class="s2">&quot;PCbehavior&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;+8&quot;</span> <span class="k">else</span> <span class="mi">0</span>
</span><span id="Simulator-70"><a href="#Simulator-70"><span class="linenos"> 70</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">PCSpecialBehavior</span> <span class="o">=</span> <span class="n">getSetting</span><span class="p">(</span><span class="s2">&quot;PCspecialbehavior&quot;</span><span class="p">)</span>
</span><span id="Simulator-71"><a href="#Simulator-71"><span class="linenos"> 71</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">allowSwitchModeInUserMode</span> <span class="o">=</span> <span class="n">getSetting</span><span class="p">(</span><span class="s2">&quot;allowuserswitchmode&quot;</span><span class="p">)</span>
</span><span id="Simulator-72"><a href="#Simulator-72"><span class="linenos"> 72</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">maxit</span> <span class="o">=</span> <span class="n">getSetting</span><span class="p">(</span><span class="s2">&quot;runmaxit&quot;</span><span class="p">)</span>
</span><span id="Simulator-73"><a href="#Simulator-73"><span class="linenos"> 73</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">bkptLastFetch</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Simulator-74"><a href="#Simulator-74"><span class="linenos"> 74</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">deactivatedBkpts</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Simulator-75"><a href="#Simulator-75"><span class="linenos"> 75</span></a>
</span><span id="Simulator-76"><a href="#Simulator-76"><span class="linenos"> 76</span></a>        <span class="c1"># Initialize history</span>
</span><span id="Simulator-77"><a href="#Simulator-77"><span class="linenos"> 77</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">history</span> <span class="o">=</span> <span class="n">History</span><span class="p">()</span>
</span><span id="Simulator-78"><a href="#Simulator-78"><span class="linenos"> 78</span></a>
</span><span id="Simulator-79"><a href="#Simulator-79"><span class="linenos"> 79</span></a>        <span class="c1"># Initialize components</span>
</span><span id="Simulator-80"><a href="#Simulator-80"><span class="linenos"> 80</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mem</span> <span class="o">=</span> <span class="n">Memory</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">,</span> <span class="n">memorycontent</span><span class="p">)</span>
</span><span id="Simulator-81"><a href="#Simulator-81"><span class="linenos"> 81</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">regs</span> <span class="o">=</span> <span class="n">Registers</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">)</span>
</span><span id="Simulator-82"><a href="#Simulator-82"><span class="linenos"> 82</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pcInitVal</span> <span class="o">=</span> <span class="n">pcInitValue</span>
</span><span id="Simulator-83"><a href="#Simulator-83"><span class="linenos"> 83</span></a>
</span><span id="Simulator-84"><a href="#Simulator-84"><span class="linenos"> 84</span></a>        <span class="c1"># Initialize decoders</span>
</span><span id="Simulator-85"><a href="#Simulator-85"><span class="linenos"> 85</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">decoders</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="Simulator-86"><a href="#Simulator-86"><span class="linenos"> 86</span></a>            <span class="s2">&quot;BranchOp&quot;</span><span class="p">:</span> <span class="n">BranchOp</span><span class="p">(),</span>
</span><span id="Simulator-87"><a href="#Simulator-87"><span class="linenos"> 87</span></a>            <span class="s2">&quot;DataOp&quot;</span><span class="p">:</span> <span class="n">DataOp</span><span class="p">(),</span>
</span><span id="Simulator-88"><a href="#Simulator-88"><span class="linenos"> 88</span></a>            <span class="s2">&quot;MemOp&quot;</span><span class="p">:</span> <span class="n">MemOp</span><span class="p">(),</span>
</span><span id="Simulator-89"><a href="#Simulator-89"><span class="linenos"> 89</span></a>            <span class="s2">&quot;MultipleMemOp&quot;</span><span class="p">:</span> <span class="n">MultipleMemOp</span><span class="p">(),</span>
</span><span id="Simulator-90"><a href="#Simulator-90"><span class="linenos"> 90</span></a>            <span class="s2">&quot;HalfSignedMemOp&quot;</span><span class="p">:</span> <span class="n">HalfSignedMemOp</span><span class="p">(),</span>
</span><span id="Simulator-91"><a href="#Simulator-91"><span class="linenos"> 91</span></a>            <span class="s2">&quot;SwapOp&quot;</span><span class="p">:</span> <span class="n">SwapOp</span><span class="p">(),</span>
</span><span id="Simulator-92"><a href="#Simulator-92"><span class="linenos"> 92</span></a>            <span class="s2">&quot;PSROp&quot;</span><span class="p">:</span> <span class="n">PSROp</span><span class="p">(),</span>
</span><span id="Simulator-93"><a href="#Simulator-93"><span class="linenos"> 93</span></a>            <span class="s2">&quot;MulOp&quot;</span><span class="p">:</span> <span class="n">MulOp</span><span class="p">(),</span>
</span><span id="Simulator-94"><a href="#Simulator-94"><span class="linenos"> 94</span></a>            <span class="s2">&quot;MulLongOp&quot;</span><span class="p">:</span> <span class="n">MulLongOp</span><span class="p">(),</span>
</span><span id="Simulator-95"><a href="#Simulator-95"><span class="linenos"> 95</span></a>            <span class="s2">&quot;SoftInterruptOp&quot;</span><span class="p">:</span> <span class="n">SoftInterruptOp</span><span class="p">(),</span>
</span><span id="Simulator-96"><a href="#Simulator-96"><span class="linenos"> 96</span></a>            <span class="s2">&quot;NopOp&quot;</span><span class="p">:</span> <span class="n">NopOp</span><span class="p">(),</span>
</span><span id="Simulator-97"><a href="#Simulator-97"><span class="linenos"> 97</span></a>        <span class="p">}</span>
</span><span id="Simulator-98"><a href="#Simulator-98"><span class="linenos"> 98</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">decoderCache</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="Simulator-99"><a href="#Simulator-99"><span class="linenos"> 99</span></a>
</span><span id="Simulator-100"><a href="#Simulator-100"><span class="linenos">100</span></a>        <span class="c1"># Initialize assertion structures</span>
</span><span id="Simulator-101"><a href="#Simulator-101"><span class="linenos">101</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">assertionCkpts</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">assertionTriggers</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</span><span id="Simulator-102"><a href="#Simulator-102"><span class="linenos">102</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">assertionData</span> <span class="o">=</span> <span class="n">assertionTriggers</span>
</span><span id="Simulator-103"><a href="#Simulator-103"><span class="linenos">103</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">assertionWhenReturn</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span><span id="Simulator-104"><a href="#Simulator-104"><span class="linenos">104</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">callStack</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Simulator-105"><a href="#Simulator-105"><span class="linenos">105</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">addr2line</span> <span class="o">=</span> <span class="n">addr2line</span>
</span><span id="Simulator-106"><a href="#Simulator-106"><span class="linenos">106</span></a>
</span><span id="Simulator-107"><a href="#Simulator-107"><span class="linenos">107</span></a>        <span class="c1"># Initialize execution errors buffer</span>
</span><span id="Simulator-108"><a href="#Simulator-108"><span class="linenos">108</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">errorsPending</span> <span class="o">=</span> <span class="n">MultipleErrors</span><span class="p">()</span>
</span><span id="Simulator-109"><a href="#Simulator-109"><span class="linenos">109</span></a>
</span><span id="Simulator-110"><a href="#Simulator-110"><span class="linenos">110</span></a>        <span class="c1"># Initialize interrupt structures</span>
</span><span id="Simulator-111"><a href="#Simulator-111"><span class="linenos">111</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">interruptActive</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="Simulator-112"><a href="#Simulator-112"><span class="linenos">112</span></a>        <span class="c1"># Interrupt trigged at each a*(t-t0) + b cycles</span>
</span><span id="Simulator-113"><a href="#Simulator-113"><span class="linenos">113</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">interruptParams</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;b&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;t0&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;FIQ&quot;</span><span class="p">}</span>
</span><span id="Simulator-114"><a href="#Simulator-114"><span class="linenos">114</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">lastInterruptCycle</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
</span><span id="Simulator-115"><a href="#Simulator-115"><span class="linenos">115</span></a>
</span><span id="Simulator-116"><a href="#Simulator-116"><span class="linenos">116</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stepMode</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Simulator-117"><a href="#Simulator-117"><span class="linenos">117</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stepCondition</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="Simulator-118"><a href="#Simulator-118"><span class="linenos">118</span></a>        <span class="c1"># Used to stop the simulator after n iterations in run mode</span>
</span><span id="Simulator-119"><a href="#Simulator-119"><span class="linenos">119</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">runIteration</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="Simulator-120"><a href="#Simulator-120"><span class="linenos">120</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
</span><span id="Simulator-121"><a href="#Simulator-121"><span class="linenos">121</span></a>
</span><span id="Simulator-122"><a href="#Simulator-122"><span class="linenos">122</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Simulator-123"><a href="#Simulator-123"><span class="linenos">123</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
</span><span id="Simulator-124"><a href="#Simulator-124"><span class="linenos">124</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">regs</span><span class="o">.</span><span class="n">banks</span><span class="p">[</span><span class="s2">&quot;User&quot;</span><span class="p">][</span><span class="mi">15</span><span class="p">]</span><span class="o">.</span><span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pcInitVal</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">pcoffset</span>
</span><span id="Simulator-125"><a href="#Simulator-125"><span class="linenos">125</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fetchAndDecode</span><span class="p">()</span>
</span><span id="Simulator-126"><a href="#Simulator-126"><span class="linenos">126</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">explainInstruction</span><span class="p">()</span>
</span><span id="Simulator-127"><a href="#Simulator-127"><span class="linenos">127</span></a>
</span><span id="Simulator-128"><a href="#Simulator-128"><span class="linenos">128</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">getContext</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Simulator-129"><a href="#Simulator-129"><span class="linenos">129</span></a>        <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;regs&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">regs</span><span class="o">.</span><span class="n">getContext</span><span class="p">(),</span> <span class="s2">&quot;mem&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">mem</span><span class="o">.</span><span class="n">getContext</span><span class="p">()}</span>
</span><span id="Simulator-130"><a href="#Simulator-130"><span class="linenos">130</span></a>        <span class="k">return</span> <span class="n">context</span>
</span><span id="Simulator-131"><a href="#Simulator-131"><span class="linenos">131</span></a>
</span><span id="Simulator-132"><a href="#Simulator-132"><span class="linenos">132</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">setStepCondition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stepMode</span><span class="p">):</span>
</span><span id="Simulator-133"><a href="#Simulator-133"><span class="linenos">133</span></a>        <span class="k">assert</span> <span class="n">stepMode</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;into&quot;</span><span class="p">,</span> <span class="s2">&quot;out&quot;</span><span class="p">,</span> <span class="s2">&quot;forward&quot;</span><span class="p">,</span> <span class="s2">&quot;run&quot;</span><span class="p">)</span>
</span><span id="Simulator-134"><a href="#Simulator-134"><span class="linenos">134</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stepMode</span> <span class="o">=</span> <span class="n">stepMode</span>
</span><span id="Simulator-135"><a href="#Simulator-135"><span class="linenos">135</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stepCondition</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="Simulator-136"><a href="#Simulator-136"><span class="linenos">136</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">runIteration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">cyclesCount</span>
</span><span id="Simulator-137"><a href="#Simulator-137"><span class="linenos">137</span></a>
</span><span id="Simulator-138"><a href="#Simulator-138"><span class="linenos">138</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">isStepDone</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Simulator-139"><a href="#Simulator-139"><span class="linenos">139</span></a>        <span class="n">maxCyclesReached</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">cyclesCount</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">runIteration</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxit</span>
</span><span id="Simulator-140"><a href="#Simulator-140"><span class="linenos">140</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stepMode</span> <span class="o">==</span> <span class="s2">&quot;forward&quot;</span><span class="p">:</span>
</span><span id="Simulator-141"><a href="#Simulator-141"><span class="linenos">141</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stepCondition</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="Simulator-142"><a href="#Simulator-142"><span class="linenos">142</span></a>                <span class="c1"># The instruction was a function call</span>
</span><span id="Simulator-143"><a href="#Simulator-143"><span class="linenos">143</span></a>                <span class="c1"># Now the step forward becomes a step out</span>
</span><span id="Simulator-144"><a href="#Simulator-144"><span class="linenos">144</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">stepMode</span> <span class="o">=</span> <span class="s2">&quot;out&quot;</span>
</span><span id="Simulator-145"><a href="#Simulator-145"><span class="linenos">145</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">stepCondition</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="Simulator-146"><a href="#Simulator-146"><span class="linenos">146</span></a>                <span class="k">return</span> <span class="kc">False</span>
</span><span id="Simulator-147"><a href="#Simulator-147"><span class="linenos">147</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Simulator-148"><a href="#Simulator-148"><span class="linenos">148</span></a>                <span class="k">return</span> <span class="kc">True</span>
</span><span id="Simulator-149"><a href="#Simulator-149"><span class="linenos">149</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stepMode</span> <span class="o">==</span> <span class="s2">&quot;out&quot;</span><span class="p">:</span>
</span><span id="Simulator-150"><a href="#Simulator-150"><span class="linenos">150</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">stepCondition</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">maxCyclesReached</span>
</span><span id="Simulator-151"><a href="#Simulator-151"><span class="linenos">151</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stepMode</span> <span class="o">==</span> <span class="s2">&quot;run&quot;</span><span class="p">:</span>
</span><span id="Simulator-152"><a href="#Simulator-152"><span class="linenos">152</span></a>            <span class="k">return</span> <span class="n">maxCyclesReached</span>
</span><span id="Simulator-153"><a href="#Simulator-153"><span class="linenos">153</span></a>
</span><span id="Simulator-154"><a href="#Simulator-154"><span class="linenos">154</span></a>        <span class="c1"># We are doing a step into, we always stop</span>
</span><span id="Simulator-155"><a href="#Simulator-155"><span class="linenos">155</span></a>        <span class="k">return</span> <span class="kc">True</span>
</span><span id="Simulator-156"><a href="#Simulator-156"><span class="linenos">156</span></a>
</span><span id="Simulator-157"><a href="#Simulator-157"><span class="linenos">157</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">loop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Simulator-158"><a href="#Simulator-158"><span class="linenos">158</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Simulator-159"><a href="#Simulator-159"><span class="linenos">159</span></a><span class="sd">        Loop until the stopping criterion is met. Returns the aggregated list</span>
</span><span id="Simulator-160"><a href="#Simulator-160"><span class="linenos">160</span></a><span class="sd">        of changes since the beginning of the simulation loop.</span>
</span><span id="Simulator-161"><a href="#Simulator-161"><span class="linenos">161</span></a><span class="sd">        Stopping criterion can be set using `setStepCondition`.</span>
</span><span id="Simulator-162"><a href="#Simulator-162"><span class="linenos">162</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Simulator-163"><a href="#Simulator-163"><span class="linenos">163</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">setCheckpoint</span><span class="p">()</span>
</span><span id="Simulator-164"><a href="#Simulator-164"><span class="linenos">164</span></a>        <span class="k">for</span> <span class="n">decoder</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoders</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
</span><span id="Simulator-165"><a href="#Simulator-165"><span class="linenos">165</span></a>            <span class="n">decoder</span><span class="o">.</span><span class="n">resetExecCounters</span><span class="p">()</span>
</span><span id="Simulator-166"><a href="#Simulator-166"><span class="linenos">166</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">nextInstr</span><span class="p">()</span>  <span class="c1"># We always execute at least one instruction</span>
</span><span id="Simulator-167"><a href="#Simulator-167"><span class="linenos">167</span></a>        <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">isStepDone</span><span class="p">():</span>  <span class="c1"># We repeat until the stopping criterion is met</span>
</span><span id="Simulator-168"><a href="#Simulator-168"><span class="linenos">168</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">nextInstr</span><span class="p">()</span>
</span><span id="Simulator-169"><a href="#Simulator-169"><span class="linenos">169</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">explainInstruction</span><span class="p">()</span>  <span class="c1"># We only have to explain the last instruction executed before we stop</span>
</span><span id="Simulator-170"><a href="#Simulator-170"><span class="linenos">170</span></a>
</span><span id="Simulator-171"><a href="#Simulator-171"><span class="linenos">171</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">stepBack</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
</span><span id="Simulator-172"><a href="#Simulator-172"><span class="linenos">172</span></a>        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">count</span><span class="p">):</span>
</span><span id="Simulator-173"><a href="#Simulator-173"><span class="linenos">173</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">stepBack</span><span class="p">()</span>
</span><span id="Simulator-174"><a href="#Simulator-174"><span class="linenos">174</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fetchAndDecode</span><span class="p">(</span><span class="n">forceExplain</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="Simulator-175"><a href="#Simulator-175"><span class="linenos">175</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">bkptLastFetch</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Simulator-176"><a href="#Simulator-176"><span class="linenos">176</span></a>
</span><span id="Simulator-177"><a href="#Simulator-177"><span class="linenos">177</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">executionStats</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Simulator-178"><a href="#Simulator-178"><span class="linenos">178</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Simulator-179"><a href="#Simulator-179"><span class="linenos">179</span></a><span class="sd">        Return a dictionary with the number of times each instruction type was executed</span>
</span><span id="Simulator-180"><a href="#Simulator-180"><span class="linenos">180</span></a><span class="sd">        in the last execution run.</span>
</span><span id="Simulator-181"><a href="#Simulator-181"><span class="linenos">181</span></a><span class="sd">        The types are:</span>
</span><span id="Simulator-182"><a href="#Simulator-182"><span class="linenos">182</span></a><span class="sd">        - &quot;data&quot; (includes all arithmetic and logic operations except multiply)</span>
</span><span id="Simulator-183"><a href="#Simulator-183"><span class="linenos">183</span></a><span class="sd">        - &quot;mem&quot; (includes all _single_ memory accesses including byte, half or word access and swap)</span>
</span><span id="Simulator-184"><a href="#Simulator-184"><span class="linenos">184</span></a><span class="sd">        - &quot;multiplemem&quot; (all _multiple_ memory accesses: LDM, STM, POP, and PUSH)</span>
</span><span id="Simulator-185"><a href="#Simulator-185"><span class="linenos">185</span></a><span class="sd">        - &quot;branch&quot; (all branches, B/BL/BX alike)</span>
</span><span id="Simulator-186"><a href="#Simulator-186"><span class="linenos">186</span></a><span class="sd">        - &quot;multiply&quot; (multiply and multiply long operations)</span>
</span><span id="Simulator-187"><a href="#Simulator-187"><span class="linenos">187</span></a><span class="sd">        - &quot;softinterrupt&quot; (self explanatory)</span>
</span><span id="Simulator-188"><a href="#Simulator-188"><span class="linenos">188</span></a><span class="sd">        - &quot;psr&quot; (CPSR/SPRS &lt;-&gt; register transfers)</span>
</span><span id="Simulator-189"><a href="#Simulator-189"><span class="linenos">189</span></a><span class="sd">        - &quot;nop&quot; (NOP instructions)</span>
</span><span id="Simulator-190"><a href="#Simulator-190"><span class="linenos">190</span></a>
</span><span id="Simulator-191"><a href="#Simulator-191"><span class="linenos">191</span></a><span class="sd">        These keys are associated to a 2-integers tuple. The first value is the number of times</span>
</span><span id="Simulator-192"><a href="#Simulator-192"><span class="linenos">192</span></a><span class="sd">        this kind of instruction was executed, the second the number of times if _would_ have been</span>
</span><span id="Simulator-193"><a href="#Simulator-193"><span class="linenos">193</span></a><span class="sd">        executed except for the condition field (e.g. the condition was not met).</span>
</span><span id="Simulator-194"><a href="#Simulator-194"><span class="linenos">194</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Simulator-195"><a href="#Simulator-195"><span class="linenos">195</span></a>        <span class="n">memExec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoders</span><span class="p">[</span><span class="s2">&quot;MemOp&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">execCounters</span>
</span><span id="Simulator-196"><a href="#Simulator-196"><span class="linenos">196</span></a>        <span class="n">halfMemExec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoders</span><span class="p">[</span><span class="s2">&quot;HalfSignedMemOp&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">execCounters</span>
</span><span id="Simulator-197"><a href="#Simulator-197"><span class="linenos">197</span></a>        <span class="n">swapExec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoders</span><span class="p">[</span><span class="s2">&quot;SwapOp&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">execCounters</span>
</span><span id="Simulator-198"><a href="#Simulator-198"><span class="linenos">198</span></a>        <span class="n">multiplyExec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoders</span><span class="p">[</span><span class="s2">&quot;MulOp&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">execCounters</span>
</span><span id="Simulator-199"><a href="#Simulator-199"><span class="linenos">199</span></a>        <span class="n">multiplyLongExec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoders</span><span class="p">[</span><span class="s2">&quot;MulLongOp&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">execCounters</span>
</span><span id="Simulator-200"><a href="#Simulator-200"><span class="linenos">200</span></a>
</span><span id="Simulator-201"><a href="#Simulator-201"><span class="linenos">201</span></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="Simulator-202"><a href="#Simulator-202"><span class="linenos">202</span></a>            <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoders</span><span class="p">[</span><span class="s2">&quot;DataOp&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">execCounters</span><span class="p">,</span>
</span><span id="Simulator-203"><a href="#Simulator-203"><span class="linenos">203</span></a>            <span class="s2">&quot;mem&quot;</span><span class="p">:</span> <span class="p">(</span>
</span><span id="Simulator-204"><a href="#Simulator-204"><span class="linenos">204</span></a>                <span class="n">memExec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">halfMemExec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">swapExec</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
</span><span id="Simulator-205"><a href="#Simulator-205"><span class="linenos">205</span></a>                <span class="n">memExec</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">halfMemExec</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">swapExec</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
</span><span id="Simulator-206"><a href="#Simulator-206"><span class="linenos">206</span></a>            <span class="p">),</span>
</span><span id="Simulator-207"><a href="#Simulator-207"><span class="linenos">207</span></a>            <span class="s2">&quot;multiplemem&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoders</span><span class="p">[</span><span class="s2">&quot;MultipleMemOp&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">execCounters</span><span class="p">,</span>
</span><span id="Simulator-208"><a href="#Simulator-208"><span class="linenos">208</span></a>            <span class="s2">&quot;branch&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoders</span><span class="p">[</span><span class="s2">&quot;BranchOp&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">execCounters</span><span class="p">,</span>
</span><span id="Simulator-209"><a href="#Simulator-209"><span class="linenos">209</span></a>            <span class="s2">&quot;multiply&quot;</span><span class="p">:</span> <span class="p">(</span>
</span><span id="Simulator-210"><a href="#Simulator-210"><span class="linenos">210</span></a>                <span class="n">multiplyExec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">multiplyLongExec</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
</span><span id="Simulator-211"><a href="#Simulator-211"><span class="linenos">211</span></a>                <span class="n">multiplyExec</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">multiplyLongExec</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
</span><span id="Simulator-212"><a href="#Simulator-212"><span class="linenos">212</span></a>            <span class="p">),</span>
</span><span id="Simulator-213"><a href="#Simulator-213"><span class="linenos">213</span></a>            <span class="s2">&quot;softinterrupt&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoders</span><span class="p">[</span><span class="s2">&quot;SoftInterruptOp&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">execCounters</span><span class="p">,</span>
</span><span id="Simulator-214"><a href="#Simulator-214"><span class="linenos">214</span></a>            <span class="s2">&quot;psr&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoders</span><span class="p">[</span><span class="s2">&quot;PSROp&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">execCounters</span><span class="p">,</span>
</span><span id="Simulator-215"><a href="#Simulator-215"><span class="linenos">215</span></a>            <span class="s2">&quot;nop&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoders</span><span class="p">[</span><span class="s2">&quot;NopOp&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">execCounters</span><span class="p">,</span>
</span><span id="Simulator-216"><a href="#Simulator-216"><span class="linenos">216</span></a>        <span class="p">}</span>
</span><span id="Simulator-217"><a href="#Simulator-217"><span class="linenos">217</span></a>
</span><span id="Simulator-218"><a href="#Simulator-218"><span class="linenos">218</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">fetchAndDecode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">forceExplain</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="Simulator-219"><a href="#Simulator-219"><span class="linenos">219</span></a>        <span class="c1"># Check if PC is valid (multiple of 4)</span>
</span><span id="Simulator-220"><a href="#Simulator-220"><span class="linenos">220</span></a>        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">regs</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">pcoffset</span><span class="p">)</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Simulator-221"><a href="#Simulator-221"><span class="linenos">221</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fetchedInstr</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Simulator-222"><a href="#Simulator-222"><span class="linenos">222</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">errorsPending</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="Simulator-223"><a href="#Simulator-223"><span class="linenos">223</span></a>                <span class="s2">&quot;register&quot;</span><span class="p">,</span>
</span><span id="Simulator-224"><a href="#Simulator-224"><span class="linenos">224</span></a>                <span class="n">appState</span><span class="o">.</span><span class="n">getT</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="Simulator-225"><a href="#Simulator-225"><span class="linenos">225</span></a>                    <span class="nb">hex</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">regs</span><span class="p">[</span><span class="mi">15</span><span class="p">])</span>
</span><span id="Simulator-226"><a href="#Simulator-226"><span class="linenos">226</span></a>                <span class="p">),</span>
</span><span id="Simulator-227"><a href="#Simulator-227"><span class="linenos">227</span></a>            <span class="p">)</span>
</span><span id="Simulator-228"><a href="#Simulator-228"><span class="linenos">228</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Simulator-229"><a href="#Simulator-229"><span class="linenos">229</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="Simulator-230"><a href="#Simulator-230"><span class="linenos">230</span></a>                <span class="c1"># Retrieve instruction from memory</span>
</span><span id="Simulator-231"><a href="#Simulator-231"><span class="linenos">231</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">fetchedInstr</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span>
</span><span id="Simulator-232"><a href="#Simulator-232"><span class="linenos">232</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">mem</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">regs</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">pcoffset</span><span class="p">,</span> <span class="n">execMode</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="Simulator-233"><a href="#Simulator-233"><span class="linenos">233</span></a>                <span class="p">)</span>
</span><span id="Simulator-234"><a href="#Simulator-234"><span class="linenos">234</span></a>            <span class="k">except</span> <span class="n">Breakpoint</span> <span class="k">as</span> <span class="n">bp</span><span class="p">:</span>
</span><span id="Simulator-235"><a href="#Simulator-235"><span class="linenos">235</span></a>                <span class="c1"># We hit a breakpoint</span>
</span><span id="Simulator-236"><a href="#Simulator-236"><span class="linenos">236</span></a>                <span class="c1"># Get memory instruction again, without trigger breakpoint</span>
</span><span id="Simulator-237"><a href="#Simulator-237"><span class="linenos">237</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">fetchedInstr</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span>
</span><span id="Simulator-238"><a href="#Simulator-238"><span class="linenos">238</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">mem</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">regs</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">pcoffset</span><span class="p">,</span> <span class="n">mayTriggerBkpt</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="Simulator-239"><a href="#Simulator-239"><span class="linenos">239</span></a>                <span class="p">)</span>
</span><span id="Simulator-240"><a href="#Simulator-240"><span class="linenos">240</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">bkptLastFetch</span> <span class="o">=</span> <span class="n">bp</span>
</span><span id="Simulator-241"><a href="#Simulator-241"><span class="linenos">241</span></a>            <span class="k">except</span> <span class="n">ComponentException</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
</span><span id="Simulator-242"><a href="#Simulator-242"><span class="linenos">242</span></a>                <span class="c1"># Execution error</span>
</span><span id="Simulator-243"><a href="#Simulator-243"><span class="linenos">243</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">errorsPending</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">err</span><span class="o">.</span><span class="n">cmp</span><span class="p">,</span> <span class="n">err</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
</span><span id="Simulator-244"><a href="#Simulator-244"><span class="linenos">244</span></a>                <span class="c1"># There is no instruction to this address</span>
</span><span id="Simulator-245"><a href="#Simulator-245"><span class="linenos">245</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">fetchedInstr</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Simulator-246"><a href="#Simulator-246"><span class="linenos">246</span></a>
</span><span id="Simulator-247"><a href="#Simulator-247"><span class="linenos">247</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">bytecodeToInstr</span><span class="p">()</span>
</span><span id="Simulator-248"><a href="#Simulator-248"><span class="linenos">248</span></a>        <span class="k">if</span> <span class="n">forceExplain</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">isStepDone</span><span class="p">():</span>
</span><span id="Simulator-249"><a href="#Simulator-249"><span class="linenos">249</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">explainInstruction</span><span class="p">()</span>
</span><span id="Simulator-250"><a href="#Simulator-250"><span class="linenos">250</span></a>
</span><span id="Simulator-251"><a href="#Simulator-251"><span class="linenos">251</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">bytecodeToInstr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Simulator-252"><a href="#Simulator-252"><span class="linenos">252</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Simulator-253"><a href="#Simulator-253"><span class="linenos">253</span></a><span class="sd">          Decode an instruction from its bytecode representation.</span>
</span><span id="Simulator-254"><a href="#Simulator-254"><span class="linenos">254</span></a>
</span><span id="Simulator-255"><a href="#Simulator-255"><span class="linenos">255</span></a><span class="sd">          See ARM Instruction set documentation for more information (Fig 4.1,</span>
</span><span id="Simulator-256"><a href="#Simulator-256"><span class="linenos">256</span></a><span class="sd">          and also Sec. A5.1 of ARM-v7 Architecture Reference Manual).</span>
</span><span id="Simulator-257"><a href="#Simulator-257"><span class="linenos">257</span></a><span class="sd">          We use the following decoding scheme, designed to ensure that avoid any</span>
</span><span id="Simulator-258"><a href="#Simulator-258"><span class="linenos">258</span></a><span class="sd">          instruction representation clash and also to reduce the number of</span>
</span><span id="Simulator-259"><a href="#Simulator-259"><span class="linenos">259</span></a><span class="sd">          conditions having to be checked in total. Each number inside [ ]</span>
</span><span id="Simulator-260"><a href="#Simulator-260"><span class="linenos">260</span></a><span class="sd">          represents a bit position. The usual binary ops symbols apply.</span>
</span><span id="Simulator-261"><a href="#Simulator-261"><span class="linenos">261</span></a>
</span><span id="Simulator-262"><a href="#Simulator-262"><span class="linenos">262</span></a><span class="sd">          Note that NOP was backported from ARMv7, and that ARMv4 coprocessor</span>
</span><span id="Simulator-263"><a href="#Simulator-263"><span class="linenos">263</span></a><span class="sd">          instructions are not supported. Also, we do not explicitly check for</span>
</span><span id="Simulator-264"><a href="#Simulator-264"><span class="linenos">264</span></a><span class="sd">          undefined instructions (in the ARM terminology, they are more</span>
</span><span id="Simulator-265"><a href="#Simulator-265"><span class="linenos">265</span></a><span class="sd">          _unpredictable_ than undefined).</span>
</span><span id="Simulator-266"><a href="#Simulator-266"><span class="linenos">266</span></a>
</span><span id="Simulator-267"><a href="#Simulator-267"><span class="linenos">267</span></a><span class="sd">          Decoded instructions are also cached to improve performance.</span>
</span><span id="Simulator-268"><a href="#Simulator-268"><span class="linenos">268</span></a>
</span><span id="Simulator-269"><a href="#Simulator-269"><span class="linenos">269</span></a><span class="sd">         Bytecode input</span>
</span><span id="Simulator-270"><a href="#Simulator-270"><span class="linenos">270</span></a><span class="sd">           (4 bytes)</span>
</span><span id="Simulator-271"><a href="#Simulator-271"><span class="linenos">271</span></a><span class="sd">               |</span>
</span><span id="Simulator-272"><a href="#Simulator-272"><span class="linenos">272</span></a><span class="sd">               |</span>
</span><span id="Simulator-273"><a href="#Simulator-273"><span class="linenos">273</span></a><span class="sd">               v</span>
</span><span id="Simulator-274"><a href="#Simulator-274"><span class="linenos">274</span></a><span class="sd">          [~26 &amp; ~27]---------------------------------------------------------v</span>
</span><span id="Simulator-275"><a href="#Simulator-275"><span class="linenos">275</span></a><span class="sd">               |                                                              |</span>
</span><span id="Simulator-276"><a href="#Simulator-276"><span class="linenos">276</span></a><span class="sd">               | FALSE                                                        | TRUE</span>
</span><span id="Simulator-277"><a href="#Simulator-277"><span class="linenos">277</span></a><span class="sd">               |                                                              |</span>
</span><span id="Simulator-278"><a href="#Simulator-278"><span class="linenos">278</span></a><span class="sd">               v                                                              v</span>
</span><span id="Simulator-279"><a href="#Simulator-279"><span class="linenos">279</span></a><span class="sd">             [26 ]--------------------------------v                           |</span>
</span><span id="Simulator-280"><a href="#Simulator-280"><span class="linenos">280</span></a><span class="sd">               |                                  |                           |</span>
</span><span id="Simulator-281"><a href="#Simulator-281"><span class="linenos">281</span></a><span class="sd">               | FALSE                            | TRUE                      |</span>
</span><span id="Simulator-282"><a href="#Simulator-282"><span class="linenos">282</span></a><span class="sd">               |                                  |                           |</span>
</span><span id="Simulator-283"><a href="#Simulator-283"><span class="linenos">283</span></a><span class="sd">               v                                  v                           v</span>
</span><span id="Simulator-284"><a href="#Simulator-284"><span class="linenos">284</span></a><span class="sd">             [25 ]----------------v             [27 ]-------------v           |</span>
</span><span id="Simulator-285"><a href="#Simulator-285"><span class="linenos">285</span></a><span class="sd">               |                  |               |               |           |</span>
</span><span id="Simulator-286"><a href="#Simulator-286"><span class="linenos">286</span></a><span class="sd">               | FALSE            | TRUE          | FALSE         | TRUE      |</span>
</span><span id="Simulator-287"><a href="#Simulator-287"><span class="linenos">287</span></a><span class="sd">               |                  |               |               |           |</span>
</span><span id="Simulator-288"><a href="#Simulator-288"><span class="linenos">288</span></a><span class="sd">               v                  v               v               v           v</span>
</span><span id="Simulator-289"><a href="#Simulator-289"><span class="linenos">289</span></a><span class="sd">           LDM / STM          Branch (B)      LDR / STR       SWI / SVC       |</span>
</span><span id="Simulator-290"><a href="#Simulator-290"><span class="linenos">290</span></a><span class="sd">                                           (also undefined                    |</span>
</span><span id="Simulator-291"><a href="#Simulator-291"><span class="linenos">291</span></a><span class="sd">                                               if [4])                        |</span>
</span><span id="Simulator-292"><a href="#Simulator-292"><span class="linenos">292</span></a><span class="sd">               v--------------------------------------------------------------&lt;</span>
</span><span id="Simulator-293"><a href="#Simulator-293"><span class="linenos">293</span></a><span class="sd">               |</span>
</span><span id="Simulator-294"><a href="#Simulator-294"><span class="linenos">294</span></a><span class="sd">               v</span>
</span><span id="Simulator-295"><a href="#Simulator-295"><span class="linenos">295</span></a><span class="sd">         [4 &amp; 7 &amp; ~25]--------------------------------------------v</span>
</span><span id="Simulator-296"><a href="#Simulator-296"><span class="linenos">296</span></a><span class="sd">               |                                                  |</span>
</span><span id="Simulator-297"><a href="#Simulator-297"><span class="linenos">297</span></a><span class="sd">               | FALSE                                            | TRUE</span>
</span><span id="Simulator-298"><a href="#Simulator-298"><span class="linenos">298</span></a><span class="sd">               |                                                  |</span>
</span><span id="Simulator-299"><a href="#Simulator-299"><span class="linenos">299</span></a><span class="sd">               v                                                  v</span>
</span><span id="Simulator-300"><a href="#Simulator-300"><span class="linenos">300</span></a><span class="sd">        [~20 &amp; ~23 &amp; 24]----------v                            [5 | 6]--------v</span>
</span><span id="Simulator-301"><a href="#Simulator-301"><span class="linenos">301</span></a><span class="sd">               |                  |                               |           | TRUE</span>
</span><span id="Simulator-302"><a href="#Simulator-302"><span class="linenos">302</span></a><span class="sd">               | FALSE            | TRUE                          | FALSE     v</span>
</span><span id="Simulator-303"><a href="#Simulator-303"><span class="linenos">303</span></a><span class="sd">               |                  |                               |       LDRH/SH/SB</span>
</span><span id="Simulator-304"><a href="#Simulator-304"><span class="linenos">304</span></a><span class="sd">               v                  v                               v</span>
</span><span id="Simulator-305"><a href="#Simulator-305"><span class="linenos">305</span></a><span class="sd">            DATA OP           [18 &amp; 21]-----------v             [24 ]---------v</span>
</span><span id="Simulator-306"><a href="#Simulator-306"><span class="linenos">306</span></a><span class="sd">        (MOV, ADD, etc.)          |               |               |           | TRUE</span>
</span><span id="Simulator-307"><a href="#Simulator-307"><span class="linenos">307</span></a><span class="sd">                                  | FALSE         | TRUE          | FALSE     v</span>
</span><span id="Simulator-308"><a href="#Simulator-308"><span class="linenos">308</span></a><span class="sd">                                  |               |               |          SWP</span>
</span><span id="Simulator-309"><a href="#Simulator-309"><span class="linenos">309</span></a><span class="sd">                                  v               v               v</span>
</span><span id="Simulator-310"><a href="#Simulator-310"><span class="linenos">310</span></a><span class="sd">               v----------------[19 ]            BX             [23 ]---------v</span>
</span><span id="Simulator-311"><a href="#Simulator-311"><span class="linenos">311</span></a><span class="sd">               |                  |                               |           | TRUE</span>
</span><span id="Simulator-312"><a href="#Simulator-312"><span class="linenos">312</span></a><span class="sd">               | TRUE             | FALSE                         | FALSE     v</span>
</span><span id="Simulator-313"><a href="#Simulator-313"><span class="linenos">313</span></a><span class="sd">               |                  |                               |        Multiply</span>
</span><span id="Simulator-314"><a href="#Simulator-314"><span class="linenos">314</span></a><span class="sd">               v                  v                               v          long</span>
</span><span id="Simulator-315"><a href="#Simulator-315"><span class="linenos">315</span></a><span class="sd">           MSR / MRS             NOP                           Multiply</span>
</span><span id="Simulator-316"><a href="#Simulator-316"><span class="linenos">316</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Simulator-317"><a href="#Simulator-317"><span class="linenos">317</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">fetchedInstr</span><span class="p">:</span>
</span><span id="Simulator-318"><a href="#Simulator-318"><span class="linenos">318</span></a>            <span class="c1"># Undefined instruction</span>
</span><span id="Simulator-319"><a href="#Simulator-319"><span class="linenos">319</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">currentInstr</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Simulator-320"><a href="#Simulator-320"><span class="linenos">320</span></a>            <span class="k">return</span>
</span><span id="Simulator-321"><a href="#Simulator-321"><span class="linenos">321</span></a>        <span class="c1"># Assumes that the instruction to decode is in self.fetchedInstr</span>
</span><span id="Simulator-322"><a href="#Simulator-322"><span class="linenos">322</span></a>        <span class="n">instrInt</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&quot;&lt;I&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fetchedInstr</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Simulator-323"><a href="#Simulator-323"><span class="linenos">323</span></a>
</span><span id="Simulator-324"><a href="#Simulator-324"><span class="linenos">324</span></a>        <span class="k">if</span> <span class="n">instrInt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoderCache</span><span class="p">:</span>
</span><span id="Simulator-325"><a href="#Simulator-325"><span class="linenos">325</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">currentInstr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoderCache</span><span class="p">[</span><span class="n">instrInt</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Simulator-326"><a href="#Simulator-326"><span class="linenos">326</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">currentInstr</span><span class="o">.</span><span class="n">setBytecode</span><span class="p">(</span><span class="n">instrInt</span><span class="p">)</span>
</span><span id="Simulator-327"><a href="#Simulator-327"><span class="linenos">327</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">currentInstr</span><span class="o">.</span><span class="n">restoreState</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">decoderCache</span><span class="p">[</span><span class="n">instrInt</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
</span><span id="Simulator-328"><a href="#Simulator-328"><span class="linenos">328</span></a>            <span class="k">return</span>
</span><span id="Simulator-329"><a href="#Simulator-329"><span class="linenos">329</span></a>
</span><span id="Simulator-330"><a href="#Simulator-330"><span class="linenos">330</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">instrInt</span> <span class="o">&gt;&gt;</span> <span class="mi">26</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">):</span>
</span><span id="Simulator-331"><a href="#Simulator-331"><span class="linenos">331</span></a>            <span class="k">if</span> <span class="n">instrInt</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span> <span class="o">&amp;</span> <span class="mi">9</span> <span class="o">==</span> <span class="mi">9</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="n">instrInt</span> <span class="o">&gt;&gt;</span> <span class="mi">25</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">):</span>
</span><span id="Simulator-332"><a href="#Simulator-332"><span class="linenos">332</span></a>                <span class="k">if</span> <span class="n">instrInt</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">:</span>
</span><span id="Simulator-333"><a href="#Simulator-333"><span class="linenos">333</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">currentInstr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoders</span><span class="p">[</span><span class="s2">&quot;HalfSignedMemOp&quot;</span><span class="p">]</span>
</span><span id="Simulator-334"><a href="#Simulator-334"><span class="linenos">334</span></a>                <span class="k">elif</span> <span class="n">instrInt</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="Simulator-335"><a href="#Simulator-335"><span class="linenos">335</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">currentInstr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoders</span><span class="p">[</span><span class="s2">&quot;SwapOp&quot;</span><span class="p">]</span>
</span><span id="Simulator-336"><a href="#Simulator-336"><span class="linenos">336</span></a>                <span class="k">elif</span> <span class="n">instrInt</span> <span class="o">&gt;&gt;</span> <span class="mi">23</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="Simulator-337"><a href="#Simulator-337"><span class="linenos">337</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">currentInstr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoders</span><span class="p">[</span><span class="s2">&quot;MulLongOp&quot;</span><span class="p">]</span>
</span><span id="Simulator-338"><a href="#Simulator-338"><span class="linenos">338</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="Simulator-339"><a href="#Simulator-339"><span class="linenos">339</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">currentInstr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoders</span><span class="p">[</span><span class="s2">&quot;MulOp&quot;</span><span class="p">]</span>
</span><span id="Simulator-340"><a href="#Simulator-340"><span class="linenos">340</span></a>            <span class="k">elif</span> <span class="n">instrInt</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span> <span class="o">&amp;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="n">instrInt</span> <span class="o">&gt;&gt;</span> <span class="mi">20</span> <span class="o">&amp;</span> <span class="mi">9</span><span class="p">):</span>
</span><span id="Simulator-341"><a href="#Simulator-341"><span class="linenos">341</span></a>                <span class="k">if</span> <span class="n">instrInt</span> <span class="o">&gt;&gt;</span> <span class="mi">18</span> <span class="o">&amp;</span> <span class="mi">9</span> <span class="o">==</span> <span class="mi">9</span><span class="p">:</span>
</span><span id="Simulator-342"><a href="#Simulator-342"><span class="linenos">342</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">currentInstr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoders</span><span class="p">[</span><span class="s2">&quot;BranchOp&quot;</span><span class="p">]</span>
</span><span id="Simulator-343"><a href="#Simulator-343"><span class="linenos">343</span></a>                <span class="k">elif</span> <span class="n">instrInt</span> <span class="o">&gt;&gt;</span> <span class="mi">19</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="Simulator-344"><a href="#Simulator-344"><span class="linenos">344</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">currentInstr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoders</span><span class="p">[</span><span class="s2">&quot;PSROp&quot;</span><span class="p">]</span>
</span><span id="Simulator-345"><a href="#Simulator-345"><span class="linenos">345</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="Simulator-346"><a href="#Simulator-346"><span class="linenos">346</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">currentInstr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoders</span><span class="p">[</span><span class="s2">&quot;NopOp&quot;</span><span class="p">]</span>
</span><span id="Simulator-347"><a href="#Simulator-347"><span class="linenos">347</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Simulator-348"><a href="#Simulator-348"><span class="linenos">348</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">currentInstr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoders</span><span class="p">[</span><span class="s2">&quot;DataOp&quot;</span><span class="p">]</span>
</span><span id="Simulator-349"><a href="#Simulator-349"><span class="linenos">349</span></a>        <span class="k">elif</span> <span class="n">instrInt</span> <span class="o">&gt;&gt;</span> <span class="mi">26</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="Simulator-350"><a href="#Simulator-350"><span class="linenos">350</span></a>            <span class="k">if</span> <span class="n">instrInt</span> <span class="o">&gt;&gt;</span> <span class="mi">27</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="Simulator-351"><a href="#Simulator-351"><span class="linenos">351</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">currentInstr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoders</span><span class="p">[</span><span class="s2">&quot;SoftInterruptOp&quot;</span><span class="p">]</span>
</span><span id="Simulator-352"><a href="#Simulator-352"><span class="linenos">352</span></a>            <span class="k">else</span><span class="p">:</span>  <span class="c1"># Could also check for [4], which is an undefined space in the instruction set</span>
</span><span id="Simulator-353"><a href="#Simulator-353"><span class="linenos">353</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">currentInstr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoders</span><span class="p">[</span><span class="s2">&quot;MemOp&quot;</span><span class="p">]</span>
</span><span id="Simulator-354"><a href="#Simulator-354"><span class="linenos">354</span></a>        <span class="k">elif</span> <span class="n">instrInt</span> <span class="o">&gt;&gt;</span> <span class="mi">25</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="Simulator-355"><a href="#Simulator-355"><span class="linenos">355</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">currentInstr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoders</span><span class="p">[</span><span class="s2">&quot;BranchOp&quot;</span><span class="p">]</span>
</span><span id="Simulator-356"><a href="#Simulator-356"><span class="linenos">356</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Simulator-357"><a href="#Simulator-357"><span class="linenos">357</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">currentInstr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoders</span><span class="p">[</span><span class="s2">&quot;MultipleMemOp&quot;</span><span class="p">]</span>
</span><span id="Simulator-358"><a href="#Simulator-358"><span class="linenos">358</span></a>
</span><span id="Simulator-359"><a href="#Simulator-359"><span class="linenos">359</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentInstr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Simulator-360"><a href="#Simulator-360"><span class="linenos">360</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">currentInstr</span><span class="o">.</span><span class="n">setBytecode</span><span class="p">(</span><span class="n">instrInt</span><span class="p">)</span>
</span><span id="Simulator-361"><a href="#Simulator-361"><span class="linenos">361</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="Simulator-362"><a href="#Simulator-362"><span class="linenos">362</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">currentInstr</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
</span><span id="Simulator-363"><a href="#Simulator-363"><span class="linenos">363</span></a>                <span class="c1"># Once decoded, we add the instruction to the cache</span>
</span><span id="Simulator-364"><a href="#Simulator-364"><span class="linenos">364</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">decoderCache</span><span class="p">[</span><span class="n">instrInt</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="Simulator-365"><a href="#Simulator-365"><span class="linenos">365</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">currentInstr</span><span class="p">,</span>
</span><span id="Simulator-366"><a href="#Simulator-366"><span class="linenos">366</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">currentInstr</span><span class="o">.</span><span class="n">saveState</span><span class="p">(),</span>
</span><span id="Simulator-367"><a href="#Simulator-367"><span class="linenos">367</span></a>                <span class="p">)</span>
</span><span id="Simulator-368"><a href="#Simulator-368"><span class="linenos">368</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">decoderCache</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2000</span><span class="p">:</span>
</span><span id="Simulator-369"><a href="#Simulator-369"><span class="linenos">369</span></a>                    <span class="c1"># Fail-safe, we should never get there with programs &lt; 2000 lines, but just in case,</span>
</span><span id="Simulator-370"><a href="#Simulator-370"><span class="linenos">370</span></a>                    <span class="c1"># we do not want to bust the RAM with our cache</span>
</span><span id="Simulator-371"><a href="#Simulator-371"><span class="linenos">371</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">decoderCache</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="Simulator-372"><a href="#Simulator-372"><span class="linenos">372</span></a>            <span class="k">except</span> <span class="n">ExecutionException</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
</span><span id="Simulator-373"><a href="#Simulator-373"><span class="linenos">373</span></a>                <span class="c1"># Invalid instruction</span>
</span><span id="Simulator-374"><a href="#Simulator-374"><span class="linenos">374</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">currentInstr</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Simulator-375"><a href="#Simulator-375"><span class="linenos">375</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">errorsPending</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;execution&quot;</span><span class="p">,</span> <span class="n">err</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
</span><span id="Simulator-376"><a href="#Simulator-376"><span class="linenos">376</span></a>
</span><span id="Simulator-377"><a href="#Simulator-377"><span class="linenos">377</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">explainInstruction</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Simulator-378"><a href="#Simulator-378"><span class="linenos">378</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentInstr</span><span class="p">:</span>
</span><span id="Simulator-379"><a href="#Simulator-379"><span class="linenos">379</span></a>            <span class="c1"># Undefined instruction</span>
</span><span id="Simulator-380"><a href="#Simulator-380"><span class="linenos">380</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">disassemblyInfo</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="Simulator-381"><a href="#Simulator-381"><span class="linenos">381</span></a>                <span class="p">[</span><span class="s2">&quot;highlightRead&quot;</span><span class="p">,</span> <span class="p">[]],</span>
</span><span id="Simulator-382"><a href="#Simulator-382"><span class="linenos">382</span></a>                <span class="p">[</span><span class="s2">&quot;highlightWrite&quot;</span><span class="p">,</span> <span class="p">[]],</span>
</span><span id="Simulator-383"><a href="#Simulator-383"><span class="linenos">383</span></a>                <span class="p">[</span><span class="s2">&quot;nextline&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span>
</span><span id="Simulator-384"><a href="#Simulator-384"><span class="linenos">384</span></a>                <span class="p">[</span><span class="s2">&quot;disassembly&quot;</span><span class="p">,</span> <span class="n">appState</span><span class="o">.</span><span class="n">getT</span><span class="p">(</span><span class="mi">1</span><span class="p">)],</span>
</span><span id="Simulator-385"><a href="#Simulator-385"><span class="linenos">385</span></a>            <span class="p">)</span>
</span><span id="Simulator-386"><a href="#Simulator-386"><span class="linenos">386</span></a>            <span class="k">return</span>
</span><span id="Simulator-387"><a href="#Simulator-387"><span class="linenos">387</span></a>
</span><span id="Simulator-388"><a href="#Simulator-388"><span class="linenos">388</span></a>        <span class="n">disassembly</span><span class="p">,</span> <span class="n">description</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentInstr</span><span class="o">.</span><span class="n">explain</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span id="Simulator-389"><a href="#Simulator-389"><span class="linenos">389</span></a>        <span class="n">dis</span> <span class="o">=</span> <span class="s1">&#39;&lt;div id=&quot;disassembly_instruction&quot;&gt;</span><span class="si">{}</span><span class="s1">: </span><span class="si">{}</span><span class="s1">&lt;/div&gt;</span><span class="se">\n</span><span class="s1">&lt;div id=&quot;disassembly_description&quot;&gt;</span><span class="si">{}</span><span class="s1">&lt;/div&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="Simulator-390"><a href="#Simulator-390"><span class="linenos">390</span></a>            <span class="n">appState</span><span class="o">.</span><span class="n">getT</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="p">,</span><span class="n">disassembly</span><span class="p">,</span> <span class="n">description</span>
</span><span id="Simulator-391"><a href="#Simulator-391"><span class="linenos">391</span></a>        <span class="p">)</span>
</span><span id="Simulator-392"><a href="#Simulator-392"><span class="linenos">392</span></a>
</span><span id="Simulator-393"><a href="#Simulator-393"><span class="linenos">393</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentInstr</span><span class="o">.</span><span class="n">nextAddressToExecute</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
</span><span id="Simulator-394"><a href="#Simulator-394"><span class="linenos">394</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">disassemblyInfo</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="Simulator-395"><a href="#Simulator-395"><span class="linenos">395</span></a>                <span class="p">[</span>
</span><span id="Simulator-396"><a href="#Simulator-396"><span class="linenos">396</span></a>                    <span class="s2">&quot;highlightRead&quot;</span><span class="p">,</span>
</span><span id="Simulator-397"><a href="#Simulator-397"><span class="linenos">397</span></a>                    <span class="nb">list</span><span class="p">(</span>
</span><span id="Simulator-398"><a href="#Simulator-398"><span class="linenos">398</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">currentInstr</span><span class="o">.</span><span class="n">affectedRegs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Simulator-399"><a href="#Simulator-399"><span class="linenos">399</span></a>                        <span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentInstr</span><span class="o">.</span><span class="n">affectedMem</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Simulator-400"><a href="#Simulator-400"><span class="linenos">400</span></a>                    <span class="p">),</span>
</span><span id="Simulator-401"><a href="#Simulator-401"><span class="linenos">401</span></a>                <span class="p">],</span>
</span><span id="Simulator-402"><a href="#Simulator-402"><span class="linenos">402</span></a>                <span class="p">[</span>
</span><span id="Simulator-403"><a href="#Simulator-403"><span class="linenos">403</span></a>                    <span class="s2">&quot;highlightWrite&quot;</span><span class="p">,</span>
</span><span id="Simulator-404"><a href="#Simulator-404"><span class="linenos">404</span></a>                    <span class="nb">list</span><span class="p">(</span>
</span><span id="Simulator-405"><a href="#Simulator-405"><span class="linenos">405</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">currentInstr</span><span class="o">.</span><span class="n">affectedRegs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Simulator-406"><a href="#Simulator-406"><span class="linenos">406</span></a>                        <span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentInstr</span><span class="o">.</span><span class="n">affectedMem</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Simulator-407"><a href="#Simulator-407"><span class="linenos">407</span></a>                    <span class="p">),</span>
</span><span id="Simulator-408"><a href="#Simulator-408"><span class="linenos">408</span></a>                <span class="p">],</span>
</span><span id="Simulator-409"><a href="#Simulator-409"><span class="linenos">409</span></a>                <span class="p">[</span><span class="s2">&quot;nextline&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentInstr</span><span class="o">.</span><span class="n">nextAddressToExecute</span><span class="p">],</span>
</span><span id="Simulator-410"><a href="#Simulator-410"><span class="linenos">410</span></a>                <span class="p">[</span><span class="s2">&quot;disassembly&quot;</span><span class="p">,</span> <span class="n">dis</span><span class="p">],</span>
</span><span id="Simulator-411"><a href="#Simulator-411"><span class="linenos">411</span></a>            <span class="p">)</span>
</span><span id="Simulator-412"><a href="#Simulator-412"><span class="linenos">412</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Simulator-413"><a href="#Simulator-413"><span class="linenos">413</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">disassemblyInfo</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="Simulator-414"><a href="#Simulator-414"><span class="linenos">414</span></a>                <span class="p">[</span>
</span><span id="Simulator-415"><a href="#Simulator-415"><span class="linenos">415</span></a>                    <span class="s2">&quot;highlightRead&quot;</span><span class="p">,</span>
</span><span id="Simulator-416"><a href="#Simulator-416"><span class="linenos">416</span></a>                    <span class="nb">list</span><span class="p">(</span>
</span><span id="Simulator-417"><a href="#Simulator-417"><span class="linenos">417</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">currentInstr</span><span class="o">.</span><span class="n">affectedRegs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Simulator-418"><a href="#Simulator-418"><span class="linenos">418</span></a>                        <span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentInstr</span><span class="o">.</span><span class="n">affectedMem</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Simulator-419"><a href="#Simulator-419"><span class="linenos">419</span></a>                    <span class="p">),</span>
</span><span id="Simulator-420"><a href="#Simulator-420"><span class="linenos">420</span></a>                <span class="p">],</span>
</span><span id="Simulator-421"><a href="#Simulator-421"><span class="linenos">421</span></a>                <span class="p">[</span>
</span><span id="Simulator-422"><a href="#Simulator-422"><span class="linenos">422</span></a>                    <span class="s2">&quot;highlightWrite&quot;</span><span class="p">,</span>
</span><span id="Simulator-423"><a href="#Simulator-423"><span class="linenos">423</span></a>                    <span class="nb">list</span><span class="p">(</span>
</span><span id="Simulator-424"><a href="#Simulator-424"><span class="linenos">424</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">currentInstr</span><span class="o">.</span><span class="n">affectedRegs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Simulator-425"><a href="#Simulator-425"><span class="linenos">425</span></a>                        <span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentInstr</span><span class="o">.</span><span class="n">affectedMem</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Simulator-426"><a href="#Simulator-426"><span class="linenos">426</span></a>                    <span class="p">),</span>
</span><span id="Simulator-427"><a href="#Simulator-427"><span class="linenos">427</span></a>                <span class="p">],</span>
</span><span id="Simulator-428"><a href="#Simulator-428"><span class="linenos">428</span></a>                <span class="p">[</span><span class="s2">&quot;disassembly&quot;</span><span class="p">,</span> <span class="n">dis</span><span class="p">],</span>
</span><span id="Simulator-429"><a href="#Simulator-429"><span class="linenos">429</span></a>            <span class="p">)</span>
</span><span id="Simulator-430"><a href="#Simulator-430"><span class="linenos">430</span></a>
</span><span id="Simulator-431"><a href="#Simulator-431"><span class="linenos">431</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">execAssert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">assertionsList</span><span class="p">,</span> <span class="n">mode</span><span class="p">):</span>
</span><span id="Simulator-432"><a href="#Simulator-432"><span class="linenos">432</span></a>        <span class="k">for</span> <span class="n">assertionInfo</span> <span class="ow">in</span> <span class="n">assertionsList</span><span class="p">:</span>
</span><span id="Simulator-433"><a href="#Simulator-433"><span class="linenos">433</span></a>            <span class="n">assertionType</span> <span class="o">=</span> <span class="n">assertionInfo</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Simulator-434"><a href="#Simulator-434"><span class="linenos">434</span></a>            <span class="k">if</span> <span class="n">assertionType</span> <span class="o">!=</span> <span class="n">mode</span><span class="p">:</span>
</span><span id="Simulator-435"><a href="#Simulator-435"><span class="linenos">435</span></a>                <span class="k">continue</span>
</span><span id="Simulator-436"><a href="#Simulator-436"><span class="linenos">436</span></a>            <span class="n">assertionLine</span> <span class="o">=</span> <span class="n">assertionInfo</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Simulator-437"><a href="#Simulator-437"><span class="linenos">437</span></a>            <span class="n">assertionInfo</span> <span class="o">=</span> <span class="n">assertionInfo</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
</span><span id="Simulator-438"><a href="#Simulator-438"><span class="linenos">438</span></a>
</span><span id="Simulator-439"><a href="#Simulator-439"><span class="linenos">439</span></a>            <span class="n">strError</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span id="Simulator-440"><a href="#Simulator-440"><span class="linenos">440</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="Simulator-441"><a href="#Simulator-441"><span class="linenos">441</span></a>                <span class="k">for</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">assertionInfo</span><span class="p">:</span>
</span><span id="Simulator-442"><a href="#Simulator-442"><span class="linenos">442</span></a>                    <span class="n">info</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span><span id="Simulator-443"><a href="#Simulator-443"><span class="linenos">443</span></a>                    <span class="k">if</span> <span class="s2">&quot;=&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">info</span><span class="p">:</span>
</span><span id="Simulator-444"><a href="#Simulator-444"><span class="linenos">444</span></a>                        <span class="c1"># Bad syntax, we skip</span>
</span><span id="Simulator-445"><a href="#Simulator-445"><span class="linenos">445</span></a>                        <span class="k">continue</span>
</span><span id="Simulator-446"><a href="#Simulator-446"><span class="linenos">446</span></a>                    <span class="n">target</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">)</span>
</span><span id="Simulator-447"><a href="#Simulator-447"><span class="linenos">447</span></a>
</span><span id="Simulator-448"><a href="#Simulator-448"><span class="linenos">448</span></a>                    <span class="c1"># The rest of the code assume that a register is encoded</span>
</span><span id="Simulator-449"><a href="#Simulator-449"><span class="linenos">449</span></a>                    <span class="c1"># as R**, so we convert the alternative names</span>
</span><span id="Simulator-450"><a href="#Simulator-450"><span class="linenos">450</span></a>                    <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;SP&quot;</span><span class="p">,</span> <span class="s2">&quot;LR&quot;</span><span class="p">,</span> <span class="s2">&quot;PC&quot;</span><span class="p">):</span>
</span><span id="Simulator-451"><a href="#Simulator-451"><span class="linenos">451</span></a>                        <span class="n">value</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;SP&quot;</span><span class="p">:</span> <span class="s2">&quot;R13&quot;</span><span class="p">,</span> <span class="s2">&quot;LR&quot;</span><span class="p">:</span> <span class="s2">&quot;R14&quot;</span><span class="p">,</span> <span class="s2">&quot;PC&quot;</span><span class="p">:</span> <span class="s2">&quot;R15&quot;</span><span class="p">}[</span><span class="n">value</span><span class="p">]</span>
</span><span id="Simulator-452"><a href="#Simulator-452"><span class="linenos">452</span></a>                    <span class="k">if</span> <span class="n">target</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;SP&quot;</span><span class="p">,</span> <span class="s2">&quot;LR&quot;</span><span class="p">,</span> <span class="s2">&quot;PC&quot;</span><span class="p">):</span>
</span><span id="Simulator-453"><a href="#Simulator-453"><span class="linenos">453</span></a>                        <span class="n">target</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;SP&quot;</span><span class="p">:</span> <span class="s2">&quot;R13&quot;</span><span class="p">,</span> <span class="s2">&quot;LR&quot;</span><span class="p">:</span> <span class="s2">&quot;R14&quot;</span><span class="p">,</span> <span class="s2">&quot;PC&quot;</span><span class="p">:</span> <span class="s2">&quot;R15&quot;</span><span class="p">}[</span><span class="n">target</span><span class="p">]</span>
</span><span id="Simulator-454"><a href="#Simulator-454"><span class="linenos">454</span></a>
</span><span id="Simulator-455"><a href="#Simulator-455"><span class="linenos">455</span></a>                    <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">strip</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;R&quot;</span><span class="p">:</span>
</span><span id="Simulator-456"><a href="#Simulator-456"><span class="linenos">456</span></a>                        <span class="c1"># The target is another register</span>
</span><span id="Simulator-457"><a href="#Simulator-457"><span class="linenos">457</span></a>                        <span class="n">regtarget</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
</span><span id="Simulator-458"><a href="#Simulator-458"><span class="linenos">458</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">regs</span><span class="o">.</span><span class="n">deactivateBreakpoints</span><span class="p">()</span>
</span><span id="Simulator-459"><a href="#Simulator-459"><span class="linenos">459</span></a>                        <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">regs</span><span class="p">[</span><span class="n">regtarget</span><span class="p">]</span>
</span><span id="Simulator-460"><a href="#Simulator-460"><span class="linenos">460</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">regs</span><span class="o">.</span><span class="n">reactivateBreakpoints</span><span class="p">()</span>
</span><span id="Simulator-461"><a href="#Simulator-461"><span class="linenos">461</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="Simulator-462"><a href="#Simulator-462"><span class="linenos">462</span></a>                        <span class="c1"># The target is a constant</span>
</span><span id="Simulator-463"><a href="#Simulator-463"><span class="linenos">463</span></a>                        <span class="n">regtarget</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Simulator-464"><a href="#Simulator-464"><span class="linenos">464</span></a>                        <span class="k">try</span><span class="p">:</span>
</span><span id="Simulator-465"><a href="#Simulator-465"><span class="linenos">465</span></a>                            <span class="n">val</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">base</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFF</span>
</span><span id="Simulator-466"><a href="#Simulator-466"><span class="linenos">466</span></a>                        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
</span><span id="Simulator-467"><a href="#Simulator-467"><span class="linenos">467</span></a>                            <span class="c1"># If this is a decimal with leading zeros, base=0 will crash</span>
</span><span id="Simulator-468"><a href="#Simulator-468"><span class="linenos">468</span></a>                            <span class="n">val</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">base</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFF</span>
</span><span id="Simulator-469"><a href="#Simulator-469"><span class="linenos">469</span></a>
</span><span id="Simulator-470"><a href="#Simulator-470"><span class="linenos">470</span></a>                    <span class="k">if</span> <span class="n">target</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;R&quot;</span><span class="p">:</span>
</span><span id="Simulator-471"><a href="#Simulator-471"><span class="linenos">471</span></a>                        <span class="c1"># Register</span>
</span><span id="Simulator-472"><a href="#Simulator-472"><span class="linenos">472</span></a>                        <span class="n">reg</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">target</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
</span><span id="Simulator-473"><a href="#Simulator-473"><span class="linenos">473</span></a>
</span><span id="Simulator-474"><a href="#Simulator-474"><span class="linenos">474</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">regs</span><span class="o">.</span><span class="n">deactivateBreakpoints</span><span class="p">()</span>
</span><span id="Simulator-475"><a href="#Simulator-475"><span class="linenos">475</span></a>                        <span class="n">valreg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">regs</span><span class="p">[</span><span class="n">reg</span><span class="p">]</span>
</span><span id="Simulator-476"><a href="#Simulator-476"><span class="linenos">476</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">regs</span><span class="o">.</span><span class="n">reactivateBreakpoints</span><span class="p">()</span>
</span><span id="Simulator-477"><a href="#Simulator-477"><span class="linenos">477</span></a>                        <span class="k">if</span> <span class="n">valreg</span> <span class="o">!=</span> <span class="n">val</span><span class="p">:</span>
</span><span id="Simulator-478"><a href="#Simulator-478"><span class="linenos">478</span></a>                            <span class="k">if</span> <span class="n">regtarget</span><span class="p">:</span>
</span><span id="Simulator-479"><a href="#Simulator-479"><span class="linenos">479</span></a>                                <span class="n">strError</span> <span class="o">+=</span> <span class="n">appState</span><span class="o">.</span><span class="n">getT</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="Simulator-480"><a href="#Simulator-480"><span class="linenos">480</span></a>                                    <span class="n">target</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">regtarget</span><span class="p">,</span> <span class="n">valreg</span>
</span><span id="Simulator-481"><a href="#Simulator-481"><span class="linenos">481</span></a>                                <span class="p">)</span>
</span><span id="Simulator-482"><a href="#Simulator-482"><span class="linenos">482</span></a>                            <span class="k">else</span><span class="p">:</span>
</span><span id="Simulator-483"><a href="#Simulator-483"><span class="linenos">483</span></a>                                <span class="n">strError</span> <span class="o">+=</span> <span class="n">appState</span><span class="o">.</span><span class="n">getT</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="Simulator-484"><a href="#Simulator-484"><span class="linenos">484</span></a>                                    <span class="n">target</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">valreg</span>
</span><span id="Simulator-485"><a href="#Simulator-485"><span class="linenos">485</span></a>                                <span class="p">)</span>
</span><span id="Simulator-486"><a href="#Simulator-486"><span class="linenos">486</span></a>                    <span class="k">elif</span> <span class="n">target</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;0X&quot;</span><span class="p">:</span>
</span><span id="Simulator-487"><a href="#Simulator-487"><span class="linenos">487</span></a>                        <span class="c1"># Memory</span>
</span><span id="Simulator-488"><a href="#Simulator-488"><span class="linenos">488</span></a>                        <span class="n">addr</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">base</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
</span><span id="Simulator-489"><a href="#Simulator-489"><span class="linenos">489</span></a>
</span><span id="Simulator-490"><a href="#Simulator-490"><span class="linenos">490</span></a>                        <span class="n">formatStruct</span> <span class="o">=</span> <span class="s2">&quot;&lt;B&quot;</span>
</span><span id="Simulator-491"><a href="#Simulator-491"><span class="linenos">491</span></a>                        <span class="k">if</span> <span class="ow">not</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="nb">int</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">255</span><span class="p">:</span>
</span><span id="Simulator-492"><a href="#Simulator-492"><span class="linenos">492</span></a>                            <span class="n">val</span> <span class="o">&amp;=</span> <span class="mh">0xFFFFFFFF</span>
</span><span id="Simulator-493"><a href="#Simulator-493"><span class="linenos">493</span></a>                            <span class="n">formatStruct</span> <span class="o">=</span> <span class="s2">&quot;&lt;I&quot;</span>
</span><span id="Simulator-494"><a href="#Simulator-494"><span class="linenos">494</span></a>                        <span class="n">valmem</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mem</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
</span><span id="Simulator-495"><a href="#Simulator-495"><span class="linenos">495</span></a>                            <span class="n">addr</span><span class="p">,</span>
</span><span id="Simulator-496"><a href="#Simulator-496"><span class="linenos">496</span></a>                            <span class="n">mayTriggerBkpt</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="Simulator-497"><a href="#Simulator-497"><span class="linenos">497</span></a>                            <span class="n">size</span><span class="o">=</span><span class="mi">4</span> <span class="k">if</span> <span class="n">formatStruct</span> <span class="o">==</span> <span class="s2">&quot;&lt;I&quot;</span> <span class="k">else</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="Simulator-498"><a href="#Simulator-498"><span class="linenos">498</span></a>                        <span class="p">)</span>
</span><span id="Simulator-499"><a href="#Simulator-499"><span class="linenos">499</span></a>                        <span class="n">valmem</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">formatStruct</span><span class="p">,</span> <span class="n">valmem</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Simulator-500"><a href="#Simulator-500"><span class="linenos">500</span></a>                        <span class="k">if</span> <span class="n">valmem</span> <span class="o">!=</span> <span class="n">val</span><span class="p">:</span>
</span><span id="Simulator-501"><a href="#Simulator-501"><span class="linenos">501</span></a>                            <span class="k">if</span> <span class="n">regtarget</span><span class="p">:</span>
</span><span id="Simulator-502"><a href="#Simulator-502"><span class="linenos">502</span></a>                                <span class="n">strError</span> <span class="o">+=</span> <span class="n">appState</span><span class="o">.</span><span class="n">getT</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="Simulator-503"><a href="#Simulator-503"><span class="linenos">503</span></a>                                    <span class="n">target</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">regtarget</span><span class="p">,</span> <span class="n">valmem</span>
</span><span id="Simulator-504"><a href="#Simulator-504"><span class="linenos">504</span></a>                                <span class="p">)</span>
</span><span id="Simulator-505"><a href="#Simulator-505"><span class="linenos">505</span></a>                            <span class="k">else</span><span class="p">:</span>
</span><span id="Simulator-506"><a href="#Simulator-506"><span class="linenos">506</span></a>                                <span class="n">strError</span> <span class="o">+=</span> <span class="n">appState</span><span class="o">.</span><span class="n">getT</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="Simulator-507"><a href="#Simulator-507"><span class="linenos">507</span></a>                                    <span class="n">target</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">valmem</span>
</span><span id="Simulator-508"><a href="#Simulator-508"><span class="linenos">508</span></a>                                <span class="p">)</span>
</span><span id="Simulator-509"><a href="#Simulator-509"><span class="linenos">509</span></a>                    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">target</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">target</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">regs</span><span class="o">.</span><span class="n">flag2index</span><span class="p">:</span>
</span><span id="Simulator-510"><a href="#Simulator-510"><span class="linenos">510</span></a>                        <span class="c1"># Flag</span>
</span><span id="Simulator-511"><a href="#Simulator-511"><span class="linenos">511</span></a>                        <span class="n">expectedVal</span> <span class="o">=</span> <span class="n">value</span> <span class="o">!=</span> <span class="s2">&quot;0&quot;</span>
</span><span id="Simulator-512"><a href="#Simulator-512"><span class="linenos">512</span></a>                        <span class="n">actualVal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">regs</span><span class="o">.</span><span class="fm">__getattribute__</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
</span><span id="Simulator-513"><a href="#Simulator-513"><span class="linenos">513</span></a>                        <span class="k">if</span> <span class="n">actualVal</span> <span class="o">!=</span> <span class="n">expectedVal</span><span class="p">:</span>
</span><span id="Simulator-514"><a href="#Simulator-514"><span class="linenos">514</span></a>                            <span class="n">strError</span> <span class="o">+=</span> <span class="n">appState</span><span class="o">.</span><span class="n">getT</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="Simulator-515"><a href="#Simulator-515"><span class="linenos">515</span></a>                                <span class="n">target</span><span class="p">,</span> <span class="n">expectedVal</span><span class="p">,</span> <span class="n">actualVal</span>
</span><span id="Simulator-516"><a href="#Simulator-516"><span class="linenos">516</span></a>                            <span class="p">)</span>
</span><span id="Simulator-517"><a href="#Simulator-517"><span class="linenos">517</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="Simulator-518"><a href="#Simulator-518"><span class="linenos">518</span></a>                        <span class="c1"># Assert type unknown</span>
</span><span id="Simulator-519"><a href="#Simulator-519"><span class="linenos">519</span></a>                        <span class="n">strError</span> <span class="o">+=</span> <span class="n">appState</span><span class="o">.</span><span class="n">getT</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="Simulator-520"><a href="#Simulator-520"><span class="linenos">520</span></a>                            <span class="n">target</span><span class="p">,</span> <span class="n">value</span>
</span><span id="Simulator-521"><a href="#Simulator-521"><span class="linenos">521</span></a>                        <span class="p">)</span>
</span><span id="Simulator-522"><a href="#Simulator-522"><span class="linenos">522</span></a>
</span><span id="Simulator-523"><a href="#Simulator-523"><span class="linenos">523</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">strError</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Simulator-524"><a href="#Simulator-524"><span class="linenos">524</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">errorsPending</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;assert&quot;</span><span class="p">,</span> <span class="n">strError</span><span class="p">,</span> <span class="n">assertionLine</span><span class="p">)</span>
</span><span id="Simulator-525"><a href="#Simulator-525"><span class="linenos">525</span></a>
</span><span id="Simulator-526"><a href="#Simulator-526"><span class="linenos">526</span></a>            <span class="k">except</span> <span class="n">ComponentException</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
</span><span id="Simulator-527"><a href="#Simulator-527"><span class="linenos">527</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">errorsPending</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ex</span><span class="o">.</span><span class="n">cmp</span><span class="p">,</span> <span class="n">ex</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="n">assertionLine</span><span class="p">)</span>
</span><span id="Simulator-528"><a href="#Simulator-528"><span class="linenos">528</span></a>
</span><span id="Simulator-529"><a href="#Simulator-529"><span class="linenos">529</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">nextInstr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">forceExplain</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="Simulator-530"><a href="#Simulator-530"><span class="linenos">530</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentInstr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Simulator-531"><a href="#Simulator-531"><span class="linenos">531</span></a>            <span class="c1"># The current instruction has not be retrieved or decoded (because it was an illegal access)</span>
</span><span id="Simulator-532"><a href="#Simulator-532"><span class="linenos">532</span></a>            <span class="c1"># We raise the last error to explain the illegal access</span>
</span><span id="Simulator-533"><a href="#Simulator-533"><span class="linenos">533</span></a>            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">errorsPending</span>
</span><span id="Simulator-534"><a href="#Simulator-534"><span class="linenos">534</span></a>
</span><span id="Simulator-535"><a href="#Simulator-535"><span class="linenos">535</span></a>        <span class="n">isFirstInst</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">runIteration</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">cyclesCount</span>
</span><span id="Simulator-536"><a href="#Simulator-536"><span class="linenos">536</span></a>        <span class="c1"># One more cycle to do!</span>
</span><span id="Simulator-537"><a href="#Simulator-537"><span class="linenos">537</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">newCycle</span><span class="p">()</span>
</span><span id="Simulator-538"><a href="#Simulator-538"><span class="linenos">538</span></a>        <span class="c1"># Clear previous errors</span>
</span><span id="Simulator-539"><a href="#Simulator-539"><span class="linenos">539</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">errorsPending</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
</span><span id="Simulator-540"><a href="#Simulator-540"><span class="linenos">540</span></a>
</span><span id="Simulator-541"><a href="#Simulator-541"><span class="linenos">541</span></a>        <span class="n">keeppc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">regs</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">pcoffset</span>
</span><span id="Simulator-542"><a href="#Simulator-542"><span class="linenos">542</span></a>
</span><span id="Simulator-543"><a href="#Simulator-543"><span class="linenos">543</span></a>        <span class="n">currentCallStackLen</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">callStack</span><span class="p">)</span>
</span><span id="Simulator-544"><a href="#Simulator-544"><span class="linenos">544</span></a>
</span><span id="Simulator-545"><a href="#Simulator-545"><span class="linenos">545</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stepMode</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;out&quot;</span><span class="p">,</span> <span class="s2">&quot;run&quot;</span><span class="p">,</span> <span class="s2">&quot;forward&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">isFirstInst</span><span class="p">:</span>
</span><span id="Simulator-546"><a href="#Simulator-546"><span class="linenos">546</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bkptLastFetch</span><span class="p">:</span>
</span><span id="Simulator-547"><a href="#Simulator-547"><span class="linenos">547</span></a>                <span class="c1"># We hit a breakpoint on the last decoded instruction</span>
</span><span id="Simulator-548"><a href="#Simulator-548"><span class="linenos">548</span></a>                <span class="n">err</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bkptLastFetch</span>
</span><span id="Simulator-549"><a href="#Simulator-549"><span class="linenos">549</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">bkptLastFetch</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Simulator-550"><a href="#Simulator-550"><span class="linenos">550</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">restartCycle</span><span class="p">()</span>
</span><span id="Simulator-551"><a href="#Simulator-551"><span class="linenos">551</span></a>                <span class="k">raise</span> <span class="n">err</span>
</span><span id="Simulator-552"><a href="#Simulator-552"><span class="linenos">552</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="Simulator-553"><a href="#Simulator-553"><span class="linenos">553</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">currentInstr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span id="Simulator-554"><a href="#Simulator-554"><span class="linenos">554</span></a>            <span class="k">except</span> <span class="n">Breakpoint</span> <span class="k">as</span> <span class="n">bp</span><span class="p">:</span>
</span><span id="Simulator-555"><a href="#Simulator-555"><span class="linenos">555</span></a>                <span class="c1"># We hit a breakpoint on READ/WRITE</span>
</span><span id="Simulator-556"><a href="#Simulator-556"><span class="linenos">556</span></a>                <span class="c1"># We temporary disable the raised breakpoint</span>
</span><span id="Simulator-557"><a href="#Simulator-557"><span class="linenos">557</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">deactivatedBkpts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span>
</span><span id="Simulator-558"><a href="#Simulator-558"><span class="linenos">558</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_toggleBreakpoint</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span>
</span><span id="Simulator-559"><a href="#Simulator-559"><span class="linenos">559</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">restartCycle</span><span class="p">()</span>
</span><span id="Simulator-560"><a href="#Simulator-560"><span class="linenos">560</span></a>                <span class="k">raise</span> <span class="n">bp</span>
</span><span id="Simulator-561"><a href="#Simulator-561"><span class="linenos">561</span></a>            <span class="k">except</span> <span class="n">ComponentException</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
</span><span id="Simulator-562"><a href="#Simulator-562"><span class="linenos">562</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">errorsPending</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">err</span><span class="o">.</span><span class="n">cmp</span><span class="p">,</span> <span class="n">err</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">getCurrentLine</span><span class="p">())</span>
</span><span id="Simulator-563"><a href="#Simulator-563"><span class="linenos">563</span></a>            <span class="k">except</span> <span class="n">ExecutionException</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
</span><span id="Simulator-564"><a href="#Simulator-564"><span class="linenos">564</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">errorsPending</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;execution&quot;</span><span class="p">,</span> <span class="n">err</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">getCurrentLine</span><span class="p">())</span>
</span><span id="Simulator-565"><a href="#Simulator-565"><span class="linenos">565</span></a>
</span><span id="Simulator-566"><a href="#Simulator-566"><span class="linenos">566</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Simulator-567"><a href="#Simulator-567"><span class="linenos">567</span></a>            <span class="c1"># In stepIn mode or this is the first step to be execute in this mode.</span>
</span><span id="Simulator-568"><a href="#Simulator-568"><span class="linenos">568</span></a>            <span class="c1"># Breakpoints are temporary deactivate</span>
</span><span id="Simulator-569"><a href="#Simulator-569"><span class="linenos">569</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="Simulator-570"><a href="#Simulator-570"><span class="linenos">570</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">deactivateAllBreakpoints</span><span class="p">()</span>
</span><span id="Simulator-571"><a href="#Simulator-571"><span class="linenos">571</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">currentInstr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span id="Simulator-572"><a href="#Simulator-572"><span class="linenos">572</span></a>            <span class="k">except</span> <span class="n">ComponentException</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
</span><span id="Simulator-573"><a href="#Simulator-573"><span class="linenos">573</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">errorsPending</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">err</span><span class="o">.</span><span class="n">cmp</span><span class="p">,</span> <span class="n">err</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">getCurrentLine</span><span class="p">())</span>
</span><span id="Simulator-574"><a href="#Simulator-574"><span class="linenos">574</span></a>            <span class="k">except</span> <span class="n">ExecutionException</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
</span><span id="Simulator-575"><a href="#Simulator-575"><span class="linenos">575</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">errorsPending</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;execution&quot;</span><span class="p">,</span> <span class="n">err</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">getCurrentLine</span><span class="p">())</span>
</span><span id="Simulator-576"><a href="#Simulator-576"><span class="linenos">576</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">reactivateAllBreakpoints</span><span class="p">()</span>
</span><span id="Simulator-577"><a href="#Simulator-577"><span class="linenos">577</span></a>
</span><span id="Simulator-578"><a href="#Simulator-578"><span class="linenos">578</span></a>        <span class="c1"># After instruction execution, restore all breakpoints</span>
</span><span id="Simulator-579"><a href="#Simulator-579"><span class="linenos">579</span></a>        <span class="k">for</span> <span class="n">bp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">deactivatedBkpts</span><span class="p">:</span>
</span><span id="Simulator-580"><a href="#Simulator-580"><span class="linenos">580</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_toggleBreakpoint</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span>
</span><span id="Simulator-581"><a href="#Simulator-581"><span class="linenos">581</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">deactivatedBkpts</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Simulator-582"><a href="#Simulator-582"><span class="linenos">582</span></a>
</span><span id="Simulator-583"><a href="#Simulator-583"><span class="linenos">583</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentInstr</span><span class="o">.</span><span class="n">pcmodified</span><span class="p">:</span>
</span><span id="Simulator-584"><a href="#Simulator-584"><span class="linenos">584</span></a>            <span class="c1"># If PC was modified, we simulate the prefetch by adding 8 immediately to it</span>
</span><span id="Simulator-585"><a href="#Simulator-585"><span class="linenos">585</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">regs</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pcoffset</span>
</span><span id="Simulator-586"><a href="#Simulator-586"><span class="linenos">586</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Simulator-587"><a href="#Simulator-587"><span class="linenos">587</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">regs</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">4</span>  <span class="c1"># PC = PC + 4</span>
</span><span id="Simulator-588"><a href="#Simulator-588"><span class="linenos">588</span></a>
</span><span id="Simulator-589"><a href="#Simulator-589"><span class="linenos">589</span></a>        <span class="n">newpc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">regs</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">pcoffset</span>
</span><span id="Simulator-590"><a href="#Simulator-590"><span class="linenos">590</span></a>        <span class="k">if</span> <span class="n">keeppc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertionCkpts</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentInstr</span><span class="o">.</span><span class="n">pcmodified</span><span class="p">:</span>
</span><span id="Simulator-591"><a href="#Simulator-591"><span class="linenos">591</span></a>            <span class="c1"># We check if we&#39;ve hit an post-assertion checkpoint</span>
</span><span id="Simulator-592"><a href="#Simulator-592"><span class="linenos">592</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">execAssert</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">assertionData</span><span class="p">[</span><span class="n">keeppc</span><span class="p">],</span> <span class="s2">&quot;AFTER&quot;</span><span class="p">)</span>
</span><span id="Simulator-593"><a href="#Simulator-593"><span class="linenos">593</span></a>        <span class="k">elif</span> <span class="n">currentCallStackLen</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">callStack</span><span class="p">):</span>
</span><span id="Simulator-594"><a href="#Simulator-594"><span class="linenos">594</span></a>            <span class="c1"># We have branched out of a function</span>
</span><span id="Simulator-595"><a href="#Simulator-595"><span class="linenos">595</span></a>            <span class="c1"># If an assertion was following a BL and we exited a function, we want to execute it now!</span>
</span><span id="Simulator-596"><a href="#Simulator-596"><span class="linenos">596</span></a>            <span class="k">if</span> <span class="p">(</span>
</span><span id="Simulator-597"><a href="#Simulator-597"><span class="linenos">597</span></a>                <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">callStack</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertionWhenReturn</span>
</span><span id="Simulator-598"><a href="#Simulator-598"><span class="linenos">598</span></a>                <span class="ow">and</span> <span class="p">(</span><span class="n">newpc</span> <span class="o">-</span> <span class="mi">4</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertionCkpts</span>
</span><span id="Simulator-599"><a href="#Simulator-599"><span class="linenos">599</span></a>            <span class="p">):</span>
</span><span id="Simulator-600"><a href="#Simulator-600"><span class="linenos">600</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">execAssert</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">assertionData</span><span class="p">[</span><span class="n">newpc</span> <span class="o">-</span> <span class="mi">4</span><span class="p">],</span> <span class="s2">&quot;AFTER&quot;</span><span class="p">)</span>
</span><span id="Simulator-601"><a href="#Simulator-601"><span class="linenos">601</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">assertionWhenReturn</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">callStack</span><span class="p">))</span>
</span><span id="Simulator-602"><a href="#Simulator-602"><span class="linenos">602</span></a>        <span class="k">elif</span> <span class="n">currentCallStackLen</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">callStack</span><span class="p">):</span>
</span><span id="Simulator-603"><a href="#Simulator-603"><span class="linenos">603</span></a>            <span class="c1"># We have branched in a function</span>
</span><span id="Simulator-604"><a href="#Simulator-604"><span class="linenos">604</span></a>            <span class="c1"># We want to remember that we want to assert something when we return</span>
</span><span id="Simulator-605"><a href="#Simulator-605"><span class="linenos">605</span></a>            <span class="k">if</span> <span class="n">keeppc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertionCkpts</span><span class="p">:</span>
</span><span id="Simulator-606"><a href="#Simulator-606"><span class="linenos">606</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">assertionWhenReturn</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">currentCallStackLen</span><span class="p">)</span>
</span><span id="Simulator-607"><a href="#Simulator-607"><span class="linenos">607</span></a>
</span><span id="Simulator-608"><a href="#Simulator-608"><span class="linenos">608</span></a>        <span class="k">if</span> <span class="n">newpc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertionCkpts</span><span class="p">:</span>
</span><span id="Simulator-609"><a href="#Simulator-609"><span class="linenos">609</span></a>            <span class="c1"># We check if we&#39;ve hit an pre-assertion checkpoint (for the next instruction)</span>
</span><span id="Simulator-610"><a href="#Simulator-610"><span class="linenos">610</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">execAssert</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">assertionData</span><span class="p">[</span><span class="n">newpc</span><span class="p">],</span> <span class="s2">&quot;BEFORE&quot;</span><span class="p">)</span>
</span><span id="Simulator-611"><a href="#Simulator-611"><span class="linenos">611</span></a>
</span><span id="Simulator-612"><a href="#Simulator-612"><span class="linenos">612</span></a>        <span class="c1"># We look for interrupts</span>
</span><span id="Simulator-613"><a href="#Simulator-613"><span class="linenos">613</span></a>        <span class="c1"># The current instruction is always finished before the interrupt takes on</span>
</span><span id="Simulator-614"><a href="#Simulator-614"><span class="linenos">614</span></a>        <span class="c1"># TODO Handle special cases for LDM and STM</span>
</span><span id="Simulator-615"><a href="#Simulator-615"><span class="linenos">615</span></a>        <span class="k">if</span> <span class="p">(</span>
</span><span id="Simulator-616"><a href="#Simulator-616"><span class="linenos">616</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">interruptActive</span>
</span><span id="Simulator-617"><a href="#Simulator-617"><span class="linenos">617</span></a>            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">cyclesCount</span>
</span><span id="Simulator-618"><a href="#Simulator-618"><span class="linenos">618</span></a>            <span class="o">&gt;=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">interruptParams</span><span class="p">[</span><span class="s2">&quot;t0&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">interruptParams</span><span class="p">[</span><span class="s2">&quot;b&quot;</span><span class="p">])</span>
</span><span id="Simulator-619"><a href="#Simulator-619"><span class="linenos">619</span></a>            <span class="ow">and</span> <span class="p">(</span>
</span><span id="Simulator-620"><a href="#Simulator-620"><span class="linenos">620</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">cyclesCount</span>
</span><span id="Simulator-621"><a href="#Simulator-621"><span class="linenos">621</span></a>                <span class="o">-</span> <span class="mi">1</span>
</span><span id="Simulator-622"><a href="#Simulator-622"><span class="linenos">622</span></a>                <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">interruptParams</span><span class="p">[</span><span class="s2">&quot;t0&quot;</span><span class="p">]</span>
</span><span id="Simulator-623"><a href="#Simulator-623"><span class="linenos">623</span></a>                <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">interruptParams</span><span class="p">[</span><span class="s2">&quot;b&quot;</span><span class="p">]</span>
</span><span id="Simulator-624"><a href="#Simulator-624"><span class="linenos">624</span></a>            <span class="p">)</span>
</span><span id="Simulator-625"><a href="#Simulator-625"><span class="linenos">625</span></a>            <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">interruptParams</span><span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">]</span>
</span><span id="Simulator-626"><a href="#Simulator-626"><span class="linenos">626</span></a>            <span class="o">==</span> <span class="mi">0</span>
</span><span id="Simulator-627"><a href="#Simulator-627"><span class="linenos">627</span></a>        <span class="p">):</span>
</span><span id="Simulator-628"><a href="#Simulator-628"><span class="linenos">628</span></a>            <span class="k">if</span> <span class="p">(</span>
</span><span id="Simulator-629"><a href="#Simulator-629"><span class="linenos">629</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">interruptParams</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;FIQ&quot;</span>
</span><span id="Simulator-630"><a href="#Simulator-630"><span class="linenos">630</span></a>                <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">regs</span><span class="o">.</span><span class="n">FIQ</span>
</span><span id="Simulator-631"><a href="#Simulator-631"><span class="linenos">631</span></a>                <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">interruptParams</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;IRQ&quot;</span>
</span><span id="Simulator-632"><a href="#Simulator-632"><span class="linenos">632</span></a>                <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">regs</span><span class="o">.</span><span class="n">IRQ</span>
</span><span id="Simulator-633"><a href="#Simulator-633"><span class="linenos">633</span></a>                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">regs</span><span class="o">.</span><span class="n">mode</span> <span class="o">!=</span> <span class="s2">&quot;FIQ&quot;</span>
</span><span id="Simulator-634"><a href="#Simulator-634"><span class="linenos">634</span></a>            <span class="p">):</span>  <span class="c1"># Is the interrupt masked?</span>
</span><span id="Simulator-635"><a href="#Simulator-635"><span class="linenos">635</span></a>                <span class="c1"># Interruption!</span>
</span><span id="Simulator-636"><a href="#Simulator-636"><span class="linenos">636</span></a>                <span class="c1"># We enter it (the entry point is 0x18 for IRQ and 0x1C for FIQ)</span>
</span><span id="Simulator-637"><a href="#Simulator-637"><span class="linenos">637</span></a>                <span class="n">savedCPSR</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">regs</span><span class="o">.</span><span class="n">CPSR</span>  <span class="c1"># Keep CPSR before changing processor mode</span>
</span><span id="Simulator-638"><a href="#Simulator-638"><span class="linenos">638</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">regs</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interruptParams</span><span class="p">[</span>
</span><span id="Simulator-639"><a href="#Simulator-639"><span class="linenos">639</span></a>                    <span class="s2">&quot;type&quot;</span>
</span><span id="Simulator-640"><a href="#Simulator-640"><span class="linenos">640</span></a>                <span class="p">]</span>  <span class="c1"># Set the register bank and processor mode</span>
</span><span id="Simulator-641"><a href="#Simulator-641"><span class="linenos">641</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">regs</span><span class="o">.</span><span class="n">SPSR</span> <span class="o">=</span> <span class="n">savedCPSR</span>  <span class="c1"># Save the CPSR in the current SPSR</span>
</span><span id="Simulator-642"><a href="#Simulator-642"><span class="linenos">642</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">regs</span><span class="o">.</span><span class="n">IRQ</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="Simulator-643"><a href="#Simulator-643"><span class="linenos">643</span></a>                    <span class="kc">True</span>  <span class="c1"># IRQ are always disabled when we enter an interrupt</span>
</span><span id="Simulator-644"><a href="#Simulator-644"><span class="linenos">644</span></a>                <span class="p">)</span>
</span><span id="Simulator-645"><a href="#Simulator-645"><span class="linenos">645</span></a>                <span class="k">if</span> <span class="p">(</span>
</span><span id="Simulator-646"><a href="#Simulator-646"><span class="linenos">646</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">interruptParams</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;FIQ&quot;</span>
</span><span id="Simulator-647"><a href="#Simulator-647"><span class="linenos">647</span></a>                <span class="p">):</span>  <span class="c1"># If we enter a FIQ interrupt,</span>
</span><span id="Simulator-648"><a href="#Simulator-648"><span class="linenos">648</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">regs</span><span class="o">.</span><span class="n">FIQ</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1">#   then we disable also FIQ interrupts</span>
</span><span id="Simulator-649"><a href="#Simulator-649"><span class="linenos">649</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">regs</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="Simulator-650"><a href="#Simulator-650"><span class="linenos">650</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">regs</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">-</span> <span class="mi">4</span>
</span><span id="Simulator-651"><a href="#Simulator-651"><span class="linenos">651</span></a>                <span class="p">)</span>  <span class="c1"># Save PC in LR (on the FIQ or IRQ bank)</span>
</span><span id="Simulator-652"><a href="#Simulator-652"><span class="linenos">652</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">regs</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pcoffset</span> <span class="o">+</span> <span class="p">(</span>
</span><span id="Simulator-653"><a href="#Simulator-653"><span class="linenos">653</span></a>                    <span class="mh">0x18</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interruptParams</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;IRQ&quot;</span> <span class="k">else</span> <span class="mh">0x1C</span>
</span><span id="Simulator-654"><a href="#Simulator-654"><span class="linenos">654</span></a>                <span class="p">)</span>  <span class="c1"># Set PC to enter the interrupt</span>
</span><span id="Simulator-655"><a href="#Simulator-655"><span class="linenos">655</span></a>
</span><span id="Simulator-656"><a href="#Simulator-656"><span class="linenos">656</span></a>        <span class="c1"># We fetch and decode the next instruction</span>
</span><span id="Simulator-657"><a href="#Simulator-657"><span class="linenos">657</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fetchAndDecode</span><span class="p">(</span><span class="n">forceExplain</span><span class="p">)</span>
</span><span id="Simulator-658"><a href="#Simulator-658"><span class="linenos">658</span></a>
</span><span id="Simulator-659"><a href="#Simulator-659"><span class="linenos">659</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">errorsPending</span><span class="p">:</span>
</span><span id="Simulator-660"><a href="#Simulator-660"><span class="linenos">660</span></a>            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">errorsPending</span>
</span><span id="Simulator-661"><a href="#Simulator-661"><span class="linenos">661</span></a>
</span><span id="Simulator-662"><a href="#Simulator-662"><span class="linenos">662</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">deactivateAllBreakpoints</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Simulator-663"><a href="#Simulator-663"><span class="linenos">663</span></a>        <span class="c1"># Without removing them, do not trig on breakpoint until `reactivateAllBreakpoints`</span>
</span><span id="Simulator-664"><a href="#Simulator-664"><span class="linenos">664</span></a>        <span class="c1"># is called. Useful to temporary disable breakpoints of Memory and Registers</span>
</span><span id="Simulator-665"><a href="#Simulator-665"><span class="linenos">665</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">regs</span><span class="o">.</span><span class="n">deactivateBreakpoints</span><span class="p">()</span>
</span><span id="Simulator-666"><a href="#Simulator-666"><span class="linenos">666</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mem</span><span class="o">.</span><span class="n">deactivateBreakpoints</span><span class="p">()</span>
</span><span id="Simulator-667"><a href="#Simulator-667"><span class="linenos">667</span></a>
</span><span id="Simulator-668"><a href="#Simulator-668"><span class="linenos">668</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">reactivateAllBreakpoints</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Simulator-669"><a href="#Simulator-669"><span class="linenos">669</span></a>        <span class="c1"># See `deactivateAllBreakpoints`</span>
</span><span id="Simulator-670"><a href="#Simulator-670"><span class="linenos">670</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">regs</span><span class="o">.</span><span class="n">reactivateBreakpoints</span><span class="p">()</span>
</span><span id="Simulator-671"><a href="#Simulator-671"><span class="linenos">671</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mem</span><span class="o">.</span><span class="n">reactivateBreakpoints</span><span class="p">()</span>
</span><span id="Simulator-672"><a href="#Simulator-672"><span class="linenos">672</span></a>
</span><span id="Simulator-673"><a href="#Simulator-673"><span class="linenos">673</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">getCurrentLine</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Simulator-674"><a href="#Simulator-674"><span class="linenos">674</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">regs</span><span class="o">.</span><span class="n">deactivateBreakpoints</span><span class="p">()</span>
</span><span id="Simulator-675"><a href="#Simulator-675"><span class="linenos">675</span></a>        <span class="n">pc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">regs</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span>
</span><span id="Simulator-676"><a href="#Simulator-676"><span class="linenos">676</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">regs</span><span class="o">.</span><span class="n">reactivateBreakpoints</span><span class="p">()</span>
</span><span id="Simulator-677"><a href="#Simulator-677"><span class="linenos">677</span></a>        <span class="n">pc</span> <span class="o">-=</span> <span class="mi">8</span> <span class="k">if</span> <span class="n">getSetting</span><span class="p">(</span><span class="s2">&quot;PCbehavior&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;+8&quot;</span> <span class="k">else</span> <span class="mi">0</span>
</span><span id="Simulator-678"><a href="#Simulator-678"><span class="linenos">678</span></a>        <span class="k">if</span> <span class="n">pc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">addr2line</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">addr2line</span><span class="p">[</span><span class="n">pc</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Simulator-679"><a href="#Simulator-679"><span class="linenos">679</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">addr2line</span><span class="p">[</span><span class="n">pc</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Simulator-680"><a href="#Simulator-680"><span class="linenos">680</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Simulator-681"><a href="#Simulator-681"><span class="linenos">681</span></a>            <span class="k">return</span> <span class="kc">None</span>
</span><span id="Simulator-682"><a href="#Simulator-682"><span class="linenos">682</span></a>
</span><span id="Simulator-683"><a href="#Simulator-683"><span class="linenos">683</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_toggleBreakpoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bkptException</span><span class="p">):</span>
</span><span id="Simulator-684"><a href="#Simulator-684"><span class="linenos">684</span></a>        <span class="k">if</span> <span class="n">bkptException</span><span class="o">.</span><span class="n">cmp</span> <span class="o">==</span> <span class="s2">&quot;memory&quot;</span><span class="p">:</span>
</span><span id="Simulator-685"><a href="#Simulator-685"><span class="linenos">685</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">mem</span><span class="o">.</span><span class="n">toggleBreakpoint</span><span class="p">(</span><span class="n">bkptException</span><span class="o">.</span><span class="n">info</span><span class="p">,</span> <span class="n">bkptException</span><span class="o">.</span><span class="n">mode</span><span class="p">)</span>
</span><span id="Simulator-686"><a href="#Simulator-686"><span class="linenos">686</span></a>        <span class="k">elif</span> <span class="n">bkptException</span><span class="o">.</span><span class="n">cmp</span> <span class="o">==</span> <span class="s2">&quot;register&quot;</span><span class="p">:</span>
</span><span id="Simulator-687"><a href="#Simulator-687"><span class="linenos">687</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">regs</span><span class="o">.</span><span class="n">toggleBreakpointOnRegister</span><span class="p">(</span>
</span><span id="Simulator-688"><a href="#Simulator-688"><span class="linenos">688</span></a>                <span class="n">bkptException</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bkptException</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">bkptException</span><span class="o">.</span><span class="n">mode</span>
</span><span id="Simulator-689"><a href="#Simulator-689"><span class="linenos">689</span></a>            <span class="p">)</span>
</span><span id="Simulator-690"><a href="#Simulator-690"><span class="linenos">690</span></a>        <span class="k">elif</span> <span class="n">bkptException</span><span class="o">.</span><span class="n">cmp</span> <span class="o">==</span> <span class="s2">&quot;flags&quot;</span><span class="p">:</span>
</span><span id="Simulator-691"><a href="#Simulator-691"><span class="linenos">691</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">regs</span><span class="o">.</span><span class="n">toggleBreakpointOnFlag</span><span class="p">(</span><span class="n">bkptException</span><span class="o">.</span><span class="n">info</span><span class="p">,</span> <span class="n">bkptException</span><span class="o">.</span><span class="n">mode</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Main simulator class.
None of its method should be called directly by the UI,
everything should pass through bytecodeinterpreter class.</p>
</div>


                            <div id="Simulator.__init__" class="classattr">
                                        <input id="Simulator.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">Simulator</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">memorycontent</span>, </span><span class="param"><span class="n">assertionTriggers</span>, </span><span class="param"><span class="n">addr2line</span>, </span><span class="param"><span class="n">pcInitValue</span><span class="o">=</span><span class="mi">0</span></span>)</span>

                <label class="view-source-button" for="Simulator.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Simulator.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Simulator.__init__-67"><a href="#Simulator.__init__-67"><span class="linenos"> 67</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">memorycontent</span><span class="p">,</span> <span class="n">assertionTriggers</span><span class="p">,</span> <span class="n">addr2line</span><span class="p">,</span> <span class="n">pcInitValue</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
</span><span id="Simulator.__init__-68"><a href="#Simulator.__init__-68"><span class="linenos"> 68</span></a>        <span class="c1"># Parameters</span>
</span><span id="Simulator.__init__-69"><a href="#Simulator.__init__-69"><span class="linenos"> 69</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pcoffset</span> <span class="o">=</span> <span class="mi">8</span> <span class="k">if</span> <span class="n">getSetting</span><span class="p">(</span><span class="s2">&quot;PCbehavior&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;+8&quot;</span> <span class="k">else</span> <span class="mi">0</span>
</span><span id="Simulator.__init__-70"><a href="#Simulator.__init__-70"><span class="linenos"> 70</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">PCSpecialBehavior</span> <span class="o">=</span> <span class="n">getSetting</span><span class="p">(</span><span class="s2">&quot;PCspecialbehavior&quot;</span><span class="p">)</span>
</span><span id="Simulator.__init__-71"><a href="#Simulator.__init__-71"><span class="linenos"> 71</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">allowSwitchModeInUserMode</span> <span class="o">=</span> <span class="n">getSetting</span><span class="p">(</span><span class="s2">&quot;allowuserswitchmode&quot;</span><span class="p">)</span>
</span><span id="Simulator.__init__-72"><a href="#Simulator.__init__-72"><span class="linenos"> 72</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">maxit</span> <span class="o">=</span> <span class="n">getSetting</span><span class="p">(</span><span class="s2">&quot;runmaxit&quot;</span><span class="p">)</span>
</span><span id="Simulator.__init__-73"><a href="#Simulator.__init__-73"><span class="linenos"> 73</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">bkptLastFetch</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Simulator.__init__-74"><a href="#Simulator.__init__-74"><span class="linenos"> 74</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">deactivatedBkpts</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Simulator.__init__-75"><a href="#Simulator.__init__-75"><span class="linenos"> 75</span></a>
</span><span id="Simulator.__init__-76"><a href="#Simulator.__init__-76"><span class="linenos"> 76</span></a>        <span class="c1"># Initialize history</span>
</span><span id="Simulator.__init__-77"><a href="#Simulator.__init__-77"><span class="linenos"> 77</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">history</span> <span class="o">=</span> <span class="n">History</span><span class="p">()</span>
</span><span id="Simulator.__init__-78"><a href="#Simulator.__init__-78"><span class="linenos"> 78</span></a>
</span><span id="Simulator.__init__-79"><a href="#Simulator.__init__-79"><span class="linenos"> 79</span></a>        <span class="c1"># Initialize components</span>
</span><span id="Simulator.__init__-80"><a href="#Simulator.__init__-80"><span class="linenos"> 80</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mem</span> <span class="o">=</span> <span class="n">Memory</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">,</span> <span class="n">memorycontent</span><span class="p">)</span>
</span><span id="Simulator.__init__-81"><a href="#Simulator.__init__-81"><span class="linenos"> 81</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">regs</span> <span class="o">=</span> <span class="n">Registers</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">)</span>
</span><span id="Simulator.__init__-82"><a href="#Simulator.__init__-82"><span class="linenos"> 82</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pcInitVal</span> <span class="o">=</span> <span class="n">pcInitValue</span>
</span><span id="Simulator.__init__-83"><a href="#Simulator.__init__-83"><span class="linenos"> 83</span></a>
</span><span id="Simulator.__init__-84"><a href="#Simulator.__init__-84"><span class="linenos"> 84</span></a>        <span class="c1"># Initialize decoders</span>
</span><span id="Simulator.__init__-85"><a href="#Simulator.__init__-85"><span class="linenos"> 85</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">decoders</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="Simulator.__init__-86"><a href="#Simulator.__init__-86"><span class="linenos"> 86</span></a>            <span class="s2">&quot;BranchOp&quot;</span><span class="p">:</span> <span class="n">BranchOp</span><span class="p">(),</span>
</span><span id="Simulator.__init__-87"><a href="#Simulator.__init__-87"><span class="linenos"> 87</span></a>            <span class="s2">&quot;DataOp&quot;</span><span class="p">:</span> <span class="n">DataOp</span><span class="p">(),</span>
</span><span id="Simulator.__init__-88"><a href="#Simulator.__init__-88"><span class="linenos"> 88</span></a>            <span class="s2">&quot;MemOp&quot;</span><span class="p">:</span> <span class="n">MemOp</span><span class="p">(),</span>
</span><span id="Simulator.__init__-89"><a href="#Simulator.__init__-89"><span class="linenos"> 89</span></a>            <span class="s2">&quot;MultipleMemOp&quot;</span><span class="p">:</span> <span class="n">MultipleMemOp</span><span class="p">(),</span>
</span><span id="Simulator.__init__-90"><a href="#Simulator.__init__-90"><span class="linenos"> 90</span></a>            <span class="s2">&quot;HalfSignedMemOp&quot;</span><span class="p">:</span> <span class="n">HalfSignedMemOp</span><span class="p">(),</span>
</span><span id="Simulator.__init__-91"><a href="#Simulator.__init__-91"><span class="linenos"> 91</span></a>            <span class="s2">&quot;SwapOp&quot;</span><span class="p">:</span> <span class="n">SwapOp</span><span class="p">(),</span>
</span><span id="Simulator.__init__-92"><a href="#Simulator.__init__-92"><span class="linenos"> 92</span></a>            <span class="s2">&quot;PSROp&quot;</span><span class="p">:</span> <span class="n">PSROp</span><span class="p">(),</span>
</span><span id="Simulator.__init__-93"><a href="#Simulator.__init__-93"><span class="linenos"> 93</span></a>            <span class="s2">&quot;MulOp&quot;</span><span class="p">:</span> <span class="n">MulOp</span><span class="p">(),</span>
</span><span id="Simulator.__init__-94"><a href="#Simulator.__init__-94"><span class="linenos"> 94</span></a>            <span class="s2">&quot;MulLongOp&quot;</span><span class="p">:</span> <span class="n">MulLongOp</span><span class="p">(),</span>
</span><span id="Simulator.__init__-95"><a href="#Simulator.__init__-95"><span class="linenos"> 95</span></a>            <span class="s2">&quot;SoftInterruptOp&quot;</span><span class="p">:</span> <span class="n">SoftInterruptOp</span><span class="p">(),</span>
</span><span id="Simulator.__init__-96"><a href="#Simulator.__init__-96"><span class="linenos"> 96</span></a>            <span class="s2">&quot;NopOp&quot;</span><span class="p">:</span> <span class="n">NopOp</span><span class="p">(),</span>
</span><span id="Simulator.__init__-97"><a href="#Simulator.__init__-97"><span class="linenos"> 97</span></a>        <span class="p">}</span>
</span><span id="Simulator.__init__-98"><a href="#Simulator.__init__-98"><span class="linenos"> 98</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">decoderCache</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="Simulator.__init__-99"><a href="#Simulator.__init__-99"><span class="linenos"> 99</span></a>
</span><span id="Simulator.__init__-100"><a href="#Simulator.__init__-100"><span class="linenos">100</span></a>        <span class="c1"># Initialize assertion structures</span>
</span><span id="Simulator.__init__-101"><a href="#Simulator.__init__-101"><span class="linenos">101</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">assertionCkpts</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">assertionTriggers</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</span><span id="Simulator.__init__-102"><a href="#Simulator.__init__-102"><span class="linenos">102</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">assertionData</span> <span class="o">=</span> <span class="n">assertionTriggers</span>
</span><span id="Simulator.__init__-103"><a href="#Simulator.__init__-103"><span class="linenos">103</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">assertionWhenReturn</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span><span id="Simulator.__init__-104"><a href="#Simulator.__init__-104"><span class="linenos">104</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">callStack</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Simulator.__init__-105"><a href="#Simulator.__init__-105"><span class="linenos">105</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">addr2line</span> <span class="o">=</span> <span class="n">addr2line</span>
</span><span id="Simulator.__init__-106"><a href="#Simulator.__init__-106"><span class="linenos">106</span></a>
</span><span id="Simulator.__init__-107"><a href="#Simulator.__init__-107"><span class="linenos">107</span></a>        <span class="c1"># Initialize execution errors buffer</span>
</span><span id="Simulator.__init__-108"><a href="#Simulator.__init__-108"><span class="linenos">108</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">errorsPending</span> <span class="o">=</span> <span class="n">MultipleErrors</span><span class="p">()</span>
</span><span id="Simulator.__init__-109"><a href="#Simulator.__init__-109"><span class="linenos">109</span></a>
</span><span id="Simulator.__init__-110"><a href="#Simulator.__init__-110"><span class="linenos">110</span></a>        <span class="c1"># Initialize interrupt structures</span>
</span><span id="Simulator.__init__-111"><a href="#Simulator.__init__-111"><span class="linenos">111</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">interruptActive</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="Simulator.__init__-112"><a href="#Simulator.__init__-112"><span class="linenos">112</span></a>        <span class="c1"># Interrupt trigged at each a*(t-t0) + b cycles</span>
</span><span id="Simulator.__init__-113"><a href="#Simulator.__init__-113"><span class="linenos">113</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">interruptParams</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;b&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;t0&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;FIQ&quot;</span><span class="p">}</span>
</span><span id="Simulator.__init__-114"><a href="#Simulator.__init__-114"><span class="linenos">114</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">lastInterruptCycle</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
</span><span id="Simulator.__init__-115"><a href="#Simulator.__init__-115"><span class="linenos">115</span></a>
</span><span id="Simulator.__init__-116"><a href="#Simulator.__init__-116"><span class="linenos">116</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stepMode</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Simulator.__init__-117"><a href="#Simulator.__init__-117"><span class="linenos">117</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stepCondition</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="Simulator.__init__-118"><a href="#Simulator.__init__-118"><span class="linenos">118</span></a>        <span class="c1"># Used to stop the simulator after n iterations in run mode</span>
</span><span id="Simulator.__init__-119"><a href="#Simulator.__init__-119"><span class="linenos">119</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">runIteration</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="Simulator.__init__-120"><a href="#Simulator.__init__-120"><span class="linenos">120</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
</span></pre></div>


    

                            </div>
                            <div id="Simulator.PC" class="classattr">
                                <div class="attr variable">
            <span class="name">PC</span>        =
<span class="default_value">15</span>

        
    </div>
    <a class="headerlink" href="#Simulator.PC"></a>
    
    

                            </div>
                            <div id="Simulator.pcoffset" class="classattr">
                                <div class="attr variable">
            <span class="name">pcoffset</span>

        
    </div>
    <a class="headerlink" href="#Simulator.pcoffset"></a>
    
    

                            </div>
                            <div id="Simulator.PCSpecialBehavior" class="classattr">
                                <div class="attr variable">
            <span class="name">PCSpecialBehavior</span>

        
    </div>
    <a class="headerlink" href="#Simulator.PCSpecialBehavior"></a>
    
    

                            </div>
                            <div id="Simulator.allowSwitchModeInUserMode" class="classattr">
                                <div class="attr variable">
            <span class="name">allowSwitchModeInUserMode</span>

        
    </div>
    <a class="headerlink" href="#Simulator.allowSwitchModeInUserMode"></a>
    
    

                            </div>
                            <div id="Simulator.maxit" class="classattr">
                                <div class="attr variable">
            <span class="name">maxit</span>

        
    </div>
    <a class="headerlink" href="#Simulator.maxit"></a>
    
    

                            </div>
                            <div id="Simulator.bkptLastFetch" class="classattr">
                                <div class="attr variable">
            <span class="name">bkptLastFetch</span>

        
    </div>
    <a class="headerlink" href="#Simulator.bkptLastFetch"></a>
    
    

                            </div>
                            <div id="Simulator.deactivatedBkpts" class="classattr">
                                <div class="attr variable">
            <span class="name">deactivatedBkpts</span>

        
    </div>
    <a class="headerlink" href="#Simulator.deactivatedBkpts"></a>
    
    

                            </div>
                            <div id="Simulator.history" class="classattr">
                                <div class="attr variable">
            <span class="name">history</span>

        
    </div>
    <a class="headerlink" href="#Simulator.history"></a>
    
    

                            </div>
                            <div id="Simulator.mem" class="classattr">
                                <div class="attr variable">
            <span class="name">mem</span>

        
    </div>
    <a class="headerlink" href="#Simulator.mem"></a>
    
    

                            </div>
                            <div id="Simulator.regs" class="classattr">
                                <div class="attr variable">
            <span class="name">regs</span>

        
    </div>
    <a class="headerlink" href="#Simulator.regs"></a>
    
    

                            </div>
                            <div id="Simulator.pcInitVal" class="classattr">
                                <div class="attr variable">
            <span class="name">pcInitVal</span>

        
    </div>
    <a class="headerlink" href="#Simulator.pcInitVal"></a>
    
    

                            </div>
                            <div id="Simulator.decoders" class="classattr">
                                <div class="attr variable">
            <span class="name">decoders</span>

        
    </div>
    <a class="headerlink" href="#Simulator.decoders"></a>
    
    

                            </div>
                            <div id="Simulator.decoderCache" class="classattr">
                                <div class="attr variable">
            <span class="name">decoderCache</span>

        
    </div>
    <a class="headerlink" href="#Simulator.decoderCache"></a>
    
    

                            </div>
                            <div id="Simulator.assertionCkpts" class="classattr">
                                <div class="attr variable">
            <span class="name">assertionCkpts</span>

        
    </div>
    <a class="headerlink" href="#Simulator.assertionCkpts"></a>
    
    

                            </div>
                            <div id="Simulator.assertionData" class="classattr">
                                <div class="attr variable">
            <span class="name">assertionData</span>

        
    </div>
    <a class="headerlink" href="#Simulator.assertionData"></a>
    
    

                            </div>
                            <div id="Simulator.assertionWhenReturn" class="classattr">
                                <div class="attr variable">
            <span class="name">assertionWhenReturn</span>

        
    </div>
    <a class="headerlink" href="#Simulator.assertionWhenReturn"></a>
    
    

                            </div>
                            <div id="Simulator.callStack" class="classattr">
                                <div class="attr variable">
            <span class="name">callStack</span>

        
    </div>
    <a class="headerlink" href="#Simulator.callStack"></a>
    
    

                            </div>
                            <div id="Simulator.addr2line" class="classattr">
                                <div class="attr variable">
            <span class="name">addr2line</span>

        
    </div>
    <a class="headerlink" href="#Simulator.addr2line"></a>
    
    

                            </div>
                            <div id="Simulator.errorsPending" class="classattr">
                                <div class="attr variable">
            <span class="name">errorsPending</span>

        
    </div>
    <a class="headerlink" href="#Simulator.errorsPending"></a>
    
    

                            </div>
                            <div id="Simulator.interruptActive" class="classattr">
                                <div class="attr variable">
            <span class="name">interruptActive</span>

        
    </div>
    <a class="headerlink" href="#Simulator.interruptActive"></a>
    
    

                            </div>
                            <div id="Simulator.interruptParams" class="classattr">
                                <div class="attr variable">
            <span class="name">interruptParams</span>

        
    </div>
    <a class="headerlink" href="#Simulator.interruptParams"></a>
    
    

                            </div>
                            <div id="Simulator.lastInterruptCycle" class="classattr">
                                <div class="attr variable">
            <span class="name">lastInterruptCycle</span>

        
    </div>
    <a class="headerlink" href="#Simulator.lastInterruptCycle"></a>
    
    

                            </div>
                            <div id="Simulator.stepMode" class="classattr">
                                <div class="attr variable">
            <span class="name">stepMode</span>

        
    </div>
    <a class="headerlink" href="#Simulator.stepMode"></a>
    
    

                            </div>
                            <div id="Simulator.stepCondition" class="classattr">
                                <div class="attr variable">
            <span class="name">stepCondition</span>

        
    </div>
    <a class="headerlink" href="#Simulator.stepCondition"></a>
    
    

                            </div>
                            <div id="Simulator.runIteration" class="classattr">
                                <div class="attr variable">
            <span class="name">runIteration</span>

        
    </div>
    <a class="headerlink" href="#Simulator.runIteration"></a>
    
    

                            </div>
                            <div id="Simulator.reset" class="classattr">
                                        <input id="Simulator.reset-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">reset</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Simulator.reset-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Simulator.reset"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Simulator.reset-122"><a href="#Simulator.reset-122"><span class="linenos">122</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Simulator.reset-123"><a href="#Simulator.reset-123"><span class="linenos">123</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
</span><span id="Simulator.reset-124"><a href="#Simulator.reset-124"><span class="linenos">124</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">regs</span><span class="o">.</span><span class="n">banks</span><span class="p">[</span><span class="s2">&quot;User&quot;</span><span class="p">][</span><span class="mi">15</span><span class="p">]</span><span class="o">.</span><span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pcInitVal</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">pcoffset</span>
</span><span id="Simulator.reset-125"><a href="#Simulator.reset-125"><span class="linenos">125</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fetchAndDecode</span><span class="p">()</span>
</span><span id="Simulator.reset-126"><a href="#Simulator.reset-126"><span class="linenos">126</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">explainInstruction</span><span class="p">()</span>
</span></pre></div>


    

                            </div>
                            <div id="Simulator.getContext" class="classattr">
                                        <input id="Simulator.getContext-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">getContext</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Simulator.getContext-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Simulator.getContext"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Simulator.getContext-128"><a href="#Simulator.getContext-128"><span class="linenos">128</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">getContext</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Simulator.getContext-129"><a href="#Simulator.getContext-129"><span class="linenos">129</span></a>        <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;regs&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">regs</span><span class="o">.</span><span class="n">getContext</span><span class="p">(),</span> <span class="s2">&quot;mem&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">mem</span><span class="o">.</span><span class="n">getContext</span><span class="p">()}</span>
</span><span id="Simulator.getContext-130"><a href="#Simulator.getContext-130"><span class="linenos">130</span></a>        <span class="k">return</span> <span class="n">context</span>
</span></pre></div>


    

                            </div>
                            <div id="Simulator.setStepCondition" class="classattr">
                                        <input id="Simulator.setStepCondition-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">setStepCondition</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">stepMode</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Simulator.setStepCondition-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Simulator.setStepCondition"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Simulator.setStepCondition-132"><a href="#Simulator.setStepCondition-132"><span class="linenos">132</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">setStepCondition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stepMode</span><span class="p">):</span>
</span><span id="Simulator.setStepCondition-133"><a href="#Simulator.setStepCondition-133"><span class="linenos">133</span></a>        <span class="k">assert</span> <span class="n">stepMode</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;into&quot;</span><span class="p">,</span> <span class="s2">&quot;out&quot;</span><span class="p">,</span> <span class="s2">&quot;forward&quot;</span><span class="p">,</span> <span class="s2">&quot;run&quot;</span><span class="p">)</span>
</span><span id="Simulator.setStepCondition-134"><a href="#Simulator.setStepCondition-134"><span class="linenos">134</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stepMode</span> <span class="o">=</span> <span class="n">stepMode</span>
</span><span id="Simulator.setStepCondition-135"><a href="#Simulator.setStepCondition-135"><span class="linenos">135</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stepCondition</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="Simulator.setStepCondition-136"><a href="#Simulator.setStepCondition-136"><span class="linenos">136</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">runIteration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">cyclesCount</span>
</span></pre></div>


    

                            </div>
                            <div id="Simulator.isStepDone" class="classattr">
                                        <input id="Simulator.isStepDone-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">isStepDone</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Simulator.isStepDone-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Simulator.isStepDone"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Simulator.isStepDone-138"><a href="#Simulator.isStepDone-138"><span class="linenos">138</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">isStepDone</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Simulator.isStepDone-139"><a href="#Simulator.isStepDone-139"><span class="linenos">139</span></a>        <span class="n">maxCyclesReached</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">cyclesCount</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">runIteration</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxit</span>
</span><span id="Simulator.isStepDone-140"><a href="#Simulator.isStepDone-140"><span class="linenos">140</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stepMode</span> <span class="o">==</span> <span class="s2">&quot;forward&quot;</span><span class="p">:</span>
</span><span id="Simulator.isStepDone-141"><a href="#Simulator.isStepDone-141"><span class="linenos">141</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stepCondition</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="Simulator.isStepDone-142"><a href="#Simulator.isStepDone-142"><span class="linenos">142</span></a>                <span class="c1"># The instruction was a function call</span>
</span><span id="Simulator.isStepDone-143"><a href="#Simulator.isStepDone-143"><span class="linenos">143</span></a>                <span class="c1"># Now the step forward becomes a step out</span>
</span><span id="Simulator.isStepDone-144"><a href="#Simulator.isStepDone-144"><span class="linenos">144</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">stepMode</span> <span class="o">=</span> <span class="s2">&quot;out&quot;</span>
</span><span id="Simulator.isStepDone-145"><a href="#Simulator.isStepDone-145"><span class="linenos">145</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">stepCondition</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="Simulator.isStepDone-146"><a href="#Simulator.isStepDone-146"><span class="linenos">146</span></a>                <span class="k">return</span> <span class="kc">False</span>
</span><span id="Simulator.isStepDone-147"><a href="#Simulator.isStepDone-147"><span class="linenos">147</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Simulator.isStepDone-148"><a href="#Simulator.isStepDone-148"><span class="linenos">148</span></a>                <span class="k">return</span> <span class="kc">True</span>
</span><span id="Simulator.isStepDone-149"><a href="#Simulator.isStepDone-149"><span class="linenos">149</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stepMode</span> <span class="o">==</span> <span class="s2">&quot;out&quot;</span><span class="p">:</span>
</span><span id="Simulator.isStepDone-150"><a href="#Simulator.isStepDone-150"><span class="linenos">150</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">stepCondition</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">maxCyclesReached</span>
</span><span id="Simulator.isStepDone-151"><a href="#Simulator.isStepDone-151"><span class="linenos">151</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stepMode</span> <span class="o">==</span> <span class="s2">&quot;run&quot;</span><span class="p">:</span>
</span><span id="Simulator.isStepDone-152"><a href="#Simulator.isStepDone-152"><span class="linenos">152</span></a>            <span class="k">return</span> <span class="n">maxCyclesReached</span>
</span><span id="Simulator.isStepDone-153"><a href="#Simulator.isStepDone-153"><span class="linenos">153</span></a>
</span><span id="Simulator.isStepDone-154"><a href="#Simulator.isStepDone-154"><span class="linenos">154</span></a>        <span class="c1"># We are doing a step into, we always stop</span>
</span><span id="Simulator.isStepDone-155"><a href="#Simulator.isStepDone-155"><span class="linenos">155</span></a>        <span class="k">return</span> <span class="kc">True</span>
</span></pre></div>


    

                            </div>
                            <div id="Simulator.loop" class="classattr">
                                        <input id="Simulator.loop-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">loop</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Simulator.loop-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Simulator.loop"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Simulator.loop-157"><a href="#Simulator.loop-157"><span class="linenos">157</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">loop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Simulator.loop-158"><a href="#Simulator.loop-158"><span class="linenos">158</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Simulator.loop-159"><a href="#Simulator.loop-159"><span class="linenos">159</span></a><span class="sd">        Loop until the stopping criterion is met. Returns the aggregated list</span>
</span><span id="Simulator.loop-160"><a href="#Simulator.loop-160"><span class="linenos">160</span></a><span class="sd">        of changes since the beginning of the simulation loop.</span>
</span><span id="Simulator.loop-161"><a href="#Simulator.loop-161"><span class="linenos">161</span></a><span class="sd">        Stopping criterion can be set using `setStepCondition`.</span>
</span><span id="Simulator.loop-162"><a href="#Simulator.loop-162"><span class="linenos">162</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Simulator.loop-163"><a href="#Simulator.loop-163"><span class="linenos">163</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">setCheckpoint</span><span class="p">()</span>
</span><span id="Simulator.loop-164"><a href="#Simulator.loop-164"><span class="linenos">164</span></a>        <span class="k">for</span> <span class="n">decoder</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoders</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
</span><span id="Simulator.loop-165"><a href="#Simulator.loop-165"><span class="linenos">165</span></a>            <span class="n">decoder</span><span class="o">.</span><span class="n">resetExecCounters</span><span class="p">()</span>
</span><span id="Simulator.loop-166"><a href="#Simulator.loop-166"><span class="linenos">166</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">nextInstr</span><span class="p">()</span>  <span class="c1"># We always execute at least one instruction</span>
</span><span id="Simulator.loop-167"><a href="#Simulator.loop-167"><span class="linenos">167</span></a>        <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">isStepDone</span><span class="p">():</span>  <span class="c1"># We repeat until the stopping criterion is met</span>
</span><span id="Simulator.loop-168"><a href="#Simulator.loop-168"><span class="linenos">168</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">nextInstr</span><span class="p">()</span>
</span><span id="Simulator.loop-169"><a href="#Simulator.loop-169"><span class="linenos">169</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">explainInstruction</span><span class="p">()</span>  <span class="c1"># We only have to explain the last instruction executed before we stop</span>
</span></pre></div>


            <div class="docstring"><p>Loop until the stopping criterion is met. Returns the aggregated list
of changes since the beginning of the simulation loop.
Stopping criterion can be set using <code><a href="#Simulator.setStepCondition">setStepCondition</a></code>.</p>
</div>


                            </div>
                            <div id="Simulator.stepBack" class="classattr">
                                        <input id="Simulator.stepBack-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">stepBack</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">count</span><span class="o">=</span><span class="mi">1</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Simulator.stepBack-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Simulator.stepBack"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Simulator.stepBack-171"><a href="#Simulator.stepBack-171"><span class="linenos">171</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">stepBack</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
</span><span id="Simulator.stepBack-172"><a href="#Simulator.stepBack-172"><span class="linenos">172</span></a>        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">count</span><span class="p">):</span>
</span><span id="Simulator.stepBack-173"><a href="#Simulator.stepBack-173"><span class="linenos">173</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">stepBack</span><span class="p">()</span>
</span><span id="Simulator.stepBack-174"><a href="#Simulator.stepBack-174"><span class="linenos">174</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fetchAndDecode</span><span class="p">(</span><span class="n">forceExplain</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="Simulator.stepBack-175"><a href="#Simulator.stepBack-175"><span class="linenos">175</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">bkptLastFetch</span> <span class="o">=</span> <span class="kc">None</span>
</span></pre></div>


    

                            </div>
                            <div id="Simulator.executionStats" class="classattr">
                                        <input id="Simulator.executionStats-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">executionStats</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Simulator.executionStats-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Simulator.executionStats"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Simulator.executionStats-177"><a href="#Simulator.executionStats-177"><span class="linenos">177</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">executionStats</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Simulator.executionStats-178"><a href="#Simulator.executionStats-178"><span class="linenos">178</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Simulator.executionStats-179"><a href="#Simulator.executionStats-179"><span class="linenos">179</span></a><span class="sd">        Return a dictionary with the number of times each instruction type was executed</span>
</span><span id="Simulator.executionStats-180"><a href="#Simulator.executionStats-180"><span class="linenos">180</span></a><span class="sd">        in the last execution run.</span>
</span><span id="Simulator.executionStats-181"><a href="#Simulator.executionStats-181"><span class="linenos">181</span></a><span class="sd">        The types are:</span>
</span><span id="Simulator.executionStats-182"><a href="#Simulator.executionStats-182"><span class="linenos">182</span></a><span class="sd">        - &quot;data&quot; (includes all arithmetic and logic operations except multiply)</span>
</span><span id="Simulator.executionStats-183"><a href="#Simulator.executionStats-183"><span class="linenos">183</span></a><span class="sd">        - &quot;mem&quot; (includes all _single_ memory accesses including byte, half or word access and swap)</span>
</span><span id="Simulator.executionStats-184"><a href="#Simulator.executionStats-184"><span class="linenos">184</span></a><span class="sd">        - &quot;multiplemem&quot; (all _multiple_ memory accesses: LDM, STM, POP, and PUSH)</span>
</span><span id="Simulator.executionStats-185"><a href="#Simulator.executionStats-185"><span class="linenos">185</span></a><span class="sd">        - &quot;branch&quot; (all branches, B/BL/BX alike)</span>
</span><span id="Simulator.executionStats-186"><a href="#Simulator.executionStats-186"><span class="linenos">186</span></a><span class="sd">        - &quot;multiply&quot; (multiply and multiply long operations)</span>
</span><span id="Simulator.executionStats-187"><a href="#Simulator.executionStats-187"><span class="linenos">187</span></a><span class="sd">        - &quot;softinterrupt&quot; (self explanatory)</span>
</span><span id="Simulator.executionStats-188"><a href="#Simulator.executionStats-188"><span class="linenos">188</span></a><span class="sd">        - &quot;psr&quot; (CPSR/SPRS &lt;-&gt; register transfers)</span>
</span><span id="Simulator.executionStats-189"><a href="#Simulator.executionStats-189"><span class="linenos">189</span></a><span class="sd">        - &quot;nop&quot; (NOP instructions)</span>
</span><span id="Simulator.executionStats-190"><a href="#Simulator.executionStats-190"><span class="linenos">190</span></a>
</span><span id="Simulator.executionStats-191"><a href="#Simulator.executionStats-191"><span class="linenos">191</span></a><span class="sd">        These keys are associated to a 2-integers tuple. The first value is the number of times</span>
</span><span id="Simulator.executionStats-192"><a href="#Simulator.executionStats-192"><span class="linenos">192</span></a><span class="sd">        this kind of instruction was executed, the second the number of times if _would_ have been</span>
</span><span id="Simulator.executionStats-193"><a href="#Simulator.executionStats-193"><span class="linenos">193</span></a><span class="sd">        executed except for the condition field (e.g. the condition was not met).</span>
</span><span id="Simulator.executionStats-194"><a href="#Simulator.executionStats-194"><span class="linenos">194</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Simulator.executionStats-195"><a href="#Simulator.executionStats-195"><span class="linenos">195</span></a>        <span class="n">memExec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoders</span><span class="p">[</span><span class="s2">&quot;MemOp&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">execCounters</span>
</span><span id="Simulator.executionStats-196"><a href="#Simulator.executionStats-196"><span class="linenos">196</span></a>        <span class="n">halfMemExec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoders</span><span class="p">[</span><span class="s2">&quot;HalfSignedMemOp&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">execCounters</span>
</span><span id="Simulator.executionStats-197"><a href="#Simulator.executionStats-197"><span class="linenos">197</span></a>        <span class="n">swapExec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoders</span><span class="p">[</span><span class="s2">&quot;SwapOp&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">execCounters</span>
</span><span id="Simulator.executionStats-198"><a href="#Simulator.executionStats-198"><span class="linenos">198</span></a>        <span class="n">multiplyExec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoders</span><span class="p">[</span><span class="s2">&quot;MulOp&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">execCounters</span>
</span><span id="Simulator.executionStats-199"><a href="#Simulator.executionStats-199"><span class="linenos">199</span></a>        <span class="n">multiplyLongExec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoders</span><span class="p">[</span><span class="s2">&quot;MulLongOp&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">execCounters</span>
</span><span id="Simulator.executionStats-200"><a href="#Simulator.executionStats-200"><span class="linenos">200</span></a>
</span><span id="Simulator.executionStats-201"><a href="#Simulator.executionStats-201"><span class="linenos">201</span></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="Simulator.executionStats-202"><a href="#Simulator.executionStats-202"><span class="linenos">202</span></a>            <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoders</span><span class="p">[</span><span class="s2">&quot;DataOp&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">execCounters</span><span class="p">,</span>
</span><span id="Simulator.executionStats-203"><a href="#Simulator.executionStats-203"><span class="linenos">203</span></a>            <span class="s2">&quot;mem&quot;</span><span class="p">:</span> <span class="p">(</span>
</span><span id="Simulator.executionStats-204"><a href="#Simulator.executionStats-204"><span class="linenos">204</span></a>                <span class="n">memExec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">halfMemExec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">swapExec</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
</span><span id="Simulator.executionStats-205"><a href="#Simulator.executionStats-205"><span class="linenos">205</span></a>                <span class="n">memExec</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">halfMemExec</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">swapExec</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
</span><span id="Simulator.executionStats-206"><a href="#Simulator.executionStats-206"><span class="linenos">206</span></a>            <span class="p">),</span>
</span><span id="Simulator.executionStats-207"><a href="#Simulator.executionStats-207"><span class="linenos">207</span></a>            <span class="s2">&quot;multiplemem&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoders</span><span class="p">[</span><span class="s2">&quot;MultipleMemOp&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">execCounters</span><span class="p">,</span>
</span><span id="Simulator.executionStats-208"><a href="#Simulator.executionStats-208"><span class="linenos">208</span></a>            <span class="s2">&quot;branch&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoders</span><span class="p">[</span><span class="s2">&quot;BranchOp&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">execCounters</span><span class="p">,</span>
</span><span id="Simulator.executionStats-209"><a href="#Simulator.executionStats-209"><span class="linenos">209</span></a>            <span class="s2">&quot;multiply&quot;</span><span class="p">:</span> <span class="p">(</span>
</span><span id="Simulator.executionStats-210"><a href="#Simulator.executionStats-210"><span class="linenos">210</span></a>                <span class="n">multiplyExec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">multiplyLongExec</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
</span><span id="Simulator.executionStats-211"><a href="#Simulator.executionStats-211"><span class="linenos">211</span></a>                <span class="n">multiplyExec</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">multiplyLongExec</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
</span><span id="Simulator.executionStats-212"><a href="#Simulator.executionStats-212"><span class="linenos">212</span></a>            <span class="p">),</span>
</span><span id="Simulator.executionStats-213"><a href="#Simulator.executionStats-213"><span class="linenos">213</span></a>            <span class="s2">&quot;softinterrupt&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoders</span><span class="p">[</span><span class="s2">&quot;SoftInterruptOp&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">execCounters</span><span class="p">,</span>
</span><span id="Simulator.executionStats-214"><a href="#Simulator.executionStats-214"><span class="linenos">214</span></a>            <span class="s2">&quot;psr&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoders</span><span class="p">[</span><span class="s2">&quot;PSROp&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">execCounters</span><span class="p">,</span>
</span><span id="Simulator.executionStats-215"><a href="#Simulator.executionStats-215"><span class="linenos">215</span></a>            <span class="s2">&quot;nop&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoders</span><span class="p">[</span><span class="s2">&quot;NopOp&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">execCounters</span><span class="p">,</span>
</span><span id="Simulator.executionStats-216"><a href="#Simulator.executionStats-216"><span class="linenos">216</span></a>        <span class="p">}</span>
</span></pre></div>


            <div class="docstring"><p>Return a dictionary with the number of times each instruction type was executed
in the last execution run.
The types are:</p>

<ul>
<li>"data" (includes all arithmetic and logic operations except multiply)</li>
<li>"mem" (includes all _single_ memory accesses including byte, half or word access and swap)</li>
<li>"multiplemem" (all _multiple_ memory accesses: LDM, STM, POP, and PUSH)</li>
<li>"branch" (all branches, B/BL/BX alike)</li>
<li>"multiply" (multiply and multiply long operations)</li>
<li>"softinterrupt" (self explanatory)</li>
<li>"psr" (CPSR/SPRS &lt;-> register transfers)</li>
<li>"nop" (NOP instructions)</li>
</ul>

<p>These keys are associated to a 2-integers tuple. The first value is the number of times
this kind of instruction was executed, the second the number of times if _would_ have been
executed except for the condition field (e.g. the condition was not met).</p>
</div>


                            </div>
                            <div id="Simulator.fetchAndDecode" class="classattr">
                                        <input id="Simulator.fetchAndDecode-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">fetchAndDecode</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">forceExplain</span><span class="o">=</span><span class="kc">False</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Simulator.fetchAndDecode-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Simulator.fetchAndDecode"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Simulator.fetchAndDecode-218"><a href="#Simulator.fetchAndDecode-218"><span class="linenos">218</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">fetchAndDecode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">forceExplain</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="Simulator.fetchAndDecode-219"><a href="#Simulator.fetchAndDecode-219"><span class="linenos">219</span></a>        <span class="c1"># Check if PC is valid (multiple of 4)</span>
</span><span id="Simulator.fetchAndDecode-220"><a href="#Simulator.fetchAndDecode-220"><span class="linenos">220</span></a>        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">regs</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">pcoffset</span><span class="p">)</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Simulator.fetchAndDecode-221"><a href="#Simulator.fetchAndDecode-221"><span class="linenos">221</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fetchedInstr</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Simulator.fetchAndDecode-222"><a href="#Simulator.fetchAndDecode-222"><span class="linenos">222</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">errorsPending</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="Simulator.fetchAndDecode-223"><a href="#Simulator.fetchAndDecode-223"><span class="linenos">223</span></a>                <span class="s2">&quot;register&quot;</span><span class="p">,</span>
</span><span id="Simulator.fetchAndDecode-224"><a href="#Simulator.fetchAndDecode-224"><span class="linenos">224</span></a>                <span class="n">appState</span><span class="o">.</span><span class="n">getT</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="Simulator.fetchAndDecode-225"><a href="#Simulator.fetchAndDecode-225"><span class="linenos">225</span></a>                    <span class="nb">hex</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">regs</span><span class="p">[</span><span class="mi">15</span><span class="p">])</span>
</span><span id="Simulator.fetchAndDecode-226"><a href="#Simulator.fetchAndDecode-226"><span class="linenos">226</span></a>                <span class="p">),</span>
</span><span id="Simulator.fetchAndDecode-227"><a href="#Simulator.fetchAndDecode-227"><span class="linenos">227</span></a>            <span class="p">)</span>
</span><span id="Simulator.fetchAndDecode-228"><a href="#Simulator.fetchAndDecode-228"><span class="linenos">228</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Simulator.fetchAndDecode-229"><a href="#Simulator.fetchAndDecode-229"><span class="linenos">229</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="Simulator.fetchAndDecode-230"><a href="#Simulator.fetchAndDecode-230"><span class="linenos">230</span></a>                <span class="c1"># Retrieve instruction from memory</span>
</span><span id="Simulator.fetchAndDecode-231"><a href="#Simulator.fetchAndDecode-231"><span class="linenos">231</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">fetchedInstr</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span>
</span><span id="Simulator.fetchAndDecode-232"><a href="#Simulator.fetchAndDecode-232"><span class="linenos">232</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">mem</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">regs</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">pcoffset</span><span class="p">,</span> <span class="n">execMode</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="Simulator.fetchAndDecode-233"><a href="#Simulator.fetchAndDecode-233"><span class="linenos">233</span></a>                <span class="p">)</span>
</span><span id="Simulator.fetchAndDecode-234"><a href="#Simulator.fetchAndDecode-234"><span class="linenos">234</span></a>            <span class="k">except</span> <span class="n">Breakpoint</span> <span class="k">as</span> <span class="n">bp</span><span class="p">:</span>
</span><span id="Simulator.fetchAndDecode-235"><a href="#Simulator.fetchAndDecode-235"><span class="linenos">235</span></a>                <span class="c1"># We hit a breakpoint</span>
</span><span id="Simulator.fetchAndDecode-236"><a href="#Simulator.fetchAndDecode-236"><span class="linenos">236</span></a>                <span class="c1"># Get memory instruction again, without trigger breakpoint</span>
</span><span id="Simulator.fetchAndDecode-237"><a href="#Simulator.fetchAndDecode-237"><span class="linenos">237</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">fetchedInstr</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span>
</span><span id="Simulator.fetchAndDecode-238"><a href="#Simulator.fetchAndDecode-238"><span class="linenos">238</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">mem</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">regs</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">pcoffset</span><span class="p">,</span> <span class="n">mayTriggerBkpt</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="Simulator.fetchAndDecode-239"><a href="#Simulator.fetchAndDecode-239"><span class="linenos">239</span></a>                <span class="p">)</span>
</span><span id="Simulator.fetchAndDecode-240"><a href="#Simulator.fetchAndDecode-240"><span class="linenos">240</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">bkptLastFetch</span> <span class="o">=</span> <span class="n">bp</span>
</span><span id="Simulator.fetchAndDecode-241"><a href="#Simulator.fetchAndDecode-241"><span class="linenos">241</span></a>            <span class="k">except</span> <span class="n">ComponentException</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
</span><span id="Simulator.fetchAndDecode-242"><a href="#Simulator.fetchAndDecode-242"><span class="linenos">242</span></a>                <span class="c1"># Execution error</span>
</span><span id="Simulator.fetchAndDecode-243"><a href="#Simulator.fetchAndDecode-243"><span class="linenos">243</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">errorsPending</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">err</span><span class="o">.</span><span class="n">cmp</span><span class="p">,</span> <span class="n">err</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
</span><span id="Simulator.fetchAndDecode-244"><a href="#Simulator.fetchAndDecode-244"><span class="linenos">244</span></a>                <span class="c1"># There is no instruction to this address</span>
</span><span id="Simulator.fetchAndDecode-245"><a href="#Simulator.fetchAndDecode-245"><span class="linenos">245</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">fetchedInstr</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Simulator.fetchAndDecode-246"><a href="#Simulator.fetchAndDecode-246"><span class="linenos">246</span></a>
</span><span id="Simulator.fetchAndDecode-247"><a href="#Simulator.fetchAndDecode-247"><span class="linenos">247</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">bytecodeToInstr</span><span class="p">()</span>
</span><span id="Simulator.fetchAndDecode-248"><a href="#Simulator.fetchAndDecode-248"><span class="linenos">248</span></a>        <span class="k">if</span> <span class="n">forceExplain</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">isStepDone</span><span class="p">():</span>
</span><span id="Simulator.fetchAndDecode-249"><a href="#Simulator.fetchAndDecode-249"><span class="linenos">249</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">explainInstruction</span><span class="p">()</span>
</span></pre></div>


    

                            </div>
                            <div id="Simulator.bytecodeToInstr" class="classattr">
                                        <input id="Simulator.bytecodeToInstr-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">bytecodeToInstr</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Simulator.bytecodeToInstr-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Simulator.bytecodeToInstr"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Simulator.bytecodeToInstr-251"><a href="#Simulator.bytecodeToInstr-251"><span class="linenos">251</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">bytecodeToInstr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Simulator.bytecodeToInstr-252"><a href="#Simulator.bytecodeToInstr-252"><span class="linenos">252</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Simulator.bytecodeToInstr-253"><a href="#Simulator.bytecodeToInstr-253"><span class="linenos">253</span></a><span class="sd">          Decode an instruction from its bytecode representation.</span>
</span><span id="Simulator.bytecodeToInstr-254"><a href="#Simulator.bytecodeToInstr-254"><span class="linenos">254</span></a>
</span><span id="Simulator.bytecodeToInstr-255"><a href="#Simulator.bytecodeToInstr-255"><span class="linenos">255</span></a><span class="sd">          See ARM Instruction set documentation for more information (Fig 4.1,</span>
</span><span id="Simulator.bytecodeToInstr-256"><a href="#Simulator.bytecodeToInstr-256"><span class="linenos">256</span></a><span class="sd">          and also Sec. A5.1 of ARM-v7 Architecture Reference Manual).</span>
</span><span id="Simulator.bytecodeToInstr-257"><a href="#Simulator.bytecodeToInstr-257"><span class="linenos">257</span></a><span class="sd">          We use the following decoding scheme, designed to ensure that avoid any</span>
</span><span id="Simulator.bytecodeToInstr-258"><a href="#Simulator.bytecodeToInstr-258"><span class="linenos">258</span></a><span class="sd">          instruction representation clash and also to reduce the number of</span>
</span><span id="Simulator.bytecodeToInstr-259"><a href="#Simulator.bytecodeToInstr-259"><span class="linenos">259</span></a><span class="sd">          conditions having to be checked in total. Each number inside [ ]</span>
</span><span id="Simulator.bytecodeToInstr-260"><a href="#Simulator.bytecodeToInstr-260"><span class="linenos">260</span></a><span class="sd">          represents a bit position. The usual binary ops symbols apply.</span>
</span><span id="Simulator.bytecodeToInstr-261"><a href="#Simulator.bytecodeToInstr-261"><span class="linenos">261</span></a>
</span><span id="Simulator.bytecodeToInstr-262"><a href="#Simulator.bytecodeToInstr-262"><span class="linenos">262</span></a><span class="sd">          Note that NOP was backported from ARMv7, and that ARMv4 coprocessor</span>
</span><span id="Simulator.bytecodeToInstr-263"><a href="#Simulator.bytecodeToInstr-263"><span class="linenos">263</span></a><span class="sd">          instructions are not supported. Also, we do not explicitly check for</span>
</span><span id="Simulator.bytecodeToInstr-264"><a href="#Simulator.bytecodeToInstr-264"><span class="linenos">264</span></a><span class="sd">          undefined instructions (in the ARM terminology, they are more</span>
</span><span id="Simulator.bytecodeToInstr-265"><a href="#Simulator.bytecodeToInstr-265"><span class="linenos">265</span></a><span class="sd">          _unpredictable_ than undefined).</span>
</span><span id="Simulator.bytecodeToInstr-266"><a href="#Simulator.bytecodeToInstr-266"><span class="linenos">266</span></a>
</span><span id="Simulator.bytecodeToInstr-267"><a href="#Simulator.bytecodeToInstr-267"><span class="linenos">267</span></a><span class="sd">          Decoded instructions are also cached to improve performance.</span>
</span><span id="Simulator.bytecodeToInstr-268"><a href="#Simulator.bytecodeToInstr-268"><span class="linenos">268</span></a>
</span><span id="Simulator.bytecodeToInstr-269"><a href="#Simulator.bytecodeToInstr-269"><span class="linenos">269</span></a><span class="sd">         Bytecode input</span>
</span><span id="Simulator.bytecodeToInstr-270"><a href="#Simulator.bytecodeToInstr-270"><span class="linenos">270</span></a><span class="sd">           (4 bytes)</span>
</span><span id="Simulator.bytecodeToInstr-271"><a href="#Simulator.bytecodeToInstr-271"><span class="linenos">271</span></a><span class="sd">               |</span>
</span><span id="Simulator.bytecodeToInstr-272"><a href="#Simulator.bytecodeToInstr-272"><span class="linenos">272</span></a><span class="sd">               |</span>
</span><span id="Simulator.bytecodeToInstr-273"><a href="#Simulator.bytecodeToInstr-273"><span class="linenos">273</span></a><span class="sd">               v</span>
</span><span id="Simulator.bytecodeToInstr-274"><a href="#Simulator.bytecodeToInstr-274"><span class="linenos">274</span></a><span class="sd">          [~26 &amp; ~27]---------------------------------------------------------v</span>
</span><span id="Simulator.bytecodeToInstr-275"><a href="#Simulator.bytecodeToInstr-275"><span class="linenos">275</span></a><span class="sd">               |                                                              |</span>
</span><span id="Simulator.bytecodeToInstr-276"><a href="#Simulator.bytecodeToInstr-276"><span class="linenos">276</span></a><span class="sd">               | FALSE                                                        | TRUE</span>
</span><span id="Simulator.bytecodeToInstr-277"><a href="#Simulator.bytecodeToInstr-277"><span class="linenos">277</span></a><span class="sd">               |                                                              |</span>
</span><span id="Simulator.bytecodeToInstr-278"><a href="#Simulator.bytecodeToInstr-278"><span class="linenos">278</span></a><span class="sd">               v                                                              v</span>
</span><span id="Simulator.bytecodeToInstr-279"><a href="#Simulator.bytecodeToInstr-279"><span class="linenos">279</span></a><span class="sd">             [26 ]--------------------------------v                           |</span>
</span><span id="Simulator.bytecodeToInstr-280"><a href="#Simulator.bytecodeToInstr-280"><span class="linenos">280</span></a><span class="sd">               |                                  |                           |</span>
</span><span id="Simulator.bytecodeToInstr-281"><a href="#Simulator.bytecodeToInstr-281"><span class="linenos">281</span></a><span class="sd">               | FALSE                            | TRUE                      |</span>
</span><span id="Simulator.bytecodeToInstr-282"><a href="#Simulator.bytecodeToInstr-282"><span class="linenos">282</span></a><span class="sd">               |                                  |                           |</span>
</span><span id="Simulator.bytecodeToInstr-283"><a href="#Simulator.bytecodeToInstr-283"><span class="linenos">283</span></a><span class="sd">               v                                  v                           v</span>
</span><span id="Simulator.bytecodeToInstr-284"><a href="#Simulator.bytecodeToInstr-284"><span class="linenos">284</span></a><span class="sd">             [25 ]----------------v             [27 ]-------------v           |</span>
</span><span id="Simulator.bytecodeToInstr-285"><a href="#Simulator.bytecodeToInstr-285"><span class="linenos">285</span></a><span class="sd">               |                  |               |               |           |</span>
</span><span id="Simulator.bytecodeToInstr-286"><a href="#Simulator.bytecodeToInstr-286"><span class="linenos">286</span></a><span class="sd">               | FALSE            | TRUE          | FALSE         | TRUE      |</span>
</span><span id="Simulator.bytecodeToInstr-287"><a href="#Simulator.bytecodeToInstr-287"><span class="linenos">287</span></a><span class="sd">               |                  |               |               |           |</span>
</span><span id="Simulator.bytecodeToInstr-288"><a href="#Simulator.bytecodeToInstr-288"><span class="linenos">288</span></a><span class="sd">               v                  v               v               v           v</span>
</span><span id="Simulator.bytecodeToInstr-289"><a href="#Simulator.bytecodeToInstr-289"><span class="linenos">289</span></a><span class="sd">           LDM / STM          Branch (B)      LDR / STR       SWI / SVC       |</span>
</span><span id="Simulator.bytecodeToInstr-290"><a href="#Simulator.bytecodeToInstr-290"><span class="linenos">290</span></a><span class="sd">                                           (also undefined                    |</span>
</span><span id="Simulator.bytecodeToInstr-291"><a href="#Simulator.bytecodeToInstr-291"><span class="linenos">291</span></a><span class="sd">                                               if [4])                        |</span>
</span><span id="Simulator.bytecodeToInstr-292"><a href="#Simulator.bytecodeToInstr-292"><span class="linenos">292</span></a><span class="sd">               v--------------------------------------------------------------&lt;</span>
</span><span id="Simulator.bytecodeToInstr-293"><a href="#Simulator.bytecodeToInstr-293"><span class="linenos">293</span></a><span class="sd">               |</span>
</span><span id="Simulator.bytecodeToInstr-294"><a href="#Simulator.bytecodeToInstr-294"><span class="linenos">294</span></a><span class="sd">               v</span>
</span><span id="Simulator.bytecodeToInstr-295"><a href="#Simulator.bytecodeToInstr-295"><span class="linenos">295</span></a><span class="sd">         [4 &amp; 7 &amp; ~25]--------------------------------------------v</span>
</span><span id="Simulator.bytecodeToInstr-296"><a href="#Simulator.bytecodeToInstr-296"><span class="linenos">296</span></a><span class="sd">               |                                                  |</span>
</span><span id="Simulator.bytecodeToInstr-297"><a href="#Simulator.bytecodeToInstr-297"><span class="linenos">297</span></a><span class="sd">               | FALSE                                            | TRUE</span>
</span><span id="Simulator.bytecodeToInstr-298"><a href="#Simulator.bytecodeToInstr-298"><span class="linenos">298</span></a><span class="sd">               |                                                  |</span>
</span><span id="Simulator.bytecodeToInstr-299"><a href="#Simulator.bytecodeToInstr-299"><span class="linenos">299</span></a><span class="sd">               v                                                  v</span>
</span><span id="Simulator.bytecodeToInstr-300"><a href="#Simulator.bytecodeToInstr-300"><span class="linenos">300</span></a><span class="sd">        [~20 &amp; ~23 &amp; 24]----------v                            [5 | 6]--------v</span>
</span><span id="Simulator.bytecodeToInstr-301"><a href="#Simulator.bytecodeToInstr-301"><span class="linenos">301</span></a><span class="sd">               |                  |                               |           | TRUE</span>
</span><span id="Simulator.bytecodeToInstr-302"><a href="#Simulator.bytecodeToInstr-302"><span class="linenos">302</span></a><span class="sd">               | FALSE            | TRUE                          | FALSE     v</span>
</span><span id="Simulator.bytecodeToInstr-303"><a href="#Simulator.bytecodeToInstr-303"><span class="linenos">303</span></a><span class="sd">               |                  |                               |       LDRH/SH/SB</span>
</span><span id="Simulator.bytecodeToInstr-304"><a href="#Simulator.bytecodeToInstr-304"><span class="linenos">304</span></a><span class="sd">               v                  v                               v</span>
</span><span id="Simulator.bytecodeToInstr-305"><a href="#Simulator.bytecodeToInstr-305"><span class="linenos">305</span></a><span class="sd">            DATA OP           [18 &amp; 21]-----------v             [24 ]---------v</span>
</span><span id="Simulator.bytecodeToInstr-306"><a href="#Simulator.bytecodeToInstr-306"><span class="linenos">306</span></a><span class="sd">        (MOV, ADD, etc.)          |               |               |           | TRUE</span>
</span><span id="Simulator.bytecodeToInstr-307"><a href="#Simulator.bytecodeToInstr-307"><span class="linenos">307</span></a><span class="sd">                                  | FALSE         | TRUE          | FALSE     v</span>
</span><span id="Simulator.bytecodeToInstr-308"><a href="#Simulator.bytecodeToInstr-308"><span class="linenos">308</span></a><span class="sd">                                  |               |               |          SWP</span>
</span><span id="Simulator.bytecodeToInstr-309"><a href="#Simulator.bytecodeToInstr-309"><span class="linenos">309</span></a><span class="sd">                                  v               v               v</span>
</span><span id="Simulator.bytecodeToInstr-310"><a href="#Simulator.bytecodeToInstr-310"><span class="linenos">310</span></a><span class="sd">               v----------------[19 ]            BX             [23 ]---------v</span>
</span><span id="Simulator.bytecodeToInstr-311"><a href="#Simulator.bytecodeToInstr-311"><span class="linenos">311</span></a><span class="sd">               |                  |                               |           | TRUE</span>
</span><span id="Simulator.bytecodeToInstr-312"><a href="#Simulator.bytecodeToInstr-312"><span class="linenos">312</span></a><span class="sd">               | TRUE             | FALSE                         | FALSE     v</span>
</span><span id="Simulator.bytecodeToInstr-313"><a href="#Simulator.bytecodeToInstr-313"><span class="linenos">313</span></a><span class="sd">               |                  |                               |        Multiply</span>
</span><span id="Simulator.bytecodeToInstr-314"><a href="#Simulator.bytecodeToInstr-314"><span class="linenos">314</span></a><span class="sd">               v                  v                               v          long</span>
</span><span id="Simulator.bytecodeToInstr-315"><a href="#Simulator.bytecodeToInstr-315"><span class="linenos">315</span></a><span class="sd">           MSR / MRS             NOP                           Multiply</span>
</span><span id="Simulator.bytecodeToInstr-316"><a href="#Simulator.bytecodeToInstr-316"><span class="linenos">316</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Simulator.bytecodeToInstr-317"><a href="#Simulator.bytecodeToInstr-317"><span class="linenos">317</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">fetchedInstr</span><span class="p">:</span>
</span><span id="Simulator.bytecodeToInstr-318"><a href="#Simulator.bytecodeToInstr-318"><span class="linenos">318</span></a>            <span class="c1"># Undefined instruction</span>
</span><span id="Simulator.bytecodeToInstr-319"><a href="#Simulator.bytecodeToInstr-319"><span class="linenos">319</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">currentInstr</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Simulator.bytecodeToInstr-320"><a href="#Simulator.bytecodeToInstr-320"><span class="linenos">320</span></a>            <span class="k">return</span>
</span><span id="Simulator.bytecodeToInstr-321"><a href="#Simulator.bytecodeToInstr-321"><span class="linenos">321</span></a>        <span class="c1"># Assumes that the instruction to decode is in self.fetchedInstr</span>
</span><span id="Simulator.bytecodeToInstr-322"><a href="#Simulator.bytecodeToInstr-322"><span class="linenos">322</span></a>        <span class="n">instrInt</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&quot;&lt;I&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fetchedInstr</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Simulator.bytecodeToInstr-323"><a href="#Simulator.bytecodeToInstr-323"><span class="linenos">323</span></a>
</span><span id="Simulator.bytecodeToInstr-324"><a href="#Simulator.bytecodeToInstr-324"><span class="linenos">324</span></a>        <span class="k">if</span> <span class="n">instrInt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoderCache</span><span class="p">:</span>
</span><span id="Simulator.bytecodeToInstr-325"><a href="#Simulator.bytecodeToInstr-325"><span class="linenos">325</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">currentInstr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoderCache</span><span class="p">[</span><span class="n">instrInt</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Simulator.bytecodeToInstr-326"><a href="#Simulator.bytecodeToInstr-326"><span class="linenos">326</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">currentInstr</span><span class="o">.</span><span class="n">setBytecode</span><span class="p">(</span><span class="n">instrInt</span><span class="p">)</span>
</span><span id="Simulator.bytecodeToInstr-327"><a href="#Simulator.bytecodeToInstr-327"><span class="linenos">327</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">currentInstr</span><span class="o">.</span><span class="n">restoreState</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">decoderCache</span><span class="p">[</span><span class="n">instrInt</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
</span><span id="Simulator.bytecodeToInstr-328"><a href="#Simulator.bytecodeToInstr-328"><span class="linenos">328</span></a>            <span class="k">return</span>
</span><span id="Simulator.bytecodeToInstr-329"><a href="#Simulator.bytecodeToInstr-329"><span class="linenos">329</span></a>
</span><span id="Simulator.bytecodeToInstr-330"><a href="#Simulator.bytecodeToInstr-330"><span class="linenos">330</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">instrInt</span> <span class="o">&gt;&gt;</span> <span class="mi">26</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">):</span>
</span><span id="Simulator.bytecodeToInstr-331"><a href="#Simulator.bytecodeToInstr-331"><span class="linenos">331</span></a>            <span class="k">if</span> <span class="n">instrInt</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span> <span class="o">&amp;</span> <span class="mi">9</span> <span class="o">==</span> <span class="mi">9</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="n">instrInt</span> <span class="o">&gt;&gt;</span> <span class="mi">25</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">):</span>
</span><span id="Simulator.bytecodeToInstr-332"><a href="#Simulator.bytecodeToInstr-332"><span class="linenos">332</span></a>                <span class="k">if</span> <span class="n">instrInt</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">:</span>
</span><span id="Simulator.bytecodeToInstr-333"><a href="#Simulator.bytecodeToInstr-333"><span class="linenos">333</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">currentInstr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoders</span><span class="p">[</span><span class="s2">&quot;HalfSignedMemOp&quot;</span><span class="p">]</span>
</span><span id="Simulator.bytecodeToInstr-334"><a href="#Simulator.bytecodeToInstr-334"><span class="linenos">334</span></a>                <span class="k">elif</span> <span class="n">instrInt</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="Simulator.bytecodeToInstr-335"><a href="#Simulator.bytecodeToInstr-335"><span class="linenos">335</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">currentInstr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoders</span><span class="p">[</span><span class="s2">&quot;SwapOp&quot;</span><span class="p">]</span>
</span><span id="Simulator.bytecodeToInstr-336"><a href="#Simulator.bytecodeToInstr-336"><span class="linenos">336</span></a>                <span class="k">elif</span> <span class="n">instrInt</span> <span class="o">&gt;&gt;</span> <span class="mi">23</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="Simulator.bytecodeToInstr-337"><a href="#Simulator.bytecodeToInstr-337"><span class="linenos">337</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">currentInstr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoders</span><span class="p">[</span><span class="s2">&quot;MulLongOp&quot;</span><span class="p">]</span>
</span><span id="Simulator.bytecodeToInstr-338"><a href="#Simulator.bytecodeToInstr-338"><span class="linenos">338</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="Simulator.bytecodeToInstr-339"><a href="#Simulator.bytecodeToInstr-339"><span class="linenos">339</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">currentInstr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoders</span><span class="p">[</span><span class="s2">&quot;MulOp&quot;</span><span class="p">]</span>
</span><span id="Simulator.bytecodeToInstr-340"><a href="#Simulator.bytecodeToInstr-340"><span class="linenos">340</span></a>            <span class="k">elif</span> <span class="n">instrInt</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span> <span class="o">&amp;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="n">instrInt</span> <span class="o">&gt;&gt;</span> <span class="mi">20</span> <span class="o">&amp;</span> <span class="mi">9</span><span class="p">):</span>
</span><span id="Simulator.bytecodeToInstr-341"><a href="#Simulator.bytecodeToInstr-341"><span class="linenos">341</span></a>                <span class="k">if</span> <span class="n">instrInt</span> <span class="o">&gt;&gt;</span> <span class="mi">18</span> <span class="o">&amp;</span> <span class="mi">9</span> <span class="o">==</span> <span class="mi">9</span><span class="p">:</span>
</span><span id="Simulator.bytecodeToInstr-342"><a href="#Simulator.bytecodeToInstr-342"><span class="linenos">342</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">currentInstr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoders</span><span class="p">[</span><span class="s2">&quot;BranchOp&quot;</span><span class="p">]</span>
</span><span id="Simulator.bytecodeToInstr-343"><a href="#Simulator.bytecodeToInstr-343"><span class="linenos">343</span></a>                <span class="k">elif</span> <span class="n">instrInt</span> <span class="o">&gt;&gt;</span> <span class="mi">19</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="Simulator.bytecodeToInstr-344"><a href="#Simulator.bytecodeToInstr-344"><span class="linenos">344</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">currentInstr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoders</span><span class="p">[</span><span class="s2">&quot;PSROp&quot;</span><span class="p">]</span>
</span><span id="Simulator.bytecodeToInstr-345"><a href="#Simulator.bytecodeToInstr-345"><span class="linenos">345</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="Simulator.bytecodeToInstr-346"><a href="#Simulator.bytecodeToInstr-346"><span class="linenos">346</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">currentInstr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoders</span><span class="p">[</span><span class="s2">&quot;NopOp&quot;</span><span class="p">]</span>
</span><span id="Simulator.bytecodeToInstr-347"><a href="#Simulator.bytecodeToInstr-347"><span class="linenos">347</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Simulator.bytecodeToInstr-348"><a href="#Simulator.bytecodeToInstr-348"><span class="linenos">348</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">currentInstr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoders</span><span class="p">[</span><span class="s2">&quot;DataOp&quot;</span><span class="p">]</span>
</span><span id="Simulator.bytecodeToInstr-349"><a href="#Simulator.bytecodeToInstr-349"><span class="linenos">349</span></a>        <span class="k">elif</span> <span class="n">instrInt</span> <span class="o">&gt;&gt;</span> <span class="mi">26</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="Simulator.bytecodeToInstr-350"><a href="#Simulator.bytecodeToInstr-350"><span class="linenos">350</span></a>            <span class="k">if</span> <span class="n">instrInt</span> <span class="o">&gt;&gt;</span> <span class="mi">27</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="Simulator.bytecodeToInstr-351"><a href="#Simulator.bytecodeToInstr-351"><span class="linenos">351</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">currentInstr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoders</span><span class="p">[</span><span class="s2">&quot;SoftInterruptOp&quot;</span><span class="p">]</span>
</span><span id="Simulator.bytecodeToInstr-352"><a href="#Simulator.bytecodeToInstr-352"><span class="linenos">352</span></a>            <span class="k">else</span><span class="p">:</span>  <span class="c1"># Could also check for [4], which is an undefined space in the instruction set</span>
</span><span id="Simulator.bytecodeToInstr-353"><a href="#Simulator.bytecodeToInstr-353"><span class="linenos">353</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">currentInstr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoders</span><span class="p">[</span><span class="s2">&quot;MemOp&quot;</span><span class="p">]</span>
</span><span id="Simulator.bytecodeToInstr-354"><a href="#Simulator.bytecodeToInstr-354"><span class="linenos">354</span></a>        <span class="k">elif</span> <span class="n">instrInt</span> <span class="o">&gt;&gt;</span> <span class="mi">25</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="Simulator.bytecodeToInstr-355"><a href="#Simulator.bytecodeToInstr-355"><span class="linenos">355</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">currentInstr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoders</span><span class="p">[</span><span class="s2">&quot;BranchOp&quot;</span><span class="p">]</span>
</span><span id="Simulator.bytecodeToInstr-356"><a href="#Simulator.bytecodeToInstr-356"><span class="linenos">356</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Simulator.bytecodeToInstr-357"><a href="#Simulator.bytecodeToInstr-357"><span class="linenos">357</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">currentInstr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoders</span><span class="p">[</span><span class="s2">&quot;MultipleMemOp&quot;</span><span class="p">]</span>
</span><span id="Simulator.bytecodeToInstr-358"><a href="#Simulator.bytecodeToInstr-358"><span class="linenos">358</span></a>
</span><span id="Simulator.bytecodeToInstr-359"><a href="#Simulator.bytecodeToInstr-359"><span class="linenos">359</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentInstr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Simulator.bytecodeToInstr-360"><a href="#Simulator.bytecodeToInstr-360"><span class="linenos">360</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">currentInstr</span><span class="o">.</span><span class="n">setBytecode</span><span class="p">(</span><span class="n">instrInt</span><span class="p">)</span>
</span><span id="Simulator.bytecodeToInstr-361"><a href="#Simulator.bytecodeToInstr-361"><span class="linenos">361</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="Simulator.bytecodeToInstr-362"><a href="#Simulator.bytecodeToInstr-362"><span class="linenos">362</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">currentInstr</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
</span><span id="Simulator.bytecodeToInstr-363"><a href="#Simulator.bytecodeToInstr-363"><span class="linenos">363</span></a>                <span class="c1"># Once decoded, we add the instruction to the cache</span>
</span><span id="Simulator.bytecodeToInstr-364"><a href="#Simulator.bytecodeToInstr-364"><span class="linenos">364</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">decoderCache</span><span class="p">[</span><span class="n">instrInt</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="Simulator.bytecodeToInstr-365"><a href="#Simulator.bytecodeToInstr-365"><span class="linenos">365</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">currentInstr</span><span class="p">,</span>
</span><span id="Simulator.bytecodeToInstr-366"><a href="#Simulator.bytecodeToInstr-366"><span class="linenos">366</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">currentInstr</span><span class="o">.</span><span class="n">saveState</span><span class="p">(),</span>
</span><span id="Simulator.bytecodeToInstr-367"><a href="#Simulator.bytecodeToInstr-367"><span class="linenos">367</span></a>                <span class="p">)</span>
</span><span id="Simulator.bytecodeToInstr-368"><a href="#Simulator.bytecodeToInstr-368"><span class="linenos">368</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">decoderCache</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2000</span><span class="p">:</span>
</span><span id="Simulator.bytecodeToInstr-369"><a href="#Simulator.bytecodeToInstr-369"><span class="linenos">369</span></a>                    <span class="c1"># Fail-safe, we should never get there with programs &lt; 2000 lines, but just in case,</span>
</span><span id="Simulator.bytecodeToInstr-370"><a href="#Simulator.bytecodeToInstr-370"><span class="linenos">370</span></a>                    <span class="c1"># we do not want to bust the RAM with our cache</span>
</span><span id="Simulator.bytecodeToInstr-371"><a href="#Simulator.bytecodeToInstr-371"><span class="linenos">371</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">decoderCache</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="Simulator.bytecodeToInstr-372"><a href="#Simulator.bytecodeToInstr-372"><span class="linenos">372</span></a>            <span class="k">except</span> <span class="n">ExecutionException</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
</span><span id="Simulator.bytecodeToInstr-373"><a href="#Simulator.bytecodeToInstr-373"><span class="linenos">373</span></a>                <span class="c1"># Invalid instruction</span>
</span><span id="Simulator.bytecodeToInstr-374"><a href="#Simulator.bytecodeToInstr-374"><span class="linenos">374</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">currentInstr</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Simulator.bytecodeToInstr-375"><a href="#Simulator.bytecodeToInstr-375"><span class="linenos">375</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">errorsPending</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;execution&quot;</span><span class="p">,</span> <span class="n">err</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Decode an instruction from its bytecode representation.</p>

<p>See ARM Instruction set documentation for more information (Fig 4.1,
  and also Sec. A5.1 of ARM-v7 Architecture Reference Manual).
  We use the following decoding scheme, designed to ensure that avoid any
  instruction representation clash and also to reduce the number of
  conditions having to be checked in total. Each number inside [ ]
  represents a bit position. The usual binary ops symbols apply.</p>

<p>Note that NOP was backported from ARMv7, and that ARMv4 coprocessor
  instructions are not supported. Also, we do not explicitly check for
  undefined instructions (in the ARM terminology, they are more
  _unpredictable_ than undefined).</p>

<p>Decoded instructions are also cached to improve performance.</p>

<p>Bytecode input
   (4 bytes)
       |
       |
       v
  [~26 &amp; ~27]---------------------------------------------------------v
       |                                                              |
       | FALSE                                                        | TRUE
       |                                                              |
       v                                                              v
     [26 ]--------------------------------v                           |
       |                                  |                           |
       | FALSE                            | TRUE                      |
       |                                  |                           |
       v                                  v                           v
     [25 ]----------------v             [27 ]-------------v           |
       |                  |               |               |           |
       | FALSE            | TRUE          | FALSE         | TRUE      |
       |                  |               |               |           |
       v                  v               v               v           v
   LDM / STM          Branch (B)      LDR / STR       SWI / SVC       |
                                   (also undefined                    |
                                       if [4])                        |
       v--------------------------------------------------------------&lt;
       |
       v
 [4 &amp; 7 &amp; ~25]--------------------------------------------v
       |                                                  |
       | FALSE                                            | TRUE
       |                                                  |
       v                                                  v
[~20 &amp; ~23 &amp; 24]----------v                            [5 | 6]--------v
       |                  |                               |           | TRUE
       | FALSE            | TRUE                          | FALSE     v
       |                  |                               |       LDRH/SH/SB
       v                  v                               v
    DATA OP           [18 &amp; 21]-----------v             [24 ]---------v
(MOV, ADD, etc.)          |               |               |           | TRUE
                          | FALSE         | TRUE          | FALSE     v
                          |               |               |          SWP
                          v               v               v
       v----------------[19 ]            BX             [23 ]---------v
       |                  |                               |           | TRUE
       | TRUE             | FALSE                         | FALSE     v
       |                  |                               |        Multiply
       v                  v                               v          long
   MSR / MRS             NOP                           Multiply</p>
</div>


                            </div>
                            <div id="Simulator.explainInstruction" class="classattr">
                                        <input id="Simulator.explainInstruction-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">explainInstruction</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Simulator.explainInstruction-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Simulator.explainInstruction"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Simulator.explainInstruction-377"><a href="#Simulator.explainInstruction-377"><span class="linenos">377</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">explainInstruction</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Simulator.explainInstruction-378"><a href="#Simulator.explainInstruction-378"><span class="linenos">378</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentInstr</span><span class="p">:</span>
</span><span id="Simulator.explainInstruction-379"><a href="#Simulator.explainInstruction-379"><span class="linenos">379</span></a>            <span class="c1"># Undefined instruction</span>
</span><span id="Simulator.explainInstruction-380"><a href="#Simulator.explainInstruction-380"><span class="linenos">380</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">disassemblyInfo</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="Simulator.explainInstruction-381"><a href="#Simulator.explainInstruction-381"><span class="linenos">381</span></a>                <span class="p">[</span><span class="s2">&quot;highlightRead&quot;</span><span class="p">,</span> <span class="p">[]],</span>
</span><span id="Simulator.explainInstruction-382"><a href="#Simulator.explainInstruction-382"><span class="linenos">382</span></a>                <span class="p">[</span><span class="s2">&quot;highlightWrite&quot;</span><span class="p">,</span> <span class="p">[]],</span>
</span><span id="Simulator.explainInstruction-383"><a href="#Simulator.explainInstruction-383"><span class="linenos">383</span></a>                <span class="p">[</span><span class="s2">&quot;nextline&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span>
</span><span id="Simulator.explainInstruction-384"><a href="#Simulator.explainInstruction-384"><span class="linenos">384</span></a>                <span class="p">[</span><span class="s2">&quot;disassembly&quot;</span><span class="p">,</span> <span class="n">appState</span><span class="o">.</span><span class="n">getT</span><span class="p">(</span><span class="mi">1</span><span class="p">)],</span>
</span><span id="Simulator.explainInstruction-385"><a href="#Simulator.explainInstruction-385"><span class="linenos">385</span></a>            <span class="p">)</span>
</span><span id="Simulator.explainInstruction-386"><a href="#Simulator.explainInstruction-386"><span class="linenos">386</span></a>            <span class="k">return</span>
</span><span id="Simulator.explainInstruction-387"><a href="#Simulator.explainInstruction-387"><span class="linenos">387</span></a>
</span><span id="Simulator.explainInstruction-388"><a href="#Simulator.explainInstruction-388"><span class="linenos">388</span></a>        <span class="n">disassembly</span><span class="p">,</span> <span class="n">description</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentInstr</span><span class="o">.</span><span class="n">explain</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span id="Simulator.explainInstruction-389"><a href="#Simulator.explainInstruction-389"><span class="linenos">389</span></a>        <span class="n">dis</span> <span class="o">=</span> <span class="s1">&#39;&lt;div id=&quot;disassembly_instruction&quot;&gt;</span><span class="si">{}</span><span class="s1">: </span><span class="si">{}</span><span class="s1">&lt;/div&gt;</span><span class="se">\n</span><span class="s1">&lt;div id=&quot;disassembly_description&quot;&gt;</span><span class="si">{}</span><span class="s1">&lt;/div&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="Simulator.explainInstruction-390"><a href="#Simulator.explainInstruction-390"><span class="linenos">390</span></a>            <span class="n">appState</span><span class="o">.</span><span class="n">getT</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="p">,</span><span class="n">disassembly</span><span class="p">,</span> <span class="n">description</span>
</span><span id="Simulator.explainInstruction-391"><a href="#Simulator.explainInstruction-391"><span class="linenos">391</span></a>        <span class="p">)</span>
</span><span id="Simulator.explainInstruction-392"><a href="#Simulator.explainInstruction-392"><span class="linenos">392</span></a>
</span><span id="Simulator.explainInstruction-393"><a href="#Simulator.explainInstruction-393"><span class="linenos">393</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentInstr</span><span class="o">.</span><span class="n">nextAddressToExecute</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
</span><span id="Simulator.explainInstruction-394"><a href="#Simulator.explainInstruction-394"><span class="linenos">394</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">disassemblyInfo</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="Simulator.explainInstruction-395"><a href="#Simulator.explainInstruction-395"><span class="linenos">395</span></a>                <span class="p">[</span>
</span><span id="Simulator.explainInstruction-396"><a href="#Simulator.explainInstruction-396"><span class="linenos">396</span></a>                    <span class="s2">&quot;highlightRead&quot;</span><span class="p">,</span>
</span><span id="Simulator.explainInstruction-397"><a href="#Simulator.explainInstruction-397"><span class="linenos">397</span></a>                    <span class="nb">list</span><span class="p">(</span>
</span><span id="Simulator.explainInstruction-398"><a href="#Simulator.explainInstruction-398"><span class="linenos">398</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">currentInstr</span><span class="o">.</span><span class="n">affectedRegs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Simulator.explainInstruction-399"><a href="#Simulator.explainInstruction-399"><span class="linenos">399</span></a>                        <span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentInstr</span><span class="o">.</span><span class="n">affectedMem</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Simulator.explainInstruction-400"><a href="#Simulator.explainInstruction-400"><span class="linenos">400</span></a>                    <span class="p">),</span>
</span><span id="Simulator.explainInstruction-401"><a href="#Simulator.explainInstruction-401"><span class="linenos">401</span></a>                <span class="p">],</span>
</span><span id="Simulator.explainInstruction-402"><a href="#Simulator.explainInstruction-402"><span class="linenos">402</span></a>                <span class="p">[</span>
</span><span id="Simulator.explainInstruction-403"><a href="#Simulator.explainInstruction-403"><span class="linenos">403</span></a>                    <span class="s2">&quot;highlightWrite&quot;</span><span class="p">,</span>
</span><span id="Simulator.explainInstruction-404"><a href="#Simulator.explainInstruction-404"><span class="linenos">404</span></a>                    <span class="nb">list</span><span class="p">(</span>
</span><span id="Simulator.explainInstruction-405"><a href="#Simulator.explainInstruction-405"><span class="linenos">405</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">currentInstr</span><span class="o">.</span><span class="n">affectedRegs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Simulator.explainInstruction-406"><a href="#Simulator.explainInstruction-406"><span class="linenos">406</span></a>                        <span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentInstr</span><span class="o">.</span><span class="n">affectedMem</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Simulator.explainInstruction-407"><a href="#Simulator.explainInstruction-407"><span class="linenos">407</span></a>                    <span class="p">),</span>
</span><span id="Simulator.explainInstruction-408"><a href="#Simulator.explainInstruction-408"><span class="linenos">408</span></a>                <span class="p">],</span>
</span><span id="Simulator.explainInstruction-409"><a href="#Simulator.explainInstruction-409"><span class="linenos">409</span></a>                <span class="p">[</span><span class="s2">&quot;nextline&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentInstr</span><span class="o">.</span><span class="n">nextAddressToExecute</span><span class="p">],</span>
</span><span id="Simulator.explainInstruction-410"><a href="#Simulator.explainInstruction-410"><span class="linenos">410</span></a>                <span class="p">[</span><span class="s2">&quot;disassembly&quot;</span><span class="p">,</span> <span class="n">dis</span><span class="p">],</span>
</span><span id="Simulator.explainInstruction-411"><a href="#Simulator.explainInstruction-411"><span class="linenos">411</span></a>            <span class="p">)</span>
</span><span id="Simulator.explainInstruction-412"><a href="#Simulator.explainInstruction-412"><span class="linenos">412</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Simulator.explainInstruction-413"><a href="#Simulator.explainInstruction-413"><span class="linenos">413</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">disassemblyInfo</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="Simulator.explainInstruction-414"><a href="#Simulator.explainInstruction-414"><span class="linenos">414</span></a>                <span class="p">[</span>
</span><span id="Simulator.explainInstruction-415"><a href="#Simulator.explainInstruction-415"><span class="linenos">415</span></a>                    <span class="s2">&quot;highlightRead&quot;</span><span class="p">,</span>
</span><span id="Simulator.explainInstruction-416"><a href="#Simulator.explainInstruction-416"><span class="linenos">416</span></a>                    <span class="nb">list</span><span class="p">(</span>
</span><span id="Simulator.explainInstruction-417"><a href="#Simulator.explainInstruction-417"><span class="linenos">417</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">currentInstr</span><span class="o">.</span><span class="n">affectedRegs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Simulator.explainInstruction-418"><a href="#Simulator.explainInstruction-418"><span class="linenos">418</span></a>                        <span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentInstr</span><span class="o">.</span><span class="n">affectedMem</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Simulator.explainInstruction-419"><a href="#Simulator.explainInstruction-419"><span class="linenos">419</span></a>                    <span class="p">),</span>
</span><span id="Simulator.explainInstruction-420"><a href="#Simulator.explainInstruction-420"><span class="linenos">420</span></a>                <span class="p">],</span>
</span><span id="Simulator.explainInstruction-421"><a href="#Simulator.explainInstruction-421"><span class="linenos">421</span></a>                <span class="p">[</span>
</span><span id="Simulator.explainInstruction-422"><a href="#Simulator.explainInstruction-422"><span class="linenos">422</span></a>                    <span class="s2">&quot;highlightWrite&quot;</span><span class="p">,</span>
</span><span id="Simulator.explainInstruction-423"><a href="#Simulator.explainInstruction-423"><span class="linenos">423</span></a>                    <span class="nb">list</span><span class="p">(</span>
</span><span id="Simulator.explainInstruction-424"><a href="#Simulator.explainInstruction-424"><span class="linenos">424</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">currentInstr</span><span class="o">.</span><span class="n">affectedRegs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Simulator.explainInstruction-425"><a href="#Simulator.explainInstruction-425"><span class="linenos">425</span></a>                        <span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentInstr</span><span class="o">.</span><span class="n">affectedMem</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Simulator.explainInstruction-426"><a href="#Simulator.explainInstruction-426"><span class="linenos">426</span></a>                    <span class="p">),</span>
</span><span id="Simulator.explainInstruction-427"><a href="#Simulator.explainInstruction-427"><span class="linenos">427</span></a>                <span class="p">],</span>
</span><span id="Simulator.explainInstruction-428"><a href="#Simulator.explainInstruction-428"><span class="linenos">428</span></a>                <span class="p">[</span><span class="s2">&quot;disassembly&quot;</span><span class="p">,</span> <span class="n">dis</span><span class="p">],</span>
</span><span id="Simulator.explainInstruction-429"><a href="#Simulator.explainInstruction-429"><span class="linenos">429</span></a>            <span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="Simulator.execAssert" class="classattr">
                                        <input id="Simulator.execAssert-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">execAssert</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">assertionsList</span>, </span><span class="param"><span class="n">mode</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Simulator.execAssert-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Simulator.execAssert"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Simulator.execAssert-431"><a href="#Simulator.execAssert-431"><span class="linenos">431</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">execAssert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">assertionsList</span><span class="p">,</span> <span class="n">mode</span><span class="p">):</span>
</span><span id="Simulator.execAssert-432"><a href="#Simulator.execAssert-432"><span class="linenos">432</span></a>        <span class="k">for</span> <span class="n">assertionInfo</span> <span class="ow">in</span> <span class="n">assertionsList</span><span class="p">:</span>
</span><span id="Simulator.execAssert-433"><a href="#Simulator.execAssert-433"><span class="linenos">433</span></a>            <span class="n">assertionType</span> <span class="o">=</span> <span class="n">assertionInfo</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Simulator.execAssert-434"><a href="#Simulator.execAssert-434"><span class="linenos">434</span></a>            <span class="k">if</span> <span class="n">assertionType</span> <span class="o">!=</span> <span class="n">mode</span><span class="p">:</span>
</span><span id="Simulator.execAssert-435"><a href="#Simulator.execAssert-435"><span class="linenos">435</span></a>                <span class="k">continue</span>
</span><span id="Simulator.execAssert-436"><a href="#Simulator.execAssert-436"><span class="linenos">436</span></a>            <span class="n">assertionLine</span> <span class="o">=</span> <span class="n">assertionInfo</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Simulator.execAssert-437"><a href="#Simulator.execAssert-437"><span class="linenos">437</span></a>            <span class="n">assertionInfo</span> <span class="o">=</span> <span class="n">assertionInfo</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
</span><span id="Simulator.execAssert-438"><a href="#Simulator.execAssert-438"><span class="linenos">438</span></a>
</span><span id="Simulator.execAssert-439"><a href="#Simulator.execAssert-439"><span class="linenos">439</span></a>            <span class="n">strError</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span id="Simulator.execAssert-440"><a href="#Simulator.execAssert-440"><span class="linenos">440</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="Simulator.execAssert-441"><a href="#Simulator.execAssert-441"><span class="linenos">441</span></a>                <span class="k">for</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">assertionInfo</span><span class="p">:</span>
</span><span id="Simulator.execAssert-442"><a href="#Simulator.execAssert-442"><span class="linenos">442</span></a>                    <span class="n">info</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span><span id="Simulator.execAssert-443"><a href="#Simulator.execAssert-443"><span class="linenos">443</span></a>                    <span class="k">if</span> <span class="s2">&quot;=&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">info</span><span class="p">:</span>
</span><span id="Simulator.execAssert-444"><a href="#Simulator.execAssert-444"><span class="linenos">444</span></a>                        <span class="c1"># Bad syntax, we skip</span>
</span><span id="Simulator.execAssert-445"><a href="#Simulator.execAssert-445"><span class="linenos">445</span></a>                        <span class="k">continue</span>
</span><span id="Simulator.execAssert-446"><a href="#Simulator.execAssert-446"><span class="linenos">446</span></a>                    <span class="n">target</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">)</span>
</span><span id="Simulator.execAssert-447"><a href="#Simulator.execAssert-447"><span class="linenos">447</span></a>
</span><span id="Simulator.execAssert-448"><a href="#Simulator.execAssert-448"><span class="linenos">448</span></a>                    <span class="c1"># The rest of the code assume that a register is encoded</span>
</span><span id="Simulator.execAssert-449"><a href="#Simulator.execAssert-449"><span class="linenos">449</span></a>                    <span class="c1"># as R**, so we convert the alternative names</span>
</span><span id="Simulator.execAssert-450"><a href="#Simulator.execAssert-450"><span class="linenos">450</span></a>                    <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;SP&quot;</span><span class="p">,</span> <span class="s2">&quot;LR&quot;</span><span class="p">,</span> <span class="s2">&quot;PC&quot;</span><span class="p">):</span>
</span><span id="Simulator.execAssert-451"><a href="#Simulator.execAssert-451"><span class="linenos">451</span></a>                        <span class="n">value</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;SP&quot;</span><span class="p">:</span> <span class="s2">&quot;R13&quot;</span><span class="p">,</span> <span class="s2">&quot;LR&quot;</span><span class="p">:</span> <span class="s2">&quot;R14&quot;</span><span class="p">,</span> <span class="s2">&quot;PC&quot;</span><span class="p">:</span> <span class="s2">&quot;R15&quot;</span><span class="p">}[</span><span class="n">value</span><span class="p">]</span>
</span><span id="Simulator.execAssert-452"><a href="#Simulator.execAssert-452"><span class="linenos">452</span></a>                    <span class="k">if</span> <span class="n">target</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;SP&quot;</span><span class="p">,</span> <span class="s2">&quot;LR&quot;</span><span class="p">,</span> <span class="s2">&quot;PC&quot;</span><span class="p">):</span>
</span><span id="Simulator.execAssert-453"><a href="#Simulator.execAssert-453"><span class="linenos">453</span></a>                        <span class="n">target</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;SP&quot;</span><span class="p">:</span> <span class="s2">&quot;R13&quot;</span><span class="p">,</span> <span class="s2">&quot;LR&quot;</span><span class="p">:</span> <span class="s2">&quot;R14&quot;</span><span class="p">,</span> <span class="s2">&quot;PC&quot;</span><span class="p">:</span> <span class="s2">&quot;R15&quot;</span><span class="p">}[</span><span class="n">target</span><span class="p">]</span>
</span><span id="Simulator.execAssert-454"><a href="#Simulator.execAssert-454"><span class="linenos">454</span></a>
</span><span id="Simulator.execAssert-455"><a href="#Simulator.execAssert-455"><span class="linenos">455</span></a>                    <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">strip</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;R&quot;</span><span class="p">:</span>
</span><span id="Simulator.execAssert-456"><a href="#Simulator.execAssert-456"><span class="linenos">456</span></a>                        <span class="c1"># The target is another register</span>
</span><span id="Simulator.execAssert-457"><a href="#Simulator.execAssert-457"><span class="linenos">457</span></a>                        <span class="n">regtarget</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
</span><span id="Simulator.execAssert-458"><a href="#Simulator.execAssert-458"><span class="linenos">458</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">regs</span><span class="o">.</span><span class="n">deactivateBreakpoints</span><span class="p">()</span>
</span><span id="Simulator.execAssert-459"><a href="#Simulator.execAssert-459"><span class="linenos">459</span></a>                        <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">regs</span><span class="p">[</span><span class="n">regtarget</span><span class="p">]</span>
</span><span id="Simulator.execAssert-460"><a href="#Simulator.execAssert-460"><span class="linenos">460</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">regs</span><span class="o">.</span><span class="n">reactivateBreakpoints</span><span class="p">()</span>
</span><span id="Simulator.execAssert-461"><a href="#Simulator.execAssert-461"><span class="linenos">461</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="Simulator.execAssert-462"><a href="#Simulator.execAssert-462"><span class="linenos">462</span></a>                        <span class="c1"># The target is a constant</span>
</span><span id="Simulator.execAssert-463"><a href="#Simulator.execAssert-463"><span class="linenos">463</span></a>                        <span class="n">regtarget</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Simulator.execAssert-464"><a href="#Simulator.execAssert-464"><span class="linenos">464</span></a>                        <span class="k">try</span><span class="p">:</span>
</span><span id="Simulator.execAssert-465"><a href="#Simulator.execAssert-465"><span class="linenos">465</span></a>                            <span class="n">val</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">base</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFF</span>
</span><span id="Simulator.execAssert-466"><a href="#Simulator.execAssert-466"><span class="linenos">466</span></a>                        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
</span><span id="Simulator.execAssert-467"><a href="#Simulator.execAssert-467"><span class="linenos">467</span></a>                            <span class="c1"># If this is a decimal with leading zeros, base=0 will crash</span>
</span><span id="Simulator.execAssert-468"><a href="#Simulator.execAssert-468"><span class="linenos">468</span></a>                            <span class="n">val</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">base</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFF</span>
</span><span id="Simulator.execAssert-469"><a href="#Simulator.execAssert-469"><span class="linenos">469</span></a>
</span><span id="Simulator.execAssert-470"><a href="#Simulator.execAssert-470"><span class="linenos">470</span></a>                    <span class="k">if</span> <span class="n">target</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;R&quot;</span><span class="p">:</span>
</span><span id="Simulator.execAssert-471"><a href="#Simulator.execAssert-471"><span class="linenos">471</span></a>                        <span class="c1"># Register</span>
</span><span id="Simulator.execAssert-472"><a href="#Simulator.execAssert-472"><span class="linenos">472</span></a>                        <span class="n">reg</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">target</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
</span><span id="Simulator.execAssert-473"><a href="#Simulator.execAssert-473"><span class="linenos">473</span></a>
</span><span id="Simulator.execAssert-474"><a href="#Simulator.execAssert-474"><span class="linenos">474</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">regs</span><span class="o">.</span><span class="n">deactivateBreakpoints</span><span class="p">()</span>
</span><span id="Simulator.execAssert-475"><a href="#Simulator.execAssert-475"><span class="linenos">475</span></a>                        <span class="n">valreg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">regs</span><span class="p">[</span><span class="n">reg</span><span class="p">]</span>
</span><span id="Simulator.execAssert-476"><a href="#Simulator.execAssert-476"><span class="linenos">476</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">regs</span><span class="o">.</span><span class="n">reactivateBreakpoints</span><span class="p">()</span>
</span><span id="Simulator.execAssert-477"><a href="#Simulator.execAssert-477"><span class="linenos">477</span></a>                        <span class="k">if</span> <span class="n">valreg</span> <span class="o">!=</span> <span class="n">val</span><span class="p">:</span>
</span><span id="Simulator.execAssert-478"><a href="#Simulator.execAssert-478"><span class="linenos">478</span></a>                            <span class="k">if</span> <span class="n">regtarget</span><span class="p">:</span>
</span><span id="Simulator.execAssert-479"><a href="#Simulator.execAssert-479"><span class="linenos">479</span></a>                                <span class="n">strError</span> <span class="o">+=</span> <span class="n">appState</span><span class="o">.</span><span class="n">getT</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="Simulator.execAssert-480"><a href="#Simulator.execAssert-480"><span class="linenos">480</span></a>                                    <span class="n">target</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">regtarget</span><span class="p">,</span> <span class="n">valreg</span>
</span><span id="Simulator.execAssert-481"><a href="#Simulator.execAssert-481"><span class="linenos">481</span></a>                                <span class="p">)</span>
</span><span id="Simulator.execAssert-482"><a href="#Simulator.execAssert-482"><span class="linenos">482</span></a>                            <span class="k">else</span><span class="p">:</span>
</span><span id="Simulator.execAssert-483"><a href="#Simulator.execAssert-483"><span class="linenos">483</span></a>                                <span class="n">strError</span> <span class="o">+=</span> <span class="n">appState</span><span class="o">.</span><span class="n">getT</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="Simulator.execAssert-484"><a href="#Simulator.execAssert-484"><span class="linenos">484</span></a>                                    <span class="n">target</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">valreg</span>
</span><span id="Simulator.execAssert-485"><a href="#Simulator.execAssert-485"><span class="linenos">485</span></a>                                <span class="p">)</span>
</span><span id="Simulator.execAssert-486"><a href="#Simulator.execAssert-486"><span class="linenos">486</span></a>                    <span class="k">elif</span> <span class="n">target</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;0X&quot;</span><span class="p">:</span>
</span><span id="Simulator.execAssert-487"><a href="#Simulator.execAssert-487"><span class="linenos">487</span></a>                        <span class="c1"># Memory</span>
</span><span id="Simulator.execAssert-488"><a href="#Simulator.execAssert-488"><span class="linenos">488</span></a>                        <span class="n">addr</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">base</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
</span><span id="Simulator.execAssert-489"><a href="#Simulator.execAssert-489"><span class="linenos">489</span></a>
</span><span id="Simulator.execAssert-490"><a href="#Simulator.execAssert-490"><span class="linenos">490</span></a>                        <span class="n">formatStruct</span> <span class="o">=</span> <span class="s2">&quot;&lt;B&quot;</span>
</span><span id="Simulator.execAssert-491"><a href="#Simulator.execAssert-491"><span class="linenos">491</span></a>                        <span class="k">if</span> <span class="ow">not</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="nb">int</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">255</span><span class="p">:</span>
</span><span id="Simulator.execAssert-492"><a href="#Simulator.execAssert-492"><span class="linenos">492</span></a>                            <span class="n">val</span> <span class="o">&amp;=</span> <span class="mh">0xFFFFFFFF</span>
</span><span id="Simulator.execAssert-493"><a href="#Simulator.execAssert-493"><span class="linenos">493</span></a>                            <span class="n">formatStruct</span> <span class="o">=</span> <span class="s2">&quot;&lt;I&quot;</span>
</span><span id="Simulator.execAssert-494"><a href="#Simulator.execAssert-494"><span class="linenos">494</span></a>                        <span class="n">valmem</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mem</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
</span><span id="Simulator.execAssert-495"><a href="#Simulator.execAssert-495"><span class="linenos">495</span></a>                            <span class="n">addr</span><span class="p">,</span>
</span><span id="Simulator.execAssert-496"><a href="#Simulator.execAssert-496"><span class="linenos">496</span></a>                            <span class="n">mayTriggerBkpt</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="Simulator.execAssert-497"><a href="#Simulator.execAssert-497"><span class="linenos">497</span></a>                            <span class="n">size</span><span class="o">=</span><span class="mi">4</span> <span class="k">if</span> <span class="n">formatStruct</span> <span class="o">==</span> <span class="s2">&quot;&lt;I&quot;</span> <span class="k">else</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="Simulator.execAssert-498"><a href="#Simulator.execAssert-498"><span class="linenos">498</span></a>                        <span class="p">)</span>
</span><span id="Simulator.execAssert-499"><a href="#Simulator.execAssert-499"><span class="linenos">499</span></a>                        <span class="n">valmem</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">formatStruct</span><span class="p">,</span> <span class="n">valmem</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Simulator.execAssert-500"><a href="#Simulator.execAssert-500"><span class="linenos">500</span></a>                        <span class="k">if</span> <span class="n">valmem</span> <span class="o">!=</span> <span class="n">val</span><span class="p">:</span>
</span><span id="Simulator.execAssert-501"><a href="#Simulator.execAssert-501"><span class="linenos">501</span></a>                            <span class="k">if</span> <span class="n">regtarget</span><span class="p">:</span>
</span><span id="Simulator.execAssert-502"><a href="#Simulator.execAssert-502"><span class="linenos">502</span></a>                                <span class="n">strError</span> <span class="o">+=</span> <span class="n">appState</span><span class="o">.</span><span class="n">getT</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="Simulator.execAssert-503"><a href="#Simulator.execAssert-503"><span class="linenos">503</span></a>                                    <span class="n">target</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">regtarget</span><span class="p">,</span> <span class="n">valmem</span>
</span><span id="Simulator.execAssert-504"><a href="#Simulator.execAssert-504"><span class="linenos">504</span></a>                                <span class="p">)</span>
</span><span id="Simulator.execAssert-505"><a href="#Simulator.execAssert-505"><span class="linenos">505</span></a>                            <span class="k">else</span><span class="p">:</span>
</span><span id="Simulator.execAssert-506"><a href="#Simulator.execAssert-506"><span class="linenos">506</span></a>                                <span class="n">strError</span> <span class="o">+=</span> <span class="n">appState</span><span class="o">.</span><span class="n">getT</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="Simulator.execAssert-507"><a href="#Simulator.execAssert-507"><span class="linenos">507</span></a>                                    <span class="n">target</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">valmem</span>
</span><span id="Simulator.execAssert-508"><a href="#Simulator.execAssert-508"><span class="linenos">508</span></a>                                <span class="p">)</span>
</span><span id="Simulator.execAssert-509"><a href="#Simulator.execAssert-509"><span class="linenos">509</span></a>                    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">target</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">target</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">regs</span><span class="o">.</span><span class="n">flag2index</span><span class="p">:</span>
</span><span id="Simulator.execAssert-510"><a href="#Simulator.execAssert-510"><span class="linenos">510</span></a>                        <span class="c1"># Flag</span>
</span><span id="Simulator.execAssert-511"><a href="#Simulator.execAssert-511"><span class="linenos">511</span></a>                        <span class="n">expectedVal</span> <span class="o">=</span> <span class="n">value</span> <span class="o">!=</span> <span class="s2">&quot;0&quot;</span>
</span><span id="Simulator.execAssert-512"><a href="#Simulator.execAssert-512"><span class="linenos">512</span></a>                        <span class="n">actualVal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">regs</span><span class="o">.</span><span class="fm">__getattribute__</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
</span><span id="Simulator.execAssert-513"><a href="#Simulator.execAssert-513"><span class="linenos">513</span></a>                        <span class="k">if</span> <span class="n">actualVal</span> <span class="o">!=</span> <span class="n">expectedVal</span><span class="p">:</span>
</span><span id="Simulator.execAssert-514"><a href="#Simulator.execAssert-514"><span class="linenos">514</span></a>                            <span class="n">strError</span> <span class="o">+=</span> <span class="n">appState</span><span class="o">.</span><span class="n">getT</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="Simulator.execAssert-515"><a href="#Simulator.execAssert-515"><span class="linenos">515</span></a>                                <span class="n">target</span><span class="p">,</span> <span class="n">expectedVal</span><span class="p">,</span> <span class="n">actualVal</span>
</span><span id="Simulator.execAssert-516"><a href="#Simulator.execAssert-516"><span class="linenos">516</span></a>                            <span class="p">)</span>
</span><span id="Simulator.execAssert-517"><a href="#Simulator.execAssert-517"><span class="linenos">517</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="Simulator.execAssert-518"><a href="#Simulator.execAssert-518"><span class="linenos">518</span></a>                        <span class="c1"># Assert type unknown</span>
</span><span id="Simulator.execAssert-519"><a href="#Simulator.execAssert-519"><span class="linenos">519</span></a>                        <span class="n">strError</span> <span class="o">+=</span> <span class="n">appState</span><span class="o">.</span><span class="n">getT</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="Simulator.execAssert-520"><a href="#Simulator.execAssert-520"><span class="linenos">520</span></a>                            <span class="n">target</span><span class="p">,</span> <span class="n">value</span>
</span><span id="Simulator.execAssert-521"><a href="#Simulator.execAssert-521"><span class="linenos">521</span></a>                        <span class="p">)</span>
</span><span id="Simulator.execAssert-522"><a href="#Simulator.execAssert-522"><span class="linenos">522</span></a>
</span><span id="Simulator.execAssert-523"><a href="#Simulator.execAssert-523"><span class="linenos">523</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">strError</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Simulator.execAssert-524"><a href="#Simulator.execAssert-524"><span class="linenos">524</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">errorsPending</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;assert&quot;</span><span class="p">,</span> <span class="n">strError</span><span class="p">,</span> <span class="n">assertionLine</span><span class="p">)</span>
</span><span id="Simulator.execAssert-525"><a href="#Simulator.execAssert-525"><span class="linenos">525</span></a>
</span><span id="Simulator.execAssert-526"><a href="#Simulator.execAssert-526"><span class="linenos">526</span></a>            <span class="k">except</span> <span class="n">ComponentException</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
</span><span id="Simulator.execAssert-527"><a href="#Simulator.execAssert-527"><span class="linenos">527</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">errorsPending</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ex</span><span class="o">.</span><span class="n">cmp</span><span class="p">,</span> <span class="n">ex</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="n">assertionLine</span><span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="Simulator.nextInstr" class="classattr">
                                        <input id="Simulator.nextInstr-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">nextInstr</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">forceExplain</span><span class="o">=</span><span class="kc">False</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Simulator.nextInstr-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Simulator.nextInstr"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Simulator.nextInstr-529"><a href="#Simulator.nextInstr-529"><span class="linenos">529</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">nextInstr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">forceExplain</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="Simulator.nextInstr-530"><a href="#Simulator.nextInstr-530"><span class="linenos">530</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentInstr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Simulator.nextInstr-531"><a href="#Simulator.nextInstr-531"><span class="linenos">531</span></a>            <span class="c1"># The current instruction has not be retrieved or decoded (because it was an illegal access)</span>
</span><span id="Simulator.nextInstr-532"><a href="#Simulator.nextInstr-532"><span class="linenos">532</span></a>            <span class="c1"># We raise the last error to explain the illegal access</span>
</span><span id="Simulator.nextInstr-533"><a href="#Simulator.nextInstr-533"><span class="linenos">533</span></a>            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">errorsPending</span>
</span><span id="Simulator.nextInstr-534"><a href="#Simulator.nextInstr-534"><span class="linenos">534</span></a>
</span><span id="Simulator.nextInstr-535"><a href="#Simulator.nextInstr-535"><span class="linenos">535</span></a>        <span class="n">isFirstInst</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">runIteration</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">cyclesCount</span>
</span><span id="Simulator.nextInstr-536"><a href="#Simulator.nextInstr-536"><span class="linenos">536</span></a>        <span class="c1"># One more cycle to do!</span>
</span><span id="Simulator.nextInstr-537"><a href="#Simulator.nextInstr-537"><span class="linenos">537</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">newCycle</span><span class="p">()</span>
</span><span id="Simulator.nextInstr-538"><a href="#Simulator.nextInstr-538"><span class="linenos">538</span></a>        <span class="c1"># Clear previous errors</span>
</span><span id="Simulator.nextInstr-539"><a href="#Simulator.nextInstr-539"><span class="linenos">539</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">errorsPending</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
</span><span id="Simulator.nextInstr-540"><a href="#Simulator.nextInstr-540"><span class="linenos">540</span></a>
</span><span id="Simulator.nextInstr-541"><a href="#Simulator.nextInstr-541"><span class="linenos">541</span></a>        <span class="n">keeppc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">regs</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">pcoffset</span>
</span><span id="Simulator.nextInstr-542"><a href="#Simulator.nextInstr-542"><span class="linenos">542</span></a>
</span><span id="Simulator.nextInstr-543"><a href="#Simulator.nextInstr-543"><span class="linenos">543</span></a>        <span class="n">currentCallStackLen</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">callStack</span><span class="p">)</span>
</span><span id="Simulator.nextInstr-544"><a href="#Simulator.nextInstr-544"><span class="linenos">544</span></a>
</span><span id="Simulator.nextInstr-545"><a href="#Simulator.nextInstr-545"><span class="linenos">545</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stepMode</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;out&quot;</span><span class="p">,</span> <span class="s2">&quot;run&quot;</span><span class="p">,</span> <span class="s2">&quot;forward&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">isFirstInst</span><span class="p">:</span>
</span><span id="Simulator.nextInstr-546"><a href="#Simulator.nextInstr-546"><span class="linenos">546</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bkptLastFetch</span><span class="p">:</span>
</span><span id="Simulator.nextInstr-547"><a href="#Simulator.nextInstr-547"><span class="linenos">547</span></a>                <span class="c1"># We hit a breakpoint on the last decoded instruction</span>
</span><span id="Simulator.nextInstr-548"><a href="#Simulator.nextInstr-548"><span class="linenos">548</span></a>                <span class="n">err</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bkptLastFetch</span>
</span><span id="Simulator.nextInstr-549"><a href="#Simulator.nextInstr-549"><span class="linenos">549</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">bkptLastFetch</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Simulator.nextInstr-550"><a href="#Simulator.nextInstr-550"><span class="linenos">550</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">restartCycle</span><span class="p">()</span>
</span><span id="Simulator.nextInstr-551"><a href="#Simulator.nextInstr-551"><span class="linenos">551</span></a>                <span class="k">raise</span> <span class="n">err</span>
</span><span id="Simulator.nextInstr-552"><a href="#Simulator.nextInstr-552"><span class="linenos">552</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="Simulator.nextInstr-553"><a href="#Simulator.nextInstr-553"><span class="linenos">553</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">currentInstr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span id="Simulator.nextInstr-554"><a href="#Simulator.nextInstr-554"><span class="linenos">554</span></a>            <span class="k">except</span> <span class="n">Breakpoint</span> <span class="k">as</span> <span class="n">bp</span><span class="p">:</span>
</span><span id="Simulator.nextInstr-555"><a href="#Simulator.nextInstr-555"><span class="linenos">555</span></a>                <span class="c1"># We hit a breakpoint on READ/WRITE</span>
</span><span id="Simulator.nextInstr-556"><a href="#Simulator.nextInstr-556"><span class="linenos">556</span></a>                <span class="c1"># We temporary disable the raised breakpoint</span>
</span><span id="Simulator.nextInstr-557"><a href="#Simulator.nextInstr-557"><span class="linenos">557</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">deactivatedBkpts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span>
</span><span id="Simulator.nextInstr-558"><a href="#Simulator.nextInstr-558"><span class="linenos">558</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_toggleBreakpoint</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span>
</span><span id="Simulator.nextInstr-559"><a href="#Simulator.nextInstr-559"><span class="linenos">559</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">restartCycle</span><span class="p">()</span>
</span><span id="Simulator.nextInstr-560"><a href="#Simulator.nextInstr-560"><span class="linenos">560</span></a>                <span class="k">raise</span> <span class="n">bp</span>
</span><span id="Simulator.nextInstr-561"><a href="#Simulator.nextInstr-561"><span class="linenos">561</span></a>            <span class="k">except</span> <span class="n">ComponentException</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
</span><span id="Simulator.nextInstr-562"><a href="#Simulator.nextInstr-562"><span class="linenos">562</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">errorsPending</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">err</span><span class="o">.</span><span class="n">cmp</span><span class="p">,</span> <span class="n">err</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">getCurrentLine</span><span class="p">())</span>
</span><span id="Simulator.nextInstr-563"><a href="#Simulator.nextInstr-563"><span class="linenos">563</span></a>            <span class="k">except</span> <span class="n">ExecutionException</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
</span><span id="Simulator.nextInstr-564"><a href="#Simulator.nextInstr-564"><span class="linenos">564</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">errorsPending</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;execution&quot;</span><span class="p">,</span> <span class="n">err</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">getCurrentLine</span><span class="p">())</span>
</span><span id="Simulator.nextInstr-565"><a href="#Simulator.nextInstr-565"><span class="linenos">565</span></a>
</span><span id="Simulator.nextInstr-566"><a href="#Simulator.nextInstr-566"><span class="linenos">566</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Simulator.nextInstr-567"><a href="#Simulator.nextInstr-567"><span class="linenos">567</span></a>            <span class="c1"># In stepIn mode or this is the first step to be execute in this mode.</span>
</span><span id="Simulator.nextInstr-568"><a href="#Simulator.nextInstr-568"><span class="linenos">568</span></a>            <span class="c1"># Breakpoints are temporary deactivate</span>
</span><span id="Simulator.nextInstr-569"><a href="#Simulator.nextInstr-569"><span class="linenos">569</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="Simulator.nextInstr-570"><a href="#Simulator.nextInstr-570"><span class="linenos">570</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">deactivateAllBreakpoints</span><span class="p">()</span>
</span><span id="Simulator.nextInstr-571"><a href="#Simulator.nextInstr-571"><span class="linenos">571</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">currentInstr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span id="Simulator.nextInstr-572"><a href="#Simulator.nextInstr-572"><span class="linenos">572</span></a>            <span class="k">except</span> <span class="n">ComponentException</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
</span><span id="Simulator.nextInstr-573"><a href="#Simulator.nextInstr-573"><span class="linenos">573</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">errorsPending</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">err</span><span class="o">.</span><span class="n">cmp</span><span class="p">,</span> <span class="n">err</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">getCurrentLine</span><span class="p">())</span>
</span><span id="Simulator.nextInstr-574"><a href="#Simulator.nextInstr-574"><span class="linenos">574</span></a>            <span class="k">except</span> <span class="n">ExecutionException</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
</span><span id="Simulator.nextInstr-575"><a href="#Simulator.nextInstr-575"><span class="linenos">575</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">errorsPending</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;execution&quot;</span><span class="p">,</span> <span class="n">err</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">getCurrentLine</span><span class="p">())</span>
</span><span id="Simulator.nextInstr-576"><a href="#Simulator.nextInstr-576"><span class="linenos">576</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">reactivateAllBreakpoints</span><span class="p">()</span>
</span><span id="Simulator.nextInstr-577"><a href="#Simulator.nextInstr-577"><span class="linenos">577</span></a>
</span><span id="Simulator.nextInstr-578"><a href="#Simulator.nextInstr-578"><span class="linenos">578</span></a>        <span class="c1"># After instruction execution, restore all breakpoints</span>
</span><span id="Simulator.nextInstr-579"><a href="#Simulator.nextInstr-579"><span class="linenos">579</span></a>        <span class="k">for</span> <span class="n">bp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">deactivatedBkpts</span><span class="p">:</span>
</span><span id="Simulator.nextInstr-580"><a href="#Simulator.nextInstr-580"><span class="linenos">580</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_toggleBreakpoint</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span>
</span><span id="Simulator.nextInstr-581"><a href="#Simulator.nextInstr-581"><span class="linenos">581</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">deactivatedBkpts</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Simulator.nextInstr-582"><a href="#Simulator.nextInstr-582"><span class="linenos">582</span></a>
</span><span id="Simulator.nextInstr-583"><a href="#Simulator.nextInstr-583"><span class="linenos">583</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentInstr</span><span class="o">.</span><span class="n">pcmodified</span><span class="p">:</span>
</span><span id="Simulator.nextInstr-584"><a href="#Simulator.nextInstr-584"><span class="linenos">584</span></a>            <span class="c1"># If PC was modified, we simulate the prefetch by adding 8 immediately to it</span>
</span><span id="Simulator.nextInstr-585"><a href="#Simulator.nextInstr-585"><span class="linenos">585</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">regs</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pcoffset</span>
</span><span id="Simulator.nextInstr-586"><a href="#Simulator.nextInstr-586"><span class="linenos">586</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Simulator.nextInstr-587"><a href="#Simulator.nextInstr-587"><span class="linenos">587</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">regs</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">4</span>  <span class="c1"># PC = PC + 4</span>
</span><span id="Simulator.nextInstr-588"><a href="#Simulator.nextInstr-588"><span class="linenos">588</span></a>
</span><span id="Simulator.nextInstr-589"><a href="#Simulator.nextInstr-589"><span class="linenos">589</span></a>        <span class="n">newpc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">regs</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">pcoffset</span>
</span><span id="Simulator.nextInstr-590"><a href="#Simulator.nextInstr-590"><span class="linenos">590</span></a>        <span class="k">if</span> <span class="n">keeppc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertionCkpts</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentInstr</span><span class="o">.</span><span class="n">pcmodified</span><span class="p">:</span>
</span><span id="Simulator.nextInstr-591"><a href="#Simulator.nextInstr-591"><span class="linenos">591</span></a>            <span class="c1"># We check if we&#39;ve hit an post-assertion checkpoint</span>
</span><span id="Simulator.nextInstr-592"><a href="#Simulator.nextInstr-592"><span class="linenos">592</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">execAssert</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">assertionData</span><span class="p">[</span><span class="n">keeppc</span><span class="p">],</span> <span class="s2">&quot;AFTER&quot;</span><span class="p">)</span>
</span><span id="Simulator.nextInstr-593"><a href="#Simulator.nextInstr-593"><span class="linenos">593</span></a>        <span class="k">elif</span> <span class="n">currentCallStackLen</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">callStack</span><span class="p">):</span>
</span><span id="Simulator.nextInstr-594"><a href="#Simulator.nextInstr-594"><span class="linenos">594</span></a>            <span class="c1"># We have branched out of a function</span>
</span><span id="Simulator.nextInstr-595"><a href="#Simulator.nextInstr-595"><span class="linenos">595</span></a>            <span class="c1"># If an assertion was following a BL and we exited a function, we want to execute it now!</span>
</span><span id="Simulator.nextInstr-596"><a href="#Simulator.nextInstr-596"><span class="linenos">596</span></a>            <span class="k">if</span> <span class="p">(</span>
</span><span id="Simulator.nextInstr-597"><a href="#Simulator.nextInstr-597"><span class="linenos">597</span></a>                <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">callStack</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertionWhenReturn</span>
</span><span id="Simulator.nextInstr-598"><a href="#Simulator.nextInstr-598"><span class="linenos">598</span></a>                <span class="ow">and</span> <span class="p">(</span><span class="n">newpc</span> <span class="o">-</span> <span class="mi">4</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertionCkpts</span>
</span><span id="Simulator.nextInstr-599"><a href="#Simulator.nextInstr-599"><span class="linenos">599</span></a>            <span class="p">):</span>
</span><span id="Simulator.nextInstr-600"><a href="#Simulator.nextInstr-600"><span class="linenos">600</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">execAssert</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">assertionData</span><span class="p">[</span><span class="n">newpc</span> <span class="o">-</span> <span class="mi">4</span><span class="p">],</span> <span class="s2">&quot;AFTER&quot;</span><span class="p">)</span>
</span><span id="Simulator.nextInstr-601"><a href="#Simulator.nextInstr-601"><span class="linenos">601</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">assertionWhenReturn</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">callStack</span><span class="p">))</span>
</span><span id="Simulator.nextInstr-602"><a href="#Simulator.nextInstr-602"><span class="linenos">602</span></a>        <span class="k">elif</span> <span class="n">currentCallStackLen</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">callStack</span><span class="p">):</span>
</span><span id="Simulator.nextInstr-603"><a href="#Simulator.nextInstr-603"><span class="linenos">603</span></a>            <span class="c1"># We have branched in a function</span>
</span><span id="Simulator.nextInstr-604"><a href="#Simulator.nextInstr-604"><span class="linenos">604</span></a>            <span class="c1"># We want to remember that we want to assert something when we return</span>
</span><span id="Simulator.nextInstr-605"><a href="#Simulator.nextInstr-605"><span class="linenos">605</span></a>            <span class="k">if</span> <span class="n">keeppc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertionCkpts</span><span class="p">:</span>
</span><span id="Simulator.nextInstr-606"><a href="#Simulator.nextInstr-606"><span class="linenos">606</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">assertionWhenReturn</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">currentCallStackLen</span><span class="p">)</span>
</span><span id="Simulator.nextInstr-607"><a href="#Simulator.nextInstr-607"><span class="linenos">607</span></a>
</span><span id="Simulator.nextInstr-608"><a href="#Simulator.nextInstr-608"><span class="linenos">608</span></a>        <span class="k">if</span> <span class="n">newpc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertionCkpts</span><span class="p">:</span>
</span><span id="Simulator.nextInstr-609"><a href="#Simulator.nextInstr-609"><span class="linenos">609</span></a>            <span class="c1"># We check if we&#39;ve hit an pre-assertion checkpoint (for the next instruction)</span>
</span><span id="Simulator.nextInstr-610"><a href="#Simulator.nextInstr-610"><span class="linenos">610</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">execAssert</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">assertionData</span><span class="p">[</span><span class="n">newpc</span><span class="p">],</span> <span class="s2">&quot;BEFORE&quot;</span><span class="p">)</span>
</span><span id="Simulator.nextInstr-611"><a href="#Simulator.nextInstr-611"><span class="linenos">611</span></a>
</span><span id="Simulator.nextInstr-612"><a href="#Simulator.nextInstr-612"><span class="linenos">612</span></a>        <span class="c1"># We look for interrupts</span>
</span><span id="Simulator.nextInstr-613"><a href="#Simulator.nextInstr-613"><span class="linenos">613</span></a>        <span class="c1"># The current instruction is always finished before the interrupt takes on</span>
</span><span id="Simulator.nextInstr-614"><a href="#Simulator.nextInstr-614"><span class="linenos">614</span></a>        <span class="c1"># TODO Handle special cases for LDM and STM</span>
</span><span id="Simulator.nextInstr-615"><a href="#Simulator.nextInstr-615"><span class="linenos">615</span></a>        <span class="k">if</span> <span class="p">(</span>
</span><span id="Simulator.nextInstr-616"><a href="#Simulator.nextInstr-616"><span class="linenos">616</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">interruptActive</span>
</span><span id="Simulator.nextInstr-617"><a href="#Simulator.nextInstr-617"><span class="linenos">617</span></a>            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">cyclesCount</span>
</span><span id="Simulator.nextInstr-618"><a href="#Simulator.nextInstr-618"><span class="linenos">618</span></a>            <span class="o">&gt;=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">interruptParams</span><span class="p">[</span><span class="s2">&quot;t0&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">interruptParams</span><span class="p">[</span><span class="s2">&quot;b&quot;</span><span class="p">])</span>
</span><span id="Simulator.nextInstr-619"><a href="#Simulator.nextInstr-619"><span class="linenos">619</span></a>            <span class="ow">and</span> <span class="p">(</span>
</span><span id="Simulator.nextInstr-620"><a href="#Simulator.nextInstr-620"><span class="linenos">620</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">cyclesCount</span>
</span><span id="Simulator.nextInstr-621"><a href="#Simulator.nextInstr-621"><span class="linenos">621</span></a>                <span class="o">-</span> <span class="mi">1</span>
</span><span id="Simulator.nextInstr-622"><a href="#Simulator.nextInstr-622"><span class="linenos">622</span></a>                <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">interruptParams</span><span class="p">[</span><span class="s2">&quot;t0&quot;</span><span class="p">]</span>
</span><span id="Simulator.nextInstr-623"><a href="#Simulator.nextInstr-623"><span class="linenos">623</span></a>                <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">interruptParams</span><span class="p">[</span><span class="s2">&quot;b&quot;</span><span class="p">]</span>
</span><span id="Simulator.nextInstr-624"><a href="#Simulator.nextInstr-624"><span class="linenos">624</span></a>            <span class="p">)</span>
</span><span id="Simulator.nextInstr-625"><a href="#Simulator.nextInstr-625"><span class="linenos">625</span></a>            <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">interruptParams</span><span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">]</span>
</span><span id="Simulator.nextInstr-626"><a href="#Simulator.nextInstr-626"><span class="linenos">626</span></a>            <span class="o">==</span> <span class="mi">0</span>
</span><span id="Simulator.nextInstr-627"><a href="#Simulator.nextInstr-627"><span class="linenos">627</span></a>        <span class="p">):</span>
</span><span id="Simulator.nextInstr-628"><a href="#Simulator.nextInstr-628"><span class="linenos">628</span></a>            <span class="k">if</span> <span class="p">(</span>
</span><span id="Simulator.nextInstr-629"><a href="#Simulator.nextInstr-629"><span class="linenos">629</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">interruptParams</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;FIQ&quot;</span>
</span><span id="Simulator.nextInstr-630"><a href="#Simulator.nextInstr-630"><span class="linenos">630</span></a>                <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">regs</span><span class="o">.</span><span class="n">FIQ</span>
</span><span id="Simulator.nextInstr-631"><a href="#Simulator.nextInstr-631"><span class="linenos">631</span></a>                <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">interruptParams</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;IRQ&quot;</span>
</span><span id="Simulator.nextInstr-632"><a href="#Simulator.nextInstr-632"><span class="linenos">632</span></a>                <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">regs</span><span class="o">.</span><span class="n">IRQ</span>
</span><span id="Simulator.nextInstr-633"><a href="#Simulator.nextInstr-633"><span class="linenos">633</span></a>                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">regs</span><span class="o">.</span><span class="n">mode</span> <span class="o">!=</span> <span class="s2">&quot;FIQ&quot;</span>
</span><span id="Simulator.nextInstr-634"><a href="#Simulator.nextInstr-634"><span class="linenos">634</span></a>            <span class="p">):</span>  <span class="c1"># Is the interrupt masked?</span>
</span><span id="Simulator.nextInstr-635"><a href="#Simulator.nextInstr-635"><span class="linenos">635</span></a>                <span class="c1"># Interruption!</span>
</span><span id="Simulator.nextInstr-636"><a href="#Simulator.nextInstr-636"><span class="linenos">636</span></a>                <span class="c1"># We enter it (the entry point is 0x18 for IRQ and 0x1C for FIQ)</span>
</span><span id="Simulator.nextInstr-637"><a href="#Simulator.nextInstr-637"><span class="linenos">637</span></a>                <span class="n">savedCPSR</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">regs</span><span class="o">.</span><span class="n">CPSR</span>  <span class="c1"># Keep CPSR before changing processor mode</span>
</span><span id="Simulator.nextInstr-638"><a href="#Simulator.nextInstr-638"><span class="linenos">638</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">regs</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interruptParams</span><span class="p">[</span>
</span><span id="Simulator.nextInstr-639"><a href="#Simulator.nextInstr-639"><span class="linenos">639</span></a>                    <span class="s2">&quot;type&quot;</span>
</span><span id="Simulator.nextInstr-640"><a href="#Simulator.nextInstr-640"><span class="linenos">640</span></a>                <span class="p">]</span>  <span class="c1"># Set the register bank and processor mode</span>
</span><span id="Simulator.nextInstr-641"><a href="#Simulator.nextInstr-641"><span class="linenos">641</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">regs</span><span class="o">.</span><span class="n">SPSR</span> <span class="o">=</span> <span class="n">savedCPSR</span>  <span class="c1"># Save the CPSR in the current SPSR</span>
</span><span id="Simulator.nextInstr-642"><a href="#Simulator.nextInstr-642"><span class="linenos">642</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">regs</span><span class="o">.</span><span class="n">IRQ</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="Simulator.nextInstr-643"><a href="#Simulator.nextInstr-643"><span class="linenos">643</span></a>                    <span class="kc">True</span>  <span class="c1"># IRQ are always disabled when we enter an interrupt</span>
</span><span id="Simulator.nextInstr-644"><a href="#Simulator.nextInstr-644"><span class="linenos">644</span></a>                <span class="p">)</span>
</span><span id="Simulator.nextInstr-645"><a href="#Simulator.nextInstr-645"><span class="linenos">645</span></a>                <span class="k">if</span> <span class="p">(</span>
</span><span id="Simulator.nextInstr-646"><a href="#Simulator.nextInstr-646"><span class="linenos">646</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">interruptParams</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;FIQ&quot;</span>
</span><span id="Simulator.nextInstr-647"><a href="#Simulator.nextInstr-647"><span class="linenos">647</span></a>                <span class="p">):</span>  <span class="c1"># If we enter a FIQ interrupt,</span>
</span><span id="Simulator.nextInstr-648"><a href="#Simulator.nextInstr-648"><span class="linenos">648</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">regs</span><span class="o">.</span><span class="n">FIQ</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1">#   then we disable also FIQ interrupts</span>
</span><span id="Simulator.nextInstr-649"><a href="#Simulator.nextInstr-649"><span class="linenos">649</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">regs</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="Simulator.nextInstr-650"><a href="#Simulator.nextInstr-650"><span class="linenos">650</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">regs</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">-</span> <span class="mi">4</span>
</span><span id="Simulator.nextInstr-651"><a href="#Simulator.nextInstr-651"><span class="linenos">651</span></a>                <span class="p">)</span>  <span class="c1"># Save PC in LR (on the FIQ or IRQ bank)</span>
</span><span id="Simulator.nextInstr-652"><a href="#Simulator.nextInstr-652"><span class="linenos">652</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">regs</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pcoffset</span> <span class="o">+</span> <span class="p">(</span>
</span><span id="Simulator.nextInstr-653"><a href="#Simulator.nextInstr-653"><span class="linenos">653</span></a>                    <span class="mh">0x18</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interruptParams</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;IRQ&quot;</span> <span class="k">else</span> <span class="mh">0x1C</span>
</span><span id="Simulator.nextInstr-654"><a href="#Simulator.nextInstr-654"><span class="linenos">654</span></a>                <span class="p">)</span>  <span class="c1"># Set PC to enter the interrupt</span>
</span><span id="Simulator.nextInstr-655"><a href="#Simulator.nextInstr-655"><span class="linenos">655</span></a>
</span><span id="Simulator.nextInstr-656"><a href="#Simulator.nextInstr-656"><span class="linenos">656</span></a>        <span class="c1"># We fetch and decode the next instruction</span>
</span><span id="Simulator.nextInstr-657"><a href="#Simulator.nextInstr-657"><span class="linenos">657</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fetchAndDecode</span><span class="p">(</span><span class="n">forceExplain</span><span class="p">)</span>
</span><span id="Simulator.nextInstr-658"><a href="#Simulator.nextInstr-658"><span class="linenos">658</span></a>
</span><span id="Simulator.nextInstr-659"><a href="#Simulator.nextInstr-659"><span class="linenos">659</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">errorsPending</span><span class="p">:</span>
</span><span id="Simulator.nextInstr-660"><a href="#Simulator.nextInstr-660"><span class="linenos">660</span></a>            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">errorsPending</span>
</span></pre></div>


    

                            </div>
                            <div id="Simulator.deactivateAllBreakpoints" class="classattr">
                                        <input id="Simulator.deactivateAllBreakpoints-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">deactivateAllBreakpoints</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Simulator.deactivateAllBreakpoints-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Simulator.deactivateAllBreakpoints"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Simulator.deactivateAllBreakpoints-662"><a href="#Simulator.deactivateAllBreakpoints-662"><span class="linenos">662</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">deactivateAllBreakpoints</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Simulator.deactivateAllBreakpoints-663"><a href="#Simulator.deactivateAllBreakpoints-663"><span class="linenos">663</span></a>        <span class="c1"># Without removing them, do not trig on breakpoint until `reactivateAllBreakpoints`</span>
</span><span id="Simulator.deactivateAllBreakpoints-664"><a href="#Simulator.deactivateAllBreakpoints-664"><span class="linenos">664</span></a>        <span class="c1"># is called. Useful to temporary disable breakpoints of Memory and Registers</span>
</span><span id="Simulator.deactivateAllBreakpoints-665"><a href="#Simulator.deactivateAllBreakpoints-665"><span class="linenos">665</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">regs</span><span class="o">.</span><span class="n">deactivateBreakpoints</span><span class="p">()</span>
</span><span id="Simulator.deactivateAllBreakpoints-666"><a href="#Simulator.deactivateAllBreakpoints-666"><span class="linenos">666</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mem</span><span class="o">.</span><span class="n">deactivateBreakpoints</span><span class="p">()</span>
</span></pre></div>


    

                            </div>
                            <div id="Simulator.reactivateAllBreakpoints" class="classattr">
                                        <input id="Simulator.reactivateAllBreakpoints-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">reactivateAllBreakpoints</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Simulator.reactivateAllBreakpoints-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Simulator.reactivateAllBreakpoints"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Simulator.reactivateAllBreakpoints-668"><a href="#Simulator.reactivateAllBreakpoints-668"><span class="linenos">668</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">reactivateAllBreakpoints</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Simulator.reactivateAllBreakpoints-669"><a href="#Simulator.reactivateAllBreakpoints-669"><span class="linenos">669</span></a>        <span class="c1"># See `deactivateAllBreakpoints`</span>
</span><span id="Simulator.reactivateAllBreakpoints-670"><a href="#Simulator.reactivateAllBreakpoints-670"><span class="linenos">670</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">regs</span><span class="o">.</span><span class="n">reactivateBreakpoints</span><span class="p">()</span>
</span><span id="Simulator.reactivateAllBreakpoints-671"><a href="#Simulator.reactivateAllBreakpoints-671"><span class="linenos">671</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mem</span><span class="o">.</span><span class="n">reactivateBreakpoints</span><span class="p">()</span>
</span></pre></div>


    

                            </div>
                            <div id="Simulator.getCurrentLine" class="classattr">
                                        <input id="Simulator.getCurrentLine-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">getCurrentLine</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Simulator.getCurrentLine-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Simulator.getCurrentLine"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Simulator.getCurrentLine-673"><a href="#Simulator.getCurrentLine-673"><span class="linenos">673</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">getCurrentLine</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Simulator.getCurrentLine-674"><a href="#Simulator.getCurrentLine-674"><span class="linenos">674</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">regs</span><span class="o">.</span><span class="n">deactivateBreakpoints</span><span class="p">()</span>
</span><span id="Simulator.getCurrentLine-675"><a href="#Simulator.getCurrentLine-675"><span class="linenos">675</span></a>        <span class="n">pc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">regs</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span>
</span><span id="Simulator.getCurrentLine-676"><a href="#Simulator.getCurrentLine-676"><span class="linenos">676</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">regs</span><span class="o">.</span><span class="n">reactivateBreakpoints</span><span class="p">()</span>
</span><span id="Simulator.getCurrentLine-677"><a href="#Simulator.getCurrentLine-677"><span class="linenos">677</span></a>        <span class="n">pc</span> <span class="o">-=</span> <span class="mi">8</span> <span class="k">if</span> <span class="n">getSetting</span><span class="p">(</span><span class="s2">&quot;PCbehavior&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;+8&quot;</span> <span class="k">else</span> <span class="mi">0</span>
</span><span id="Simulator.getCurrentLine-678"><a href="#Simulator.getCurrentLine-678"><span class="linenos">678</span></a>        <span class="k">if</span> <span class="n">pc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">addr2line</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">addr2line</span><span class="p">[</span><span class="n">pc</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Simulator.getCurrentLine-679"><a href="#Simulator.getCurrentLine-679"><span class="linenos">679</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">addr2line</span><span class="p">[</span><span class="n">pc</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Simulator.getCurrentLine-680"><a href="#Simulator.getCurrentLine-680"><span class="linenos">680</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Simulator.getCurrentLine-681"><a href="#Simulator.getCurrentLine-681"><span class="linenos">681</span></a>            <span class="k">return</span> <span class="kc">None</span>
</span></pre></div>


    

                            </div>
                </section>
    </main>
<script>
    function escapeHTML(html) {
        return document.createElement('div').appendChild(document.createTextNode(html)).parentNode.innerHTML;
    }

    const originalContent = document.querySelector("main.pdoc");
    let currentContent = originalContent;

    function setContent(innerHTML) {
        let elem;
        if (innerHTML) {
            elem = document.createElement("main");
            elem.classList.add("pdoc");
            elem.innerHTML = innerHTML;
        } else {
            elem = originalContent;
        }
        if (currentContent !== elem) {
            currentContent.replaceWith(elem);
            currentContent = elem;
        }
    }

    function getSearchTerm() {
        return (new URL(window.location)).searchParams.get("search");
    }

    const searchBox = document.querySelector(".pdoc input[type=search]");
    searchBox.addEventListener("input", function () {
        let url = new URL(window.location);
        if (searchBox.value.trim()) {
            url.hash = "";
            url.searchParams.set("search", searchBox.value);
        } else {
            url.searchParams.delete("search");
        }
        history.replaceState("", "", url.toString());
        onInput();
    });
    window.addEventListener("popstate", onInput);


    let search, searchErr;

    async function initialize() {
        try {
            search = await new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.type = "text/javascript";
                script.async = true;
                script.onload = () => resolve(window.pdocSearch);
                script.onerror = (e) => reject(e);
                script.src = "search.js";
                document.getElementsByTagName("head")[0].appendChild(script);
            });
        } catch (e) {
            console.error("Cannot fetch pdoc search index");
            searchErr = "Cannot fetch search index.";
        }
        onInput();

        document.querySelector("nav.pdoc").addEventListener("click", e => {
            if (e.target.hash) {
                searchBox.value = "";
                searchBox.dispatchEvent(new Event("input"));
            }
        });
    }

    function onInput() {
        setContent((() => {
            const term = getSearchTerm();
            if (!term) {
                return null
            }
            if (searchErr) {
                return `<h3>Error: ${searchErr}</h3>`
            }
            if (!search) {
                return "<h3>Searching...</h3>"
            }

            window.scrollTo({top: 0, left: 0, behavior: 'auto'});

            const results = search(term);

            let html;
            if (results.length === 0) {
                html = `No search results for '${escapeHTML(term)}'.`
            } else {
                html = `<h4>${results.length} search result${results.length > 1 ? "s" : ""} for '${escapeHTML(term)}'.</h4>`;
            }
            for (let result of results.slice(0, 10)) {
                let doc = result.doc;
                let url = `${doc.modulename.replaceAll(".", "/")}.html`;
                if (doc.qualname) {
                    url += `#${doc.qualname}`;
                }

                let heading;
                switch (result.doc.kind) {
                    case "function":
                        if (doc.fullname.endsWith(".__init__")) {
                            heading = `<span class="name">${doc.fullname.replace(/\.__init__$/, "")}</span>${doc.signature}`;
                        } else {
                            heading = `<span class="def">${doc.funcdef}</span> <span class="name">${doc.fullname}</span>${doc.signature}`;
                        }
                        break;
                    case "class":
                        heading = `<span class="def">class</span> <span class="name">${doc.fullname}</span>`;
                        if (doc.bases)
                            heading += `<wbr>(<span class="base">${doc.bases}</span>)`;
                        heading += `:`;
                        break;
                    case "variable":
                        heading = `<span class="name">${doc.fullname}</span>`;
                        if (doc.annotation)
                            heading += `<span class="annotation">${doc.annotation}</span>`;
                        if (doc.default_value)
                            heading += `<span class="default_value"> = ${doc.default_value}</span>`;
                        break;
                    default:
                        heading = `<span class="name">${doc.fullname}</span>`;
                        break;
                }
                html += `
                        <section class="search-result">
                        <a href="${url}" class="attr ${doc.kind}">${heading}</a>
                        <div class="docstring">${doc.doc}</div>
                        </section>
                    `;

            }
            return html;
        })());
    }

    if (getSearchTerm()) {
        initialize();
        searchBox.value = getSearchTerm();
        onInput();
    } else {
        searchBox.addEventListener("focus", initialize, {once: true});
    }

    searchBox.addEventListener("keydown", e => {
        if (["ArrowDown", "ArrowUp", "Enter"].includes(e.key)) {
            let focused = currentContent.querySelector(".search-result.focused");
            if (!focused) {
                currentContent.querySelector(".search-result").classList.add("focused");
            } else if (
                e.key === "ArrowDown"
                && focused.nextElementSibling
                && focused.nextElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.nextElementSibling.classList.add("focused");
                focused.nextElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "ArrowUp"
                && focused.previousElementSibling
                && focused.previousElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.previousElementSibling.classList.add("focused");
                focused.previousElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "Enter"
            ) {
                focused.querySelector("a").click();
            }
        }
    });
</script></body>
</html>